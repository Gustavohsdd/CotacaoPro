<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detalhes da Cotação</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
      background-color: #f4f7f6;
      overflow-x: hidden;
    }

    .cotacao-individual-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
    }

    .top-menu-bar {
      background-color: #1D4ED8;
      color: white;
      padding: 0.75rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      flex-shrink: 0;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .title-container {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      margin-right: auto;
    }

    .top-menu-bar .title {
      font-size: 1.25rem;
      font-weight: 600;
    }

    .data-abertura-info {
      font-size: 0.8rem;
      color: #e0e0e0;
      margin-top: 0.15rem;
    }

    .top-menu-bar .actions {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .top-menu-search-container {
      display: flex;
      align-items: center;
      background-color: rgba(255, 255, 255, 0.15);
      padding: 0.25rem 0.5rem;
      border-radius: 0.375rem;
      min-width: 200px;
      flex-grow: 1;
      max-width: 350px;
      margin-right: 1rem;
    }

    .top-menu-search-container input[type="text"] {
      width: 100%;
      padding: 0.4rem 0.6rem;
      border: 1px solid transparent;
      border-radius: 0.25rem;
      font-size: 0.875rem;
      background-color: transparent;
      color: white;
      box-shadow: none;
    }

    .top-menu-search-container input[type="text"]::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }

    .top-menu-search-container input[type="text"]:focus {
      outline: none;
      background-color: rgba(255, 255, 255, 0.25);
      border-color: rgba(255, 255, 255, 0.5);
    }

    .btn-menu-superior {
      font-size: 0.875rem;
      font-weight: 500;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      transition: background-color 0.15s ease-in-out;
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      color: white;
      border: 1px solid transparent;
      cursor: pointer;
    }

    .btn-menu-superior:hover {
      opacity: 0.9;
    }

    .btn-menu-salvar {
      background-color: #16a34a;
    }

    .btn-menu-salvar:hover {
      background-color: #15803d;
    }

    .btn-menu-superior svg {
      width: 1rem;
      height: 1rem;
    }

    .dropdown-menu {
      position: relative;
      display: inline-block;
    }

    .dropdown-menu-button {
      background-color: #235fc2;
    }

    .dropdown-menu-button:hover {
      background-color: #1a3561;
    }

    .dropdown-menu-content {
      display: none;
      position: absolute;
      background-color: white;
      min-width: 250px;
      box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
      z-index: 1050;
      border-radius: 0.375rem;
      right: 0;
      border: 1px solid #e2e8f0;
      margin-top: 0.25rem;
    }

    .dropdown-menu-content.show {
      display: block;
    }

    .dropdown-menu-content a {
      color: #1f2937;
      padding: 0.75rem 1rem;
      text-decoration: none;
      display: block;
      font-size: 0.875rem;
      border-bottom: 1px solid #e2e8f0;
    }

    .dropdown-menu-content a:last-child {
      border-bottom: none;
    }

    .dropdown-menu-content a:hover {
      background-color: #f4f7f6;
      color: #1D4ED8;
    }

    .dropdown-arrow {
      width: 1em;
      height: 1em;
      margin-left: 0.5rem;
      transition: transform 0.2s ease-in-out;
    }

    .dropdown-menu-button.open .dropdown-arrow {
      transform: rotate(180deg);
    }

    .main-content-area {
      flex-grow: 1;
      padding: 0.75rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .table-container,
    .retirar-produtos-container,
    .gerenciar-cotacoes-portal-container {
      flex-grow: 1;
      overflow: auto;
      border: 1px solid #e2e8f0;
      border-radius: 0.5rem;
      background-color: white;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
      padding: 0.75rem;
      margin-bottom: 1rem;
    }

    .table-container.hidden,
    .retirar-produtos-container.hidden,
    .gerenciar-cotacoes-portal-container.hidden {
      display: none !important;
    }

    .sticky-header-table {
      width: 100%;
      border-collapse: collapse;
    }

    .sticky-header-table thead th {
      position: -webkit-sticky;
      position: sticky;
      top: 0;
      background-color: #1D4ED8 !important;
      color: white !important;
      padding: 0.5rem 1rem;
      text-align: left;
      font-size: 0.65rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 2px solid #1e3a8a;
      z-index: 10;
      border-left: 1px solid #425B9A;
    }

    .sticky-header-table thead th:first-child {
      border-left: none;
      border-top-left-radius: 0.375rem;
    }

    .sticky-header-table thead th:last-child {
      border-top-right-radius: 0.375rem;
    }

    .sticky-header-table tbody td {
      padding: 0.5rem 1rem;
      border-bottom: 1px solid #e2e8f0;
      font-size: 0.775rem;
      color: #334155;
      white-space: nowrap;
      border-left: 1px solid #e2e8f0;
      cursor: default;
    }

    .sticky-header-table tbody td.editable-price-cell {
      cursor: cell;
      position: relative;
    }

    .sticky-header-table tbody td.editable-price-cell:hover::after {
      content: '✎';
      position: absolute;
      right: 5px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.7em;
      color: #666;
    }

    .sticky-header-table tbody td:first-child {
      border-left: none;
    }

    .sticky-header-table thead th:first-child,
    .sticky-header-table tbody tr td:first-child {
      position: -webkit-sticky;
      position: sticky;
      left: 0;
      z-index: 3;
    }

    .sticky-header-table tbody tr td:first-child {
      background-color: inherit;
    }

    .sticky-header-table thead th:first-child {
      z-index: 11;
    }

    .categoria-accordion-header-row td:first-child {
      background-color: #e5e7eb;
    }

    .produto-group-separator-row td:first-child {
      background-color: #add8e6;
    }

    .sticky-header-table tbody tr:hover td:first-child {
      background-color: #dbeafe !important;
    }

    .sticky-header-table tbody tr:hover td {
      background-color: #dbeafe !important;
    }

    .categoria-accordion-header-row {
      background-color: #e5e7eb;
      cursor: pointer;
      font-weight: bold;
      color: #1f2937;
    }

    .categoria-accordion-header-row:hover {
      background-color: #d1d5db;
    }

    .categoria-accordion-header-row td {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #56badb;
    }

    .categoria-header-content {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .categoria-accordion-icon {
      transition: transform 0.2s ease-in-out;
      width: 1.25rem;
      height: 1.25rem;
      color: #4b5563;
    }

    .categoria-accordion-header-row.expanded .categoria-accordion-icon {
      transform: rotate(90deg);
    }

    .category-content-row.hidden,
    .sub-produto-row.hidden-by-etapa,
    .sub-produto-row.hidden-by-search {
      display: none !important;
    }

    .produto-group-separator-row.hidden-by-search,
    .categoria-accordion-header-row.hidden-by-search {
      display: none !important;
    }

    .produto-group-separator-row td {
      background-color: #b3d0f3;
      padding: 0.6rem 1rem;
      font-weight: 600;
      color: #1e3a8a;
      border-bottom: 1px solid #6babf3;
      white-space: normal;
    }

    .produto-group-separator-row td .contagem-container-principal {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }

    .produto-group-separator-row td .produto-principal-info {
      font-weight: 600;
      margin-right: 15px;
      white-space: nowrap;
    }

    .produto-group-separator-row td .contagem-fields-container {
      display: flex;
      align-items: left;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: flex-end;
    }

    .sub-produto-row {
      background-color: #F9FAFB;
    }

    .sub-produto-row td {
      padding-left: 1.75rem;
    }

    .sticky-header-table tbody td.bg-col-amarelo {
      background-color: #ffe599 !important;
    }

    .sticky-header-table tbody td.bg-col-laranja {
      background-color: #f9cb9c !important;
    }

    .sticky-header-table tbody td.bg-col-azul-cot {
      background-color: #9fc5e8 !important;
    }

    .sticky-header-table tbody td.bg-col-verde {
      background-color: #b6d7a8 !important;
    }

    .sticky-header-table tbody td.bg-col-vermelho-leve {
      background-color: #FECACA !important;
    }

    .sticky-header-table tbody td.bg-col-roxo-leve {
      background-color: #E9D5FF !important;
    }

    .feedback-message {
      padding: 0.75rem 1.25rem;
      margin-bottom: 1rem;
      border-radius: 0.375rem;
      font-size: 0.875rem;
    }

    .feedback-message.hidden {
      display: none;
    }

    .feedback-success {
      background-color: #D1FAE5;
      color: #065F46;
      border: 1px solid #6EE7B7;
    }

    .feedback-error {
      background-color: #FEE2E2;
      color: #991B1B;
      border: 1px solid #FCA5A5;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(230, 230, 230, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .loading-overlay.hidden {
      display: none;
    }

    .loading-overlay .global-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #D1D5DB;
      border-top-color: #1D4ED8;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .info-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: #1e3a8a;
      background-color: #eef2ff;
      border-radius: 0.375rem;
      border: 1px solid #dbeafe;
      gap: 0.375rem;
    }

    .info-badge.clickable {
      cursor: pointer;
      background-color: #2563eb;
      color: white;
      border-color: #1d4ed8;
    }

    .info-badge.clickable:hover {
      background-color: #1d4ed8;
    }

    /* Outros Estilos (Modais, etc...) */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background-color: white;
      padding: 1.5rem;
      border-radius: 0.5rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 1rem;
      margin-bottom: 1rem;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: #1f2937;
    }

    .modal-close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #6b7280;
    }

    .modal-body .form-group {
      margin-bottom: 1.25rem;
    }

    .modal-body .form-group label {
      display: block;
      font-weight: 500;
      color: #374151;
      margin-bottom: 0.5rem;
    }

    .modal-body select,
    .modal-body input[type="text"],
    .modal-body input[type="number"],
    .modal-body textarea {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      box-sizing: border-box;
    }

    .modal-body .checkbox-group {
      max-height: 150px;
      overflow-y: auto;
      border: 1px solid #d1d5db;
      padding: 0.75rem;
      border-radius: 0.375rem;
      background-color: #f9fafb;
    }

    .modal-footer {
      border-top: 1px solid #e5e7eb;
      padding-top: 1rem;
      margin-top: 1.5rem;
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
    }

    .btn-painel-acao {
      font-size: 0.875rem;
      font-weight: 600;
      padding: 0.5rem 0.75rem;
      border-radius: 0.375rem;
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.375rem;
      color: white;
      min-width: 100px;
      border: none;
    }

    .btn-modal-primary {
      background-color: #2563eb;
    }

    .btn-modal-primary:hover {
      background-color: #1d4ed8;
    }

    .btn-modal-secondary {
      background-color: #e5e7eb;
      color: #374151;
      border: 1px solid #d1d5db;
    }

    .btn-modal-secondary:hover {
      background-color: #d1d5db;
    }

    .CotacoesScript_secaoOpcoesCriacao {
      display: none;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px dashed #d1d5db;
    }

    .CotacoesScript_secaoOpcoesCriacao.active {
      display: block;
    }

    .sidebar-oportunidades {
      position: fixed;
      top: 0;
      right: 0;
      width: 400px;
      max-width: 90vw;
      height: 100%;
      background-color: #1D4ED8;
      color: white;
      box-shadow: -4px 0 15px rgba(0, 0, 0, 0.2);
      z-index: 1500;
      transform: translateX(100%);
      transition: transform 0.3s ease-in-out;
      display: flex;
      flex-direction: column;
    }

    .sidebar-oportunidades.active {
      transform: translateX(0);
    }

    .sidebar-oportunidades-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1.25rem;
      background-color: #1e40af;
      flex-shrink: 0;
    }

    .sidebar-oportunidades-title {
      font-size: 1.125rem;
      font-weight: 600;
      margin: 0;
    }

    .sidebar-oportunidades-close-btn {
      background: none;
      border: none;
      color: white;
      font-size: 1.75rem;
      cursor: pointer;
      opacity: 0.8;
      padding: 0;
      line-height: 1;
    }

    .sidebar-oportunidades-close-btn:hover {
      opacity: 1;
    }

    .sidebar-oportunidades-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.25rem;
      background-color: #2563eb;
      flex-shrink: 0;
    }

    .sidebar-oportunidades-controls label {
      font-size: 0.875rem;
      font-weight: 500;
    }

    .sidebar-oportunidades-sort-btn {
      padding: 0.375rem 0.75rem;
      border: 1px solid rgba(255, 255, 255, 0.5);
      background-color: transparent;
      color: white;
      border-radius: 0.375rem;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .sidebar-oportunidades-sort-btn:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .sidebar-oportunidades-sort-btn.active {
      background-color: white;
      color: #1D4ED8;
      font-weight: 600;
    }

    .sidebar-oportunidades-lista {
      flex-grow: 1;
      overflow-y: auto;
      padding: 0.75rem;
    }

    .sidebar-oportunidades-item {
      background-color: rgba(255, 255, 255, 0.08);
      border-radius: 0.375rem;
      padding: 0.75rem 1rem;
      margin-bottom: 0.5rem;
    }

    .sidebar-oportunidades-item-produto {
      font-weight: 600;
      color: #eff6ff;
      margin-bottom: 0.375rem;
      display: block;
    }

    .sidebar-oportunidades-item-metricas {
      display: flex;
      justify-content: space-between;
      font-size: 0.875rem;
      color: #dbeafe;
    }

    .sidebar-oportunidades-item-metricas strong {
      font-weight: 600;
      color: #ffffff;
    }

    .sidebar-oportunidades-empty-state {
      text-align: center;
      padding-top: 2rem;
      color: #dbeafe;
    }

    .custom-scrollbar::-webkit-scrollbar {
      width: 8px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: #1e40af;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background-color: #60a5fa;
      border-radius: 4px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background-color: #93c5fd;
    }

    body.sidebar-active .cotacao-individual-container {
      width: calc(100% - 400px);
      transition: width 0.3s ease-in-out;
    }

    .cotacao-individual-container {
      transition: width 0.3s ease-in-out;
    }

    .view-tabs-container {
      margin-bottom: 1rem;
      border-bottom: 1px solid #d1d5db;
      /* Linha cinza para o container de abas */
    }

    .view-tab-btn {
      padding: 0.75rem 0.5rem;
      border: none;
      background-color: transparent;
      color: #374151;
      font-weight: 500;
      cursor: pointer;
      margin-bottom: -1px;
      border-bottom: 3px solid transparent;
    }

    .view-tab-btn.active {
      color: #1D4ED8;
      font-weight: 600;
      border-bottom-color: #1D4ED8;
    }

    .hidden-by-category {
      display: none;
    }

    .produto-group-separator-row td .contagem-fields-container {
      display: flex;
      align-items: center;
      flex-wrap: nowrap;
      gap: 15px;
    }

    .produto-group-separator-row td .contagem-field-block {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .produto-group-separator-row td .campo-contagem-label {
      font-weight: normal;
      color: #1f2937;
      font-size: 0.8rem;
      white-space: nowrap;
    }

    .produto-group-separator-row td .campo-contagem-valor {
      font-weight: 600;
      color: #1D4ED8;
      /* Azul */
      font-size: 0.9rem;
      background-color: #eef2ff;
      padding: 0.2rem 0.5rem;
      border-radius: 0.25rem;
    }

    .produto-group-separator-row td .campo-contagem-valor.negativo {
      color: #991B1B;
      /* Vermelho */
      background-color: #FEE2E2;
    }
  </style>
</head>

<body>
  <div class="cotacao-individual-container">
    <div class="top-menu-bar">
      <div class="title-container">
        <div class="title" id="CotacaoIndividualScript_tituloPagina">
          Cotação ID: <span id="CotacaoIndividualScript_idCotacaoExibido">Carregando...</span>
        </div>
        <div id="CotacaoIndividualScript_dataAberturaExibida" class="data-abertura-info"></div>
      </div>

      <div class="actions">
        <div class="top-menu-search-container" id="CotacaoIndividualScript_searchContainer_Top">
          <input type="text" id="CotacaoIndividualScript_searchInput_Top" placeholder="Buscar na cotação...">
        </div>

        <button id="CotacaoIndividualScript_btnRecalcularUI" class="btn-menu-superior"
          title="Forçar recálculo de totais na tela"
          style="background-color: transparent; border: 1px solid #93c5fd; margin-right: 0.5rem;">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
            style="width: 1.25rem; height: 1.25rem;">
            <path fill-rule="evenodd"
              d="M15.312 11.424a5.5 5.5 0 01-9.205 4.013l-.56-1.12a3.5 3.5 0 005.88-2.553H9.5V10h6V4h-1.5v5.576a5.525 5.525 0 01-1.688 1.848zM4.688 8.576a5.5 5.5 0 019.205-4.013l.56 1.12A3.5 3.5 0 008.57 8.233H10.5V10H4.5V4h1.5v3.576a5.525 5.525 0 011.688-1.848z"
              clip-rule="evenodd" />
          </svg>
        </button>

        <div class="dropdown-menu">
          <button id="CotacaoIndividualScript_menuEtapasBtn" class="btn-menu-superior dropdown-menu-button">Etapas <svg
              class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd"
                d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.29a.75.75 0 01.02-1.06z"
                clip-rule="evenodd" />
            </svg></button>
          <div id="CotacaoIndividualScript_menuEtapasDropdown" class="dropdown-menu-content">
            <a href="#" data-action="etapa_contagem_estoque">1. Contagem de Estoque</a>
            <a href="#" data-action="etapa_retirar_produtos">2. Retirar Produtos Desnecessários</a>
            <a href="#" data-action="etapa_enviar_fornecedores">3. Enviar para Fornecedores</a>
            <a href="#" data-action="etapa_realizar_cotacao">4. Realizar Cotação</a>
            <a href="#" data-action="etapa_definir_empresa">5. Definir Empresa para Faturamento</a>
            <a href="#" data-action="etapa_definir_condicoes_pagamento">6. Definir Condições de Pagamento</a>
            <a href="#" data-action="etapa_imprimir_pedidos">7. Imprimir Pedidos</a>
          </div>
        </div>
        <div class="dropdown-menu">
          <button id="CotacaoIndividualScript_menuRelatoriosBtn"
            class="btn-menu-superior dropdown-menu-button">Relatórios <svg class="dropdown-arrow"
              xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd"
                d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.29a.75.75 0 01.02-1.06z"
                clip-rule="evenodd" />
            </svg></button>
          <div id="CotacaoIndividualScript_menuRelatoriosDropdown" class="dropdown-menu-content">
            <a href="#" data-action="relatorio_analise_compra">Análise de Compra</a>
          </div>
        </div>
        <div class="dropdown-menu">
          <button id="CotacaoIndividualScript_menuFuncoesBtn" class="btn-menu-superior dropdown-menu-button">Funções
            <svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd"
                d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.29a.75.75 0 01.02-1.06z"
                clip-rule="evenodd" />
            </svg></button>
          <div id="CotacaoIndividualScript_menuFuncoesDropdown" class="dropdown-menu-content">
            <a href="#" data-action="funcao_acrescentar_itens">Acrescentar Itens</a>
            <a href="#" data-action="funcao_melhores_oportunidades">Melhores Oportunidades</a>
            <a href="#" data-action="funcao_preencher_precos">Preencher com Últimos Preços</a>
          </div>
        </div>
      </div>
    </div>

    <div class="main-content-area">
      <div class="view-tabs-container">
        <button id="CotacaoIndividualScript_btnAbaCategoria" class="view-tab-btn active">Visualizar por
          Categoria</button>
      </div>
      <div id="CotacaoIndividualScript_mensagemFeedback" class="feedback-message hidden"></div>
      <div class="table-container" id="CotacaoIndividualScript_tableContainer">
        <table class="sticky-header-table" id="CotacaoIndividualScript_tabelaProdutosCotacao">
          <thead>
            <tr>
              <th>Carregando Cabeçalhos...</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td id="CotacaoIndividualScript_tabelaLoadingMsg" colspan="1" class="text-center p-8 text-gray-500">
                <div class="flex justify-center items-center">
                  <svg class="custom-spinner" viewBox="0 0 50 50" style="width: 32px; height: 32px;">
                    <circle cx="25" cy="25" r="20" fill="none" stroke="#D1D5DB" stroke-width="5"></circle>
                    <circle cx="25" cy="25" r="20" fill="none" stroke="#1D4ED8" stroke-width="5" stroke-linecap="round"
                      stroke-dasharray="31.41592653589793, 125.66370614359172" stroke-dashoffset="0">
                      <animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s"
                        values="0 25 25;360 25 25" keyTimes="0;1"></animateTransform>
                    </circle>
                  </svg>
                  <span class="ml-3 text-gray-700">Carregando dados da cotação...</span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div id="CotacaoIndividualScript_pageLoadingOverlay" class="loading-overlay hidden">
      <div style="display: flex; flex-direction: column; align-items: center;">
        <div class="global-spinner"></div>
        <span class="mt-3 text-blue-700 font-semibold text-lg loading-message-text">Processando...</span>
      </div>
    </div>
  </div>

  <div id="CotacaoIndividualScript_modalAcrescentarItensOverlay" class="modal-overlay">
  </div>

  <div id="CotacaoIndividualScript_modalNegociacaoOverlay" class="modal-overlay">
    <div class="modal-content custom-scrollbar" role="dialog" aria-modal="true"
      aria-labelledby="CotacaoIndividualScript_modalNegociacao_titulo">
      <div class="modal-header">
        <h3 id="CotacaoIndividualScript_modalNegociacao_titulo" class="modal-title">Negociação</h3>
        <button id="CotacaoIndividualScript_btnFecharModalNegociacao" class="modal-close-btn"
          aria-label="Fechar">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="CotacaoIndividualScript_selectSubproduto">Subproduto base (normalmente o menor preço)</label>
          <select id="CotacaoIndividualScript_selectSubproduto"></select>
          <div id="CotacaoIndividualScript_infoSubproduto" style="margin-top:6px;color:#6b7280;font-size:0.85rem;">
          </div>
        </div>
        <div class="form-group" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div>
            <label for="CotacaoIndividualScript_inputPercentual">Desconto sobre o preço base (%)</label>
            <input id="CotacaoIndividualScript_inputPercentual" type="number" step="0.01" min="0" value="2">
          </div>
          <div>
            <label for="CotacaoIndividualScript_inputPrecoNovo">Novo preço (automático)</label>
            <input id="CotacaoIndividualScript_inputPrecoNovo" type="text" readonly>
          </div>
        </div>
        <div class="form-group">
          <label for="CotacaoIndividualScript_textareaMensagem">Mensagem para enviar aos fornecedores</label>
          <textarea id="CotacaoIndividualScript_textareaMensagem" rows="5"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button id="CotacaoIndividualScript_btnCancelarModalNegociacao"
          class="btn-painel-acao btn-modal-secondary">Cancelar</button>
        <button id="CotacaoIndividualScript_btnCopiarTextoNegociacao" class="btn-painel-acao btn-modal-primary">Copiar
          Texto</button>
      </div>
    </div>
  </div>

  <div id="FuncoesScript_sidebarOportunidades" class="sidebar-oportunidades">
  </div>

  <div id="CotacaoIndividualScript_modalNegociacaoOverlay" class="modal-overlay">
    <div class="modal-content custom-scrollbar" role="dialog" aria-modal="true"
      aria-labelledby="CotacaoIndividualScript_modalNegociacao_titulo">
      <div class="modal-header">
        <h3 id="CotacaoIndividualScript_modalNegociacao_titulo" class="modal-title">Negociação</h3>
        <button id="CotacaoIndividualScript_btnFecharModalNegociacao" class="modal-close-btn"
          aria-label="Fechar">&times;</button>
      </div>

      <div class="modal-body">
        <div class="form-group">
          <label for="CotacaoIndividualScript_selectSubproduto">Subproduto base (normalmente o menor preço)</label>
          <select id="CotacaoIndividualScript_selectSubproduto"></select>
          <div id="CotacaoIndividualScript_infoSubproduto" style="margin-top:6px;color:#6b7280;font-size:0.85rem;">
          </div>
        </div>

        <div class="form-group" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div>
            <label for="CotacaoIndividualScript_inputPercentual">Desconto sobre o preço base (%)</label>
            <input id="CotacaoIndividualScript_inputPercentual" type="number" step="0.01" min="0" value="2">
          </div>
          <div>
            <label for="CotacaoIndividualScript_inputPrecoNovo">Novo preço (automático)</label>
            <input id="CotacaoIndividualScript_inputPrecoNovo" type="text" readonly>
          </div>
        </div>

        <div class="form-group">
          <label for="CotacaoIndividualScript_textareaMensagem">Mensagem para enviar aos fornecedores</label>
          <textarea id="CotacaoIndividualScript_textareaMensagem" rows="5"></textarea>
        </div>
      </div>

      <div class="modal-footer">
        <button id="CotacaoIndividualScript_btnCancelarModalNegociacao"
          class="btn-painel-acao btn-modal-secondary">Cancelar</button>
        <button id="CotacaoIndividualScript_btnCopiarTextoNegociacao" class="btn-painel-acao btn-modal-primary">Copiar
          Texto</button>
      </div>
    </div>
  </div>


  <div id="EtapasScript_modalContagemEstoqueOverlay" class="modal-overlay">
    <div class="modal-content custom-scrollbar" style="max-width: 90vw; width: 1200px;">
      <div class="modal-header">
        <h3 class="modal-title">Etapa 1: Contagem de Estoque</h3>
        <button id="EtapasScript_btnFecharModalContagemEstoque" class="modal-close-btn"
          aria-label="Fechar">&times;</button>
      </div>
      <div id="EtapasScript_feedbackModalContagem" class="mb-4"></div>
      <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
        <table class="sticky-header-table" id="EtapasScript_tabelaContagemEstoque">
          <thead>
            <tr>
              <th>Produto Principal</th>
              <th>Estoque Mínimo</th>
              <th>Estoque Contado</th>
              <th>Comprar (Sugestão)</th>
            </tr>
          </thead>
          <tbody id="EtapasScript_tbodyModalContagemEstoque">
          </tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button id="EtapasScript_btnCancelarModalContagem" class="btn-painel-acao btn-modal-secondary">Cancelar</button>
        <button id="EtapasScript_btnSalvarModalContagem" class="btn-painel-acao btn-modal-primary">Salvar
          Contagem</button>
      </div>
    </div>
  </div>

  <div id="EtapasScript_modalRetirarProdutosOverlay" class="modal-overlay">
    <div class="modal-content custom-scrollbar" style="max-width: 800px;">
      <div class="modal-header">
        <h3 class="modal-title">Etapa 2: Retirar Produtos Desnecessários</h3>
        <button id="EtapasScript_btnFecharModalRetirarProdutos" class="modal-close-btn">&times;</button>
      </div>
      <div class="modal-body" id="EtapasScript_corpoModalRetirarProdutos">
      </div>
      <div id="EtapasScript_feedbackModalRetirarProdutos" class="m-4"></div>
      <div class="modal-footer">
        <button id="EtapasScript_btnCancelarModalRetirarProdutos"
          class="btn-painel-acao btn-modal-secondary">Cancelar</button>
        <button id="EtapasScript_btnConfirmarRemocaoModal" class="btn-painel-acao btn-modal-primary"
          style="background-color: #ef4444;">Confirmar Remoção</button>
      </div>
    </div>
  </div>

  <div id="EtapasScript_realizarCotacaoContainer" class="retirar-produtos-container hidden">
    <h3 class="text-xl font-semibold text-gray-800 mb-4">Etapa 4: Realizar Cotação</h3>
    <div id="EtapasScript_listaSubprodutosSemPreco" class="space-y-3">
    </div>
    <div class="mt-6 flex justify-end gap-3">
      <button id="EtapasScript_btnCancelarRetiradaSemPreco" class="btn-painel-acao btn-modal-secondary">Voltar para
        Edição</button>
      <button id="EtapasScript_btnConfirmarRetiradaSemPreco" class="btn-painel-acao btn-modal-primary">Retirar
        Selecionados e Iniciar Edição</button>
    </div>
  </div>

  <div id="EtapasScript_modalDefinirEmpresaOverlay" class="modal-overlay">
    <div class="modal-content custom-scrollbar" style="max-width: 95vw; width: 1400px;">
      <div class="modal-header">
        <h3 class="modal-title">Etapa 5: Definir Empresa para Faturamento</h3>
        <button id="EtapasScript_btnFecharModalDefinirEmpresa" class="modal-close-btn">&times;</button>
      </div>
      <div id="EtapasScript_feedbackModalDefinirEmpresa" class="m-4"></div>
      <div class="modal-body" id="EtapasScript_corpoModalDefinirEmpresa" style="max-height: 75vh; overflow-y: auto;">
      </div>
      <div class="modal-footer">
        <button id="EtapasScript_btnCancelarModalDefinirEmpresa"
          class="btn-painel-acao btn-modal-secondary">Cancelar</button>
        <button id="EtapasScript_btnSalvarFaturamento" class="btn-painel-acao btn-modal-primary">Salvar e
          Fechar</button>
      </div>
    </div>
  </div>

  <div id="EtapasScript_modalCondicoesPagamentoOverlay" class="modal-overlay">
    <div class="modal-content custom-scrollbar" style="max-width: 800px;">
      <div class="modal-header">
        <h3 class="modal-title">Etapa 6: Definir Condições de Pagamento</h3>
        <button id="EtapasScript_btnFecharModalCondicoes" class="modal-close-btn">&times;</button>
      </div>
      <div id="EtapasScript_feedbackModalCondicoes" class="m-4"></div>
      <div class="modal-body" id="EtapasScript_corpoModalCondicoes">
        <p>Carregando dados...</p>
      </div>
      <div class="modal-footer">
        <button id="EtapasScript_btnCancelarModalCondicoes"
          class="btn-painel-acao btn-modal-secondary">Cancelar</button>
        <button id="EtapasScript_btnSalvarModalCondicoes" class="btn-painel-acao btn-modal-primary">Salvar
          Condições</button>
      </div>
    </div>
  </div>

  <script>
    (function initCotacaoIndividualScript() {
      //####################################################################################################
      // MÓDULO: COTACAO INDIVIDUAL (CLIENT-SIDE)
      //####################################################################################################

      //----------------------------------------------------------------------------------------------------
      // DECLARAÇÕES GLOBAIS
      //----------------------------------------------------------------------------------------------------
      const CotacaoIndividualScript_ID_SEARCH_INPUT_TOP = 'CotacaoIndividualScript_searchInput_Top';
      const CotacaoIndividualScript_ID_COTACAO_EXIBIDO = 'CotacaoIndividualScript_idCotacaoExibido';
      const CotacaoIndividualScript_ID_DATA_ABERTURA_EXIBIDA = 'CotacaoIndividualScript_dataAberturaExibida';
      const CotacaoIndividualScript_ID_MENSAGEM_FEEDBACK = 'CotacaoIndividualScript_mensagemFeedback';
      const CotacaoIndividualScript_ID_TABELA_PRODUTOS_COTACAO = 'CotacaoIndividualScript_tabelaProdutosCotacao';
      const CotacaoIndividualScript_ID_PAGE_LOADING_OVERLAY = 'CotacaoIndividualScript_pageLoadingOverlay';

      let CotacaoIndividualScript_cotacaoIdAtual = null;
      let CotacaoIndividualScript_cabecalhosVisiveis = [];
      let CotacaoIndividualScript_dadosOriginaisCotacao = [];
      let CotacaoIndividualScript_modoEtapaAtual = null;

      const CotacaoIndividualScript_COLUNAS_A_EXIBIR_PADRAO = [
        "SubProduto", "Fornecedor", "Tamanho", "UN", "Fator",
        "Preço", "Preço por Fator", "Comprar", "Valor Total"
      ];

      const EtapasScript_COLUNAS_A_EXIBIR_FATURAMENTO = [
        "SubProduto", "Preço", "Comprar", "Valor Total", "Empresa Faturada"
      ];

      const CotacaoIndividualScript_MAPA_CORES_COLUNAS = {
        "SubProduto": "bg-col-amarelo", "Categoria": "bg-col-amarelo", "Fornecedor": "bg-col-amarelo",
        "Tamanho": "bg-col-laranja", "UN": "bg-col-laranja", "Fator": "bg-col-laranja",
        "Preço": "bg-col-azul-cot", "Preço por Fator": "bg-col-azul-cot",
        "Comprar": "bg-col-verde", "Valor Total": "bg-col-verde", "Economia em Cotação": "bg-col-verde",
        "Empresa Faturada": "bg-col-roxo-leve", "Condição de Pagamento": "bg-col-roxo-leve"
      };

      /**
       * Função central para fazer chamadas à API do Firebase Functions.
       */
      async function cotacaoindividual_callApi(endpoint, method = 'POST', body = null) {
        try {
          const options = {
            method,
            headers: { 'Content-Type': 'application/json' },
          };
          if (body) {
            options.body = JSON.stringify(body);
          }
          const response = await fetch(`/api/${endpoint}`, options);
          if (!response.ok) {
            const errorData = await response.json().catch(() => ({ message: response.statusText }));
            throw new Error(errorData.message || 'Erro de comunicação com o servidor.');
          }
          if (response.status === 204) {
            return { success: true };
          }
          return await response.json();
        } catch (error) {
          console.error(`Erro na API [${endpoint}]:`, error);
          return { success: false, message: error.message };
        }
      }

      //----------------------------------------------------------------------------------------------------
      // FUNÇÕES UTILITÁRIAS
      //----------------------------------------------------------------------------------------------------
      function cotacaoindividual_parseNumeroPtBr(valor) {
        if (valor === null || valor === undefined) return NaN;
        if (typeof valor === 'number') return Number(valor);

        const s = String(valor).trim();
        if (!s) return NaN;

        // LINHA ADICIONADA: Remove todos os caracteres que não são dígitos, vírgulas ou pontos.
        // Isso limpa "R$", espaços extras e outros símbolos monetários.
        const stringLimpa = s.replace(/[^\d,.-]/g, '');

        const normalizado = stringLimpa
          .replace(/\s+/g, '')                      // Remove espaços (segunda garantia)
          .replace(/\.(?=\d{3}(?:,|$))/g, '')      // Remove o ponto de milhar
          .replace(',', '.');                       // Troca a vírgula decimal por ponto

        const n = Number(normalizado);
        return Number.isFinite(n) ? n : NaN;
      }

      function cotacaoindividual_formatarPreco(n) {
        const v = Number(n || 0);
        return v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }

      function cotacaoindividual_mostrarLoadingOverlay(mostrar = true, mensagem = "Processando...") {
        const overlay = document.getElementById(CotacaoIndividualScript_ID_PAGE_LOADING_OVERLAY);
        if (overlay) {
          overlay.classList.toggle('hidden', !mostrar);
          const msgElement = overlay.querySelector('.loading-message-text');
          if (msgElement) msgElement.textContent = mensagem;
        }
      }

      function cotacaoindividual_exibirFeedback(mensagem, isError = false, duracao = 5000) {
        const feedbackDiv = document.getElementById(CotacaoIndividualScript_ID_MENSAGEM_FEEDBACK);
        if (feedbackDiv) {
          feedbackDiv.textContent = mensagem;
          feedbackDiv.className = `feedback-message ${isError ? 'feedback-error' : 'feedback-success'}`;
          feedbackDiv.classList.remove('hidden');
          if (duracao > 0) {
            setTimeout(() => {
              if (feedbackDiv.textContent === mensagem) {
                feedbackDiv.classList.add('hidden');
                feedbackDiv.textContent = '';
              }
            }, duracao);
          }
        }
      }

      function cotacaoindividual_transformarCelulaEmInput(event) {
        const td = event.currentTarget;
        if (td.querySelector('input')) return;
        const valorOriginal = td.dataset.valorOriginal || '';
        const coluna = td.dataset.coluna;
        const tipoInput = ["Fator", "Preço", "Comprar"].includes(coluna) ? 'number' : 'text';
        td.innerHTML = `<input type="${tipoInput}" step="any" class="inline-edit-input" value="${valorOriginal.replace(/\./g, '').replace(',', '.')}" style="width: 95%; box-sizing: border-box; font-size: inherit; font-family: inherit; border: 1px solid #1D4ED8; border-radius: 3px;" />`;
        const input = td.querySelector('input');
        input.focus();
        input.select();

        const salvar = () => cotacaoindividual_salvarEdicaoInline(input);

        input.addEventListener('blur', salvar);

        input.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            input.removeEventListener('blur', salvar);
            const tdCell = input.parentElement;
            tdCell.textContent = tdCell.dataset.valorOriginal || '';
          } else if (e.key === 'Enter') {
            e.preventDefault(); // Impede o comportamento padrão do Enter

            const isComprarColumn = td.dataset.coluna === 'Comprar';

            // Aciona o salvamento da célula atual ao remover o foco
            input.blur();

            // Se a coluna for "Comprar", navega para a próxima
            if (isComprarColumn) {
              // Adiciona um pequeno atraso para garantir que o evento 'blur' e o salvamento sejam processados
              setTimeout(() => {
                const currentRow = td.closest('tr');
                const tbody = currentRow.closest('tbody');

                // Pega todas as linhas de subproduto que estão visíveis na tela
                const allVisibleRows = Array.from(
                  tbody.querySelectorAll('tr.sub-produto-row')
                ).filter(row => row.offsetParent !== null); // 'offsetParent' é uma forma segura de verificar a visibilidade

                const currentIndex = allVisibleRows.findIndex(row => row === currentRow);

                // Verifica se existe uma próxima linha
                if (currentIndex !== -1 && currentIndex < allVisibleRows.length - 1) {
                  const nextRow = allVisibleRows[currentIndex + 1];
                  const nextComprarCell = nextRow.querySelector('td[data-coluna="Comprar"]');

                  if (nextComprarCell) {
                    // Clica na próxima célula para ativar o modo de edição
                    nextComprarCell.click();
                  }
                }
              }, 50); // 50ms de atraso
            }
          }
        });
      }

      function cotacaoindividual_transformarCelulaEmInput(event) {
        const td = event.currentTarget;
        if (td.querySelector('input')) return;
        const valorOriginal = td.dataset.valorOriginal || '';
        const coluna = td.dataset.coluna;
        const tipoInput = ["Fator", "Preço", "Comprar"].includes(coluna) ? 'number' : 'text';
        td.innerHTML = `<input type="${tipoInput}" step="any" class="inline-edit-input" value="${valorOriginal.replace(/\./g, '').replace(',', '.')}" style="width: 95%; box-sizing: border-box; font-size: inherit; font-family: inherit; border: 1px solid #1D4ED8; border-radius: 3px;" />`;
        const input = td.querySelector('input');
        input.focus();
        input.select();

        const salvar = () => cotacaoindividual_salvarEdicaoInline(input);

        input.addEventListener('blur', salvar);

        input.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            input.removeEventListener('blur', salvar);
            const tdCell = input.parentElement;
            tdCell.textContent = tdCell.dataset.valorOriginal || '';
          } else if (e.key === 'Enter') {
            e.preventDefault(); // Impede o comportamento padrão do Enter

            const isComprarColumn = td.dataset.coluna === 'Comprar';

            // Aciona o salvamento da célula atual ao remover o foco
            input.blur();

            // Se a coluna for "Comprar", navega para a próxima
            if (isComprarColumn) {
              // Adiciona um pequeno atraso para garantir que o evento 'blur' e o salvamento sejam processados
              setTimeout(() => {
                const currentRow = td.closest('tr');
                const tbody = currentRow.closest('tbody');

                // Pega todas as linhas de subproduto que estão visíveis na tela
                const allVisibleRows = Array.from(
                  tbody.querySelectorAll('tr.sub-produto-row')
                ).filter(row => row.offsetParent !== null); // 'offsetParent' é uma forma segura de verificar a visibilidade

                const currentIndex = allVisibleRows.findIndex(row => row === currentRow);

                // Verifica se existe uma próxima linha
                if (currentIndex !== -1 && currentIndex < allVisibleRows.length - 1) {
                  const nextRow = allVisibleRows[currentIndex + 1];
                  const nextComprarCell = nextRow.querySelector('td[data-coluna="Comprar"]');

                  if (nextComprarCell) {
                    // Clica na próxima célula para ativar o modo de edição
                    nextComprarCell.click();
                  }
                }
              }, 50); // 50ms de atraso
            }
          }
        });
      }


      // ########## COLE A NOVA FUNÇÃO AQUI ##########
      /**
       * Vincula os eventos de clique para todos os menus dropdown da página.
       * Também fecha os menus se o usuário clicar fora deles.
       */
      function cotacaoindividual_vincularDropdowns() {
        const dropdownButtons = document.querySelectorAll('.dropdown-menu-button');

        dropdownButtons.forEach(button => {
          button.addEventListener('click', function (event) {
            event.stopPropagation();
            const content = this.nextElementSibling;
            const isShown = content.classList.contains('show');

            // Fecha todos os outros dropdowns abertos
            document.querySelectorAll('.dropdown-menu-content.show').forEach(openContent => {
              if (openContent !== content) {
                openContent.classList.remove('show');
                openContent.previousElementSibling.classList.remove('open');
              }
            });

            // Alterna o estado do dropdown atual
            content.classList.toggle('show', !isShown);
            this.classList.toggle('open', !isShown);
          });
        });

        // Fecha os dropdowns se clicar em qualquer outro lugar da página
        window.addEventListener('click', function (event) {
          if (!event.target.matches('.dropdown-menu-button')) {
            document.querySelectorAll('.dropdown-menu-content.show').forEach(openContent => {
              openContent.classList.remove('show');
              openContent.previousElementSibling.classList.remove('open');
            });
          }
        });
      }


      //----------------------------------------------------------------------------------------------------
      // LÓGICA DE EDIÇÃO INLINE, CÁLCULOS E RENDERIZAÇÃO
      //----------------------------------------------------------------------------------------------------

      async function cotacaoindividual_salvarEdicaoInline(element) {
        const td = element.parentElement;
        let novoValorStr = element.value;
        const valorOriginalStr = td.dataset.valorOriginal || '';
        const coluna = td.dataset.coluna;
        const camposNumericos = ["Fator", "Preço", "Comprar"];

        if (camposNumericos.includes(coluna)) {
          novoValorStr = String(novoValorStr).replace(',', '.');
        }

        const valorOriginalComparacao = String(valorOriginalStr).replace(/\./g, '').replace(',', '.');

        // Atualiza a UI imediatamente para o usuário
        let valorDisplay = novoValorStr;
        const num = cotacaoindividual_parseNumeroPtBr(novoValorStr);
        if (camposNumericos.includes(coluna) && !isNaN(num)) {
          const fractionDigits = { 'Preço': 2, 'Comprar': 2, 'Fator': 4 };
          valorDisplay = num.toLocaleString('pt-BR', {
            minimumFractionDigits: fractionDigits[coluna] || 2,
            maximumFractionDigits: fractionDigits[coluna] || 4,
          });
        }
        td.textContent = valorDisplay;
        td.dataset.valorOriginal = valorDisplay;

        // Dispara o recálculo local
        if (["Fator", "Preço", "Comprar"].includes(coluna)) {
          cotacaoindividual_atualizarGrupoDeCalculosCliente(td.closest('tr'));
        }

        // Se o valor não mudou, não faz a chamada de API
        if (novoValorStr === valorOriginalComparacao) {
          return;
        }

        const tr = td.closest('tr');
        const identificadores = {
          Produto: tr.dataset.produto,
          SubProdutoChave: tr.dataset.subprodutoOriginalPersistido,
          Fornecedor: tr.dataset.fornecedor
        };

        const response = await cotacaoindividual_callApi('cotacaoindividual/salvar-celula', 'POST', {
          idCotacao: CotacaoIndividualScript_cotacaoIdAtual,
          identificadoresLinha: identificadores,
          colunaAlterada: coluna,
          novoValor: novoValorStr
        });

        if (response && response.success) {
          console.log(`Salvo no servidor: ${coluna} = ${novoValorStr}`);
          // Se o nome do SubProduto mudou, atualiza o dataset para futuras edições
          if (response.novoSubProdutoNomeSeAlterado) {
            tr.dataset.subprodutoOriginalPersistido = response.novoSubProdutoNomeSeAlterado;
          }
        } else {
          cotacaoindividual_exibirFeedback(response.message || 'Falha ao salvar.', true);
          td.textContent = valorOriginalStr; // Reverte para o valor original em caso de erro
          td.dataset.valorOriginal = valorOriginalStr;
          cotacaoindividual_atualizarGrupoDeCalculosCliente(tr); // Recalcula com o valor revertido
        }
      }

      function cotacaoindividual_atualizarGrupoDeCalculosCliente(trEditadaOuHeader) {
        const isHeader = trEditadaOuHeader.classList.contains('produto-group-separator-row');
        const nomeProdutoPrincipal = isHeader ? trEditadaOuHeader.dataset.produtoNome : trEditadaOuHeader.dataset.produto;

        if (!nomeProdutoPrincipal) return;

        const tbody = trEditadaOuHeader.closest('tbody');
        const todasLinhasDoGrupo = tbody.querySelectorAll(`tr.sub-produto-row[data-produto="${nomeProdutoPrincipal}"]`);
        const headerRow = tbody.querySelector(`tr.produto-group-separator-row[data-produto-nome="${nomeProdutoPrincipal}"]`);

        if (!headerRow) return;

        const lerValorDaLinha = (tr, coluna) => {
          const cell = tr.querySelector(`td[data-coluna="${coluna}"]`);
          const valorTexto = cell ? (cell.querySelector('input')?.value || cell.dataset.valorOriginal || cell.textContent || '0') : '0';
          return cotacaoindividual_parseNumeroPtBr(valorTexto);
        };

        const escreverValorNaLinha = (tr, coluna, valor, casasDecimais = 2) => {
          const cell = tr.querySelector(`td[data-coluna="${coluna}"]`);
          if (cell) {
            const valorFormatado = valor.toLocaleString('pt-BR', {
              minimumFractionDigits: casasDecimais,
              maximumFractionDigits: casasDecimais
            });
            cell.textContent = valorFormatado;
            cell.dataset.valorOriginal = valorFormatado;
          }
        };

        let totalComprar = 0;
        todasLinhasDoGrupo.forEach(tr => {
          const preco = lerValorDaLinha(tr, "Preço");
          const fator = lerValorDaLinha(tr, "Fator");
          const comprar = lerValorDaLinha(tr, "Comprar");
          totalComprar += comprar;

          const precoPorFator = fator > 0 ? (preco / fator) : 0;
          escreverValorNaLinha(tr, "Preço por Fator", precoPorFator, 4);

          const valorTotal = preco * comprar;
          escreverValorNaLinha(tr, "Valor Total", valorTotal, 2);
        });

        // Atualizar o cabeçalho
        const grupoOriginal = CotacaoIndividualScript_dadosOriginaisCotacao.find(g => g.Produto === nomeProdutoPrincipal);
        if (grupoOriginal) {
          const estoqueAtual = grupoOriginal.estoqueAtualProdutoPrincipal || 0;
          const saldoEstoque = estoqueAtual - totalComprar;

          const saldoSpan = headerRow.querySelector('[data-role="saldo-estoque"]');
          if (saldoSpan) {
            saldoSpan.textContent = `${estoqueAtual.toFixed(2)} / ${totalComprar.toFixed(2)}`;
            saldoSpan.classList.toggle('negativo', saldoEstoque < 0);
          }
        }

        // Recalcular e atualizar métricas de negociação no cabeçalho
        const precosPorFator = Array.from(todasLinhasDoGrupo).map(tr => lerValorDaLinha(tr, 'Preço por Fator')).filter(p => p > 0).sort((a, b) => a - b);
        const demandaMedia = grupoOriginal ? (cotacaoindividual_parseNumeroPtBr(grupoOriginal.demandaMediaProdutoPrincipal) || 0) : 0;

        let oportunidadeReais = 0;
        let spreadPercent = 0;

        if (precosPorFator.length >= 2) {
          const p1 = precosPorFator[0];
          const p2 = precosPorFator[1];
          const mid = Math.floor(precosPorFator.length / 2);
          const pMediana = precosPorFator.length % 2 === 0 ? (precosPorFator[mid - 1] + precosPorFator[mid]) / 2 : precosPorFator[mid];

          if (demandaMedia > 0 && pMediana > p1) {
            oportunidadeReais = (pMediana - p1) * demandaMedia;
          }
          spreadPercent = ((p2 - p1) / p1) * 100;
        }

        const metricasSpan = headerRow.querySelector('[data-role="metricas-negociacao"]');
        if (metricasSpan) {
          const oportunidadeFormatada = cotacaoindividual_formatarPreco(oportunidadeReais);
          const spreadFormatado = spreadPercent.toFixed(2) + '%';
          metricasSpan.textContent = `Oportunidade: ${oportunidadeFormatada} | Spread: ${spreadFormatado}`;
        }
      }


      function cotacaoindividual_renderizarCabecalhoTabela() {
        const tabela = document.getElementById(CotacaoIndividualScript_ID_TABELA_PRODUTOS_COTACAO);
        if (!tabela) return;
        const thead = tabela.querySelector('thead');
        thead.innerHTML = '';

        const tr = thead.insertRow();
        CotacaoIndividualScript_cabecalhosVisiveis.forEach(textoCabecalho => {
          const th = document.createElement('th');
          th.textContent = textoCabecalho;
          tr.appendChild(th);
        });
      }

      function cotacaoindividual_renderizarGruposDeProdutos(dadosAgrupados) {
        const tabela = document.getElementById(CotacaoIndividualScript_ID_TABELA_PRODUTOS_COTACAO);
        if (!tabela) return;
        const tbody = tabela.querySelector('tbody');
        tbody.innerHTML = '';

        if (!dadosAgrupados || dadosAgrupados.length === 0) {
          const tr = tbody.insertRow();
          const td = tr.insertCell();
          td.colSpan = CotacaoIndividualScript_cabecalhosVisiveis.length || 1;
          td.className = 'text-center p-8 text-gray-500';
          td.textContent = 'Nenhum produto para esta cotação.';
          return;
        }

        const agrupadoPorCategoria = dadosAgrupados.reduce((acc, produto) => {
          const categoria = (produto.itens && produto.itens[0]?.Categoria) ? produto.itens[0].Categoria : 'Sem Categoria';
          if (!acc[categoria]) {
            acc[categoria] = [];
          }
          acc[categoria].push(produto);
          return acc;
        }, {});

        const categoriasOrdenadas = Object.keys(agrupadoPorCategoria).sort();

        categoriasOrdenadas.forEach(nomeCategoria => {
          const categoriaRow = tbody.insertRow();
          categoriaRow.className = 'categoria-accordion-header-row expanded';
          const categoriaCell = categoriaRow.insertCell();
          categoriaCell.colSpan = CotacaoIndividualScript_cabecalhosVisiveis.length;
          categoriaCell.innerHTML = `
                    <div class="categoria-header-content">
                        <svg class="categoria-accordion-icon" style="transform: rotate(90deg);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        <span>${nomeCategoria}</span>
                    </div>
                `;

          const contentRows = [];

          agrupadoPorCategoria[nomeCategoria].forEach(grupoProduto => {
            const produtoRow = tbody.insertRow();
            produtoRow.className = 'produto-group-separator-row';
            produtoRow.dataset.produtoNome = grupoProduto.Produto; // Adiciona para referência
            const produtoCell = produtoRow.insertCell();
            produtoCell.colSpan = CotacaoIndividualScript_cabecalhosVisiveis.length;

            const wrap = document.createElement('div');
            wrap.className = 'contagem-container-principal';

            const info = document.createElement('div');
            info.className = 'produto-principal-info';
            info.textContent = grupoProduto.Produto;

            const actions = document.createElement('div');
            actions.className = 'contagem-fields-container';

            const estMinimo = grupoProduto.estoqueMinimoProdutoPrincipal !== null ? parseFloat(grupoProduto.estoqueMinimoProdutoPrincipal).toFixed(2) : 'N/A';
            const demandaMedia = grupoProduto.demandaMediaProdutoPrincipal !== null ? parseFloat(grupoProduto.demandaMediaProdutoPrincipal).toFixed(2) : 'N/A';

            let totalComprar = 0;
            grupoProduto.itens.forEach(item => {
              const comprarValor = cotacaoindividual_parseNumeroPtBr(item.Comprar);
              if (!isNaN(comprarValor)) {
                totalComprar += comprarValor;
              }
            });

            const estoqueAtual = grupoProduto.estoqueAtualProdutoPrincipal !== null ? parseFloat(grupoProduto.estoqueAtualProdutoPrincipal) : 0;
            const saldoEstoque = estoqueAtual - totalComprar;

            actions.innerHTML = `
                <div class="contagem-field-block">
                    <span class="campo-contagem-label">Est. Mínimo:</span>
                    <span class="campo-contagem-valor">${estMinimo}</span>
                </div>
                <div class="contagem-field-block">
                    <span class="campo-contagem-label">Demanda Média:</span>
                    <span class="campo-contagem-valor">${demandaMedia}</span>
                </div>
                <div class="contagem-field-block">
                    <span class="campo-contagem-label">Est. Atual / Comprar:</span>
                    <span class="campo-contagem-valor ${saldoEstoque < 0 ? 'negativo' : ''}" data-role="saldo-estoque">${estoqueAtual.toFixed(2)} / ${totalComprar.toFixed(2)}</span>
                </div>
            `;

            const btnNeg = document.createElement('button');
            btnNeg.className = 'info-badge clickable negociacao-btn';
            btnNeg.dataset.produtoNome = grupoProduto.Produto;
            btnNeg.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M12 3a9 9 0 100 18 9 9 0 000-18zm1 5h2v8h-2V8zm-4 0h2v8H9V8z"/></svg><span>Negociação</span>`;
            actions.appendChild(btnNeg);

            // Lógica para Oportunidade e Spread (cálculo inicial)
            // Esta parte será movida para uma função de cálculo para ser reutilizável
            const metricasSpan = document.createElement('span');
            metricasSpan.className = 'info-badge indicador-oportunidade';
            metricasSpan.dataset.role = 'metricas-negociacao';
            metricasSpan.textContent = 'Calculando...'; // Placeholder
            actions.appendChild(metricasSpan);

            wrap.appendChild(info);
            wrap.appendChild(actions);
            produtoCell.appendChild(wrap);
            contentRows.push(produtoRow);

            if (grupoProduto.itens && Array.isArray(grupoProduto.itens)) {
              grupoProduto.itens.forEach(item => {
                const subProdutoRow = tbody.insertRow();
                subProdutoRow.className = 'sub-produto-row';
                subProdutoRow.dataset.produto = item.Produto;
                subProdutoRow.dataset.fornecedor = item.Fornecedor;
                subProdutoRow.dataset.subprodutoOriginalPersistido = item._subProdutoOriginalPersistido;

                CotacaoIndividualScript_cabecalhosVisiveis.forEach(cabecalho => {
                  const td = subProdutoRow.insertCell();
                  let valor = item[cabecalho];
                  if (valor === undefined || valor === null) valor = '';

                  if (['Preço', 'Preço por Fator', 'Valor Total'].includes(cabecalho)) {
                    td.textContent = cotacaoindividual_formatarPreco(valor);
                  } else if (['Fator', 'Comprar'].includes(cabecalho)) {
                    const num = cotacaoindividual_parseNumeroPtBr(valor);
                    td.textContent = !isNaN(num) ? num.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 4 }) : '';
                  } else {
                    td.textContent = valor;
                  }

                  td.dataset.coluna = cabecalho;
                  td.dataset.valorOriginal = td.textContent;

                  const colunasEditaveis = ["SubProduto", "Tamanho", "UN", "Fator", "Preço", "Comprar"];
                  if (colunasEditaveis.includes(cabecalho)) {
                    td.classList.add('editable-price-cell');
                    td.addEventListener('click', cotacaoindividual_transformarCelulaEmInput);
                  }

                  if (CotacaoIndividualScript_MAPA_CORES_COLUNAS[cabecalho]) {
                    td.classList.add(CotacaoIndividualScript_MAPA_CORES_COLUNAS[cabecalho]);
                  }
                });
                contentRows.push(subProdutoRow);
              });
            }
            // Após renderizar os itens, atualizamos os cálculos do cabeçalho
            cotacaoindividual_atualizarGrupoDeCalculosCliente(produtoRow);
          });

          categoriaRow.addEventListener('click', () => {
            const isExpanded = categoriaRow.classList.toggle('expanded');
            const icon = categoriaRow.querySelector('.categoria-accordion-icon');
            if (icon) {
              icon.style.transform = isExpanded ? 'rotate(90deg)' : 'rotate(0deg)';
            }
            contentRows.forEach(row => {
              row.classList.toggle('hidden-by-category', !isExpanded);
            });
          });
        });

        document.querySelectorAll('.negociacao-btn').forEach(button => {
          button.addEventListener('click', (event) => {
            event.stopPropagation();
            const produtoNome = event.currentTarget.dataset.produtoNome;
            cotacaoindividual_abrirModalNegociacao(produtoNome);
          });
        });
      }

      async function cotacaoindividual_carregarDadosCotacao(idCotacao) {
        cotacaoindividual_mostrarLoadingOverlay(true, 'Carregando dados da cotação...');

        const resposta = await cotacaoindividual_callApi('cotacaoindividual/detalhes', 'POST', { idCotacao });

        cotacaoindividual_mostrarLoadingOverlay(false);

        if (resposta && resposta.success) {
          CotacaoIndividualScript_dadosOriginaisCotacao = resposta.dados || [];
          CotacaoIndividualScript_cabecalhosVisiveis = resposta.cabecalhos || CotacaoIndividualScript_COLUNAS_A_EXIBIR_PADRAO;

          cotacaoindividual_renderizarCabecalhoTabela();
          cotacaoindividual_renderizarGruposDeProdutos(CotacaoIndividualScript_dadosOriginaisCotacao);

          const dataAberturaContainer = document.getElementById(CotacaoIndividualScript_ID_DATA_ABERTURA_EXIBIDA);
          if (dataAberturaContainer && resposta.dataAbertura) {
            const dataObj = new Date(resposta.dataAbertura);
            dataAberturaContainer.textContent = `Data de Abertura: ${dataObj.toLocaleDateString('pt-BR')}`;
          }
        } else {
          const msgErro = resposta.message || "Falha ao carregar dados da cotação.";
          cotacaoindividual_exibirFeedback(msgErro, true);
          const tbody = document.getElementById(CotacaoIndividualScript_ID_TABELA_PRODUTOS_COTACAO)?.querySelector('tbody');
          if (tbody) tbody.innerHTML = `<tr><td colspan="${CotacaoIndividualScript_cabecalhosVisiveis.length || 1}" class="text-center p-8 text-red-500">${msgErro}</td></tr>`;
        }
      }

      function cotacaoindividual_obterSubprodutosDoProduto(produtoNome) {
        const listaSubprodutos = [];
        CotacaoIndividualScript_dadosOriginaisCotacao.forEach(grupoProduto => {
          if (grupoProduto.Produto === produtoNome && grupoProduto.itens) {
            grupoProduto.itens.forEach(item => {
              listaSubprodutos.push({
                fornecedor: item.Fornecedor,
                subproduto: item.SubProduto || item.Subproduto,
                preco: cotacaoindividual_parseNumeroPtBr(item.Preço)
              });
            });
          }
        });
        listaSubprodutos.sort((a, b) => (a.preco || Infinity) - (b.preco || Infinity));
        return listaSubprodutos;
      }

      function cotacaoindividual_gerarMensagemNegociacao(nomeProduto, novoPrecoNumero) {
        const precoFmt = cotacaoindividual_formatarPreco(novoPrecoNumero);
        return `Olá, tudo bem?\n\nEstou cotando o produto: ${nomeProduto}.\n\nConsegui um preço melhor de ${precoFmt}. Você consegue cobrir essa oferta?\n\nFico no aguardo, obrigado!`;
      }

      function cotacaoindividual_aplicarDesconto(precoBase, percentual) {
        const p = Number(precoBase) || 0;
        const d = Number(percentual) || 0;
        return Math.max(0, p * (1 - d / 100));
      }

      function cotacaoindividual_abrirModalNegociacao(produto) {
        const subprodutos = cotacaoindividual_obterSubprodutosDoProduto(produto);

        const modal = document.getElementById('CotacaoIndividualScript_modalNegociacaoOverlay');
        const tituloModal = document.getElementById('CotacaoIndividualScript_modalNegociacao_titulo');
        const select = document.getElementById('CotacaoIndividualScript_selectSubproduto');
        const info = document.getElementById('CotacaoIndividualScript_infoSubproduto');
        const inpPerc = document.getElementById('CotacaoIndividualScript_inputPercentual');
        const inpNovo = document.getElementById('CotacaoIndividualScript_inputPrecoNovo');
        const txt = document.getElementById('CotacaoIndividualScript_textareaMensagem');
        const btnCopiar = document.getElementById('CotacaoIndividualScript_btnCopiarTextoNegociacao');
        const btnFechar = document.getElementById('CotacaoIndividualScript_btnFecharModalNegociacao');
        const btnCancelar = document.getElementById('CotacaoIndividualScript_btnCancelarModalNegociacao');

        if (!modal) return;

        tituloModal.textContent = `Negociação: ${produto}`;
        select.innerHTML = '';
        subprodutos.forEach((sp, idx) => {
          const opt = document.createElement('option');
          const precoFmt = sp.preco === null || isNaN(sp.preco) ? '—' : cotacaoindividual_formatarPreco(sp.preco);
          opt.value = String(idx);
          opt.textContent = `${sp.subproduto} — ${sp.fornecedor} — ${precoFmt}`;
          select.appendChild(opt);
        });
        if (subprodutos.length > 0) select.value = '0';

        const atualizar = () => {
          const sp = subprodutos[Number(select.value)];
          if (!sp) return;
          info.textContent = `Base: ${sp.subproduto} — ${sp.fornecedor} — ${cotacaoindividual_formatarPreco(sp.preco)}`;
          const perc = Number(inpPerc.value || 0);
          const novo = cotacaoindividual_aplicarDesconto(sp.preco, perc);
          inpNovo.value = cotacaoindividual_formatarPreco(novo);
          txt.value = cotacaoindividual_gerarMensagemNegociacao(produto, novo);
        };

        select.onchange = atualizar;
        inpPerc.oninput = atualizar;

        const fechar = () => {
          modal.classList.remove('active');
          select.onchange = null;
          inpPerc.oninput = null;
        };

        btnCopiar.onclick = () => {
          txt.select();
          navigator.clipboard.writeText(txt.value).then(() => {
            cotacaoindividual_exibirFeedback('Mensagem copiada!', false, 2000);
          });
        };

        btnFechar.onclick = fechar;
        btnCancelar.onclick = fechar;
        modal.addEventListener('click', (e) => {
          if (e.target === modal) fechar();
        });

        atualizar();
        modal.classList.add('active');
      }

      //----------------------------------------------------------------------------------------------------
      // INICIALIZAÇÃO
      //----------------------------------------------------------------------------------------------------

      function cotacaoindividual_obterParametros() {
        const params = new URLSearchParams(window.location.search);
        const idCotacao = params.get('idCotacao');
        return { idCotacao };
      }

      async function inicializarPagina() {
        console.log("CotacaoIndividualScript: Iniciando para Firebase...");

        cotacaoindividual_vincularDropdowns(); // <-- ADICIONE ESTA LINHA

        const params = cotacaoindividual_obterParametros();
        CotacaoIndividualScript_cotacaoIdAtual = params.idCotacao;

        const spanIdCotacao = document.getElementById(CotacaoIndividualScript_ID_COTACAO_EXIBIDO);

        if (CotacaoIndividualScript_cotacaoIdAtual) {
          if (spanIdCotacao) spanIdCotacao.textContent = CotacaoIndividualScript_cotacaoIdAtual;
          document.title = `Cotação: ${CotacaoIndividualScript_cotacaoIdAtual}`;
          await cotacaoindividual_carregarDadosCotacao(CotacaoIndividualScript_cotacaoIdAtual);
        } else {
          if (spanIdCotacao) spanIdCotacao.textContent = "Inválida";
          document.title = "Cotação Inválida - CotaçãoPRO";
          cotacaoindividual_exibirFeedback("ID da Cotação não fornecido.", true, 0);
          const tbody = document.getElementById(CotacaoIndividualScript_ID_TABELA_PRODUTOS_COTACAO)?.querySelector('tbody');
          if (tbody) tbody.innerHTML = `<tr><td colspan="1" class="text-center p-8 text-red-500">ID da Cotação não fornecido na URL.</td></tr>`;
        }
      }

      document.addEventListener('DOMContentLoaded', inicializarPagina);

    })();

    function CotacaoIndividualScript_calcularMetricasNegociacao(grupo) {
      const resultado = {
        oportunidadeReais: 0,
        spreadPercent: 0,
      };

      if (!grupo || !grupo.itens || grupo.itens.length < 2) {
        return resultado;
      }

      // 1. Calcular todos os preços por fator válidos e ordená-los
      const precosPorFatorValidos = grupo.itens
        .map(item => {
          const preco = cotacaoindividual_parseNumeroPtBr(item["Preço"]);
          const fator = cotacaoindividual_parseNumeroPtBr(item["Fator"]);
          if (!isNaN(preco) && !isNaN(fator) && fator > 0) {
            return preco / fator;
          }
          return null;
        })
        .filter(p => p !== null && p > 0)
        .sort((a, b) => a - b);

      if (precosPorFatorValidos.length < 2) {
        return resultado;
      }

      // 2. Definir P1, P2 e a Mediana
      const p1 = precosPorFatorValidos[0];
      const p2 = precosPorFatorValidos[1];

      const mid = Math.floor(precosPorFatorValidos.length / 2);
      const pMediana = precosPorFatorValidos.length % 2 === 0
        ? (precosPorFatorValidos[mid - 1] + precosPorFatorValidos[mid]) / 2
        : precosPorFatorValidos[mid];

      // 3. Obter a quantidade base (Q) usando a Demanda Média
      const quantidadeBase = cotacaoindividual_parseNumeroPtBr(grupo.demandaMediaProdutoPrincipal);

      // 4. Calcular Oportunidade (R$)
      if (!isNaN(quantidadeBase) && quantidadeBase > 0 && pMediana > p1) {
        resultado.oportunidadeReais = (pMediana - p1) * quantidadeBase;
      }

      // 5. Calcular Spread (%)
      if (p1 > 0 && p2) {
        resultado.spreadPercent = ((p2 - p1) / p1) * 100;
      }

      return resultado;
    }

    // AGORA, SUBSTITUA A SUA FUNÇÃO `cotacaoindividual_renderizarGruposDeProdutos` EXISTENTE POR ESTA VERSÃO
    function cotacaoindividual_renderizarGruposDeProdutos(dadosAgrupados) {
      const tabela = document.getElementById(CotacaoIndividualScript_ID_TABELA_PRODUTOS_COTACAO);
      if (!tabela) return;
      const tbody = tabela.querySelector('tbody');
      tbody.innerHTML = '';

      if (!dadosAgrupados || dadosAgrupados.length === 0) {
        const tr = tbody.insertRow();
        const td = tr.insertCell();
        td.colSpan = CotacaoIndividualScript_cabecalhosVisiveis.length || 1;
        td.className = 'text-center p-8 text-gray-500';
        td.textContent = 'Nenhum produto para esta cotação.';
        return;
      }

      const agrupadoPorCategoria = dadosAgrupados.reduce((acc, produto) => {
        const categoria = (produto.itens && produto.itens[0]?.Categoria) ? produto.itens[0].Categoria : 'Sem Categoria';
        if (!acc[categoria]) {
          acc[categoria] = [];
        }
        acc[categoria].push(produto);
        return acc;
      }, {});

      const categoriasOrdenadas = Object.keys(agrupadoPorCategoria).sort();

      categoriasOrdenadas.forEach(nomeCategoria => {
        const categoriaRow = tbody.insertRow();
        categoriaRow.className = 'categoria-accordion-header-row expanded';
        const categoriaCell = categoriaRow.insertCell();
        categoriaCell.colSpan = CotacaoIndividualScript_cabecalhosVisiveis.length;
        categoriaCell.innerHTML = `
                    <div class="categoria-header-content">
                        <svg class="categoria-accordion-icon" style="transform: rotate(90deg);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        <span>${nomeCategoria}</span>
                    </div>
                `;

        const contentRows = [];

        agrupadoPorCategoria[nomeCategoria].forEach(grupoProduto => {
          const produtoRow = tbody.insertRow();
          produtoRow.className = 'produto-group-separator-row';
          produtoRow.dataset.produtoNome = grupoProduto.Produto;
          const produtoCell = produtoRow.insertCell();
          produtoCell.colSpan = CotacaoIndividualScript_cabecalhosVisiveis.length;

          const wrap = document.createElement('div');
          wrap.className = 'contagem-container-principal';

          const info = document.createElement('div');
          info.className = 'produto-principal-info';
          info.textContent = grupoProduto.Produto;

          const actions = document.createElement('div');
          actions.className = 'contagem-fields-container';

          const estMinimo = grupoProduto.estoqueMinimoProdutoPrincipal !== null ? parseFloat(grupoProduto.estoqueMinimoProdutoPrincipal).toFixed(2) : 'N/A';
          const demandaMedia = grupoProduto.demandaMediaProdutoPrincipal !== null ? parseFloat(grupoProduto.demandaMediaProdutoPrincipal).toFixed(2) : 'N/A';

          let totalComprar = 0;
          if (grupoProduto.itens && Array.isArray(grupoProduto.itens)) {
            grupoProduto.itens.forEach(item => {
              const comprarValor = cotacaoindividual_parseNumeroPtBr(item.Comprar);
              if (!isNaN(comprarValor)) {
                totalComprar += comprarValor;
              }
            });
          }

          const estoqueAtual = grupoProduto.estoqueAtualProdutoPrincipal !== null ? parseFloat(grupoProduto.estoqueAtualProdutoPrincipal) : 0;
          const saldoEstoque = estoqueAtual - totalComprar;

          const metricas = CotacaoIndividualScript_calcularMetricasNegociacao(grupoProduto);
          const oportunidadeFormatada = cotacaoindividual_formatarPreco(metricas.oportunidadeReais);
          const spreadFormatado = metricas.spreadPercent.toFixed(2) + '%';

          actions.innerHTML = `
                <div class="contagem-field-block">
                    <span class="campo-contagem-label">Est. Mínimo:</span>
                    <span class="campo-contagem-valor">${estMinimo}</span>
                </div>
                <div class="contagem-field-block">
                    <span class="campo-contagem-label">Demanda Média:</span>
                    <span class="campo-contagem-valor">${demandaMedia}</span>
                </div>
                <div class="contagem-field-block">
                    <span class="campo-contagem-label">Est. Atual / Comprar:</span>
                    <span class="campo-contagem-valor ${saldoEstoque < 0 ? 'negativo' : ''}" data-role="saldo-estoque">${estoqueAtual.toFixed(2)} / ${totalComprar.toFixed(2)}</span>
                </div>
                <span class="info-badge indicador-oportunidade" data-role="metricas-negociacao">Oportunidade: ${oportunidadeFormatada} | Spread: ${spreadFormatado}</span>
            `;

          const btnNeg = document.createElement('button');
          btnNeg.className = 'info-badge clickable negociacao-btn';
          btnNeg.dataset.produtoNome = grupoProduto.Produto;
          btnNeg.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M12 3a9 9 0 100 18 9 9 0 000-18zm1 5h2v8h-2V8zm-4 0h2v8H9V8z"/></svg><span>Negociação</span>`;
          actions.appendChild(btnNeg);

          wrap.appendChild(info);
          wrap.appendChild(actions);
          produtoCell.appendChild(wrap);
          contentRows.push(produtoRow);

          if (grupoProduto.itens && Array.isArray(grupoProduto.itens)) {
            grupoProduto.itens.forEach(item => {
              const subProdutoRow = tbody.insertRow();
              subProdutoRow.className = 'sub-produto-row';
              subProdutoRow.dataset.produto = item.Produto;
              subProdutoRow.dataset.fornecedor = item.Fornecedor;
              subProdutoRow.dataset.subprodutoOriginalPersistido = item._subProdutoOriginalPersistido;

              CotacaoIndividualScript_cabecalhosVisiveis.forEach(cabecalho => {
                const td = subProdutoRow.insertCell();
                let valor = item[cabecalho];
                if (valor === undefined || valor === null) valor = '';

                if (['Preço', 'Preço por Fator', 'Valor Total'].includes(cabecalho)) {
                  td.textContent = cotacaoindividual_formatarPreco(valor);
                } else if (['Fator', 'Comprar'].includes(cabecalho)) {
                  const num = cotacaoindividual_parseNumeroPtBr(valor);
                  td.textContent = !isNaN(num) ? num.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 4 }) : '';
                } else {
                  td.textContent = valor;
                }

                td.dataset.coluna = cabecalho;
                td.dataset.valorOriginal = td.textContent;

                const colunasEditaveis = ["SubProduto", "Tamanho", "UN", "Fator", "Preço", "Comprar"];
                if (colunasEditaveis.includes(cabecalho)) {
                  td.classList.add('editable-price-cell');
                  td.addEventListener('click', cotacaoindividual_transformarCelulaEmInput);
                }

                if (CotacaoIndividualScript_MAPA_CORES_COLUNAS[cabecalho]) {
                  td.classList.add(CotacaoIndividualScript_MAPA_CORES_COLUNAS[cabecalho]);
                }
              });
              contentRows.push(subProdutoRow);
            });
          }
        });

        categoriaRow.addEventListener('click', () => {
          const isExpanded = categoriaRow.classList.toggle('expanded');
          const icon = categoriaRow.querySelector('.categoria-accordion-icon');
          if (icon) {
            icon.style.transform = isExpanded ? 'rotate(90deg)' : 'rotate(0deg)';
          }
          contentRows.forEach(row => {
            row.classList.toggle('hidden-by-category', !isExpanded);
          });
        });
      });

      document.querySelectorAll('.negociacao-btn').forEach(button => {
        button.addEventListener('click', (event) => {
          event.stopPropagation();
          const produtoNome = event.currentTarget.dataset.produtoNome;
          cotacaoindividual_abrirModalNegociacao(produtoNome);
        });
      });
    }

    //####################################################################################################
    // INÍCIO DO MÓDULO DE ETAPAS (CLIENT-SIDE)
    //####################################################################################################

    // --- ETAPA 1: CONTAGEM DE ESTOQUE ---

    function EtapasScript_ativarModoContagemEstoque() {
      console.log("EtapasScript: Ativando modo Contagem de Estoque (Modal).");
      CotacaoIndividualScript_modoEtapaAtual = 'contagem_estoque';

      if (CotacaoIndividualScript_dadosOriginaisCotacao.length === 0) {
        cotacaoindividual_exibirFeedback("Dados da cotação ainda não carregados. Tente novamente.", true, 5000);
        CotacaoIndividualScript_modoEtapaAtual = null;
        return;
      }
      EtapasScript_renderizarConteudoModalContagem();
      const modalOverlay = document.getElementById('EtapasScript_modalContagemEstoqueOverlay');
      if (modalOverlay) {
        modalOverlay.classList.add('active');
      }
      const btnSalvar = document.getElementById('EtapasScript_btnSalvarModalContagem');
      const btnCancelar = document.getElementById('EtapasScript_btnCancelarModalContagem');
      const btnFechar = document.getElementById('EtapasScript_btnFecharModalContagemEstoque');

      btnSalvar.removeEventListener('click', EtapasScript_salvarContagemEstoqueEtapa);
      btnCancelar.removeEventListener('click', EtapasScript_fecharModalContagemEstoque);
      btnFechar.removeEventListener('click', EtapasScript_fecharModalContagemEstoque);

      btnSalvar.addEventListener('click', EtapasScript_salvarContagemEstoqueEtapa);
      btnCancelar.addEventListener('click', EtapasScript_fecharModalContagemEstoque);
      btnFechar.addEventListener('click', EtapasScript_fecharModalContagemEstoque);
    }

    function EtapasScript_fecharModalContagemEstoque() {
      console.log("EtapasScript: Fechando modal de Contagem de Estoque.");
      const modalOverlay = document.getElementById('EtapasScript_modalContagemEstoqueOverlay');
      if (modalOverlay) {
        modalOverlay.classList.remove('active');
      }
      CotacaoIndividualScript_modoEtapaAtual = null;
      const feedbackDiv = document.getElementById('EtapasScript_feedbackModalContagem');
      if (feedbackDiv) feedbackDiv.innerHTML = '';
    }

    function EtapasScript_renderizarConteudoModalContagem() {
      const tbody = document.getElementById('EtapasScript_tbodyModalContagemEstoque');
      if (!tbody) return;
      tbody.innerHTML = '';

      const produtosPrincipais = {};
      CotacaoIndividualScript_dadosOriginaisCotacao.forEach(grupo => {
        const nomeProduto = grupo.Produto;
        if (!produtosPrincipais[nomeProduto]) {
          produtosPrincipais[nomeProduto] = {
            nome: nomeProduto,
            estoqueMinimo: grupo.estoqueMinimoProdutoPrincipal ?? '',
            dadosEstoqueCompra: CotacaoIndividualScript_parsearStringEstoqueComprar(grupo["Estoque Atual"])
          };
        }
      });

      const listaProdutos = Object.values(produtosPrincipais).sort((a, b) => a.nome.localeCompare(b.nome));
      listaProdutos.forEach(produto => {
        const tr = tbody.insertRow();
        tr.dataset.produtoNome = produto.nome;
        tr.insertCell().textContent = produto.nome;

        const tdEstMin = tr.insertCell();
        const inputEstMin = document.createElement('input');
        inputEstMin.type = 'number';
        inputEstMin.className = 'input-contagem input-estoque-min-prod-principal';
        inputEstMin.value = produto.estoqueMinimo;
        tdEstMin.appendChild(inputEstMin);

        const tdEstContado = tr.insertCell();
        const inputEstContado = document.createElement('input');
        inputEstContado.type = 'number';
        inputEstContado.className = 'input-contagem input-estoque-contado-prod-principal';
        inputEstContado.value = produto.dadosEstoqueCompra.estoqueAtual ?? '';
        tdEstContado.appendChild(inputEstContado);

        const tdComprar = tr.insertCell();
        const inputComprar = document.createElement('input');
        inputComprar.type = 'number';
        inputComprar.className = 'input-contagem input-comprar-sugestao-prod-principal';
        inputComprar.value = produto.dadosEstoqueCompra.comprar ?? '';
        tdComprar.appendChild(inputComprar);
      });
    }

    async function EtapasScript_salvarContagemEstoqueEtapa() {
      const dadosParaSalvar = [];
      document.querySelectorAll('#EtapasScript_tbodyModalContagemEstoque tr').forEach(row => {
        const produtoNome = row.dataset.produtoNome;
        if (!produtoNome) return;
        const novoEstoqueMinimo = row.querySelector('.input-estoque-min-prod-principal').value;
        const estoqueContado = row.querySelector('.input-estoque-contado-prod-principal').value;
        const comprarSugestao = row.querySelector('.input-comprar-sugestao-prod-principal').value;
        if (novoEstoqueMinimo !== '' || estoqueContado !== '' || comprarSugestao !== '') {
          dadosParaSalvar.push({
            nomeProdutoPrincipal: produtoNome,
            novoEstoqueMinimoProdutoPrincipal: novoEstoqueMinimo !== '' ? parseFloat(novoEstoqueMinimo.replace(',', '.')) : null,
            estoqueAtualContagem: estoqueContado !== '' ? parseFloat(estoqueContado.replace(',', '.')) : null,
            comprarSugestao: comprarSugestao !== '' ? parseFloat(comprarSugestao.replace(',', '.')) : null
          });
        }
      });

      if (dadosParaSalvar.length === 0) {
        EtapasScript_exibirFeedbackModalContagem("Nenhum dado foi inserido para salvar.", false, 4000);
        return;
      }

      const btnSalvar = document.getElementById('EtapasScript_btnSalvarModalContagem');
      btnSalvar.disabled = true;
      btnSalvar.textContent = 'Salvando...';
      EtapasScript_exibirFeedbackModalContagem("Salvando contagem...", false, 0);

      const response = await cotacaoindividual_callApi('cotacaoindividual/salvar-contagem', 'POST', {
        idCotacao: CotacaoIndividualScript_cotacaoIdAtual,
        dadosContagem: dadosParaSalvar
      });

      btnSalvar.disabled = false;
      btnSalvar.textContent = 'Salvar Contagem';
      if (response.success) {
        EtapasScript_fecharModalContagemEstoque();
        cotacaoindividual_exibirFeedback(response.message || "Contagem salva! Atualizando dados...", false, 5000);
        cotacaoindividual_carregarDadosCotacao(CotacaoIndividualScript_cotacaoIdAtual);
      } else {
        EtapasScript_exibirFeedbackModalContagem(response.message || "Falha ao salvar.", true, 7000);
      }
    }

    function EtapasScript_exibirFeedbackModalContagem(mensagem, isError = false, duracao = 5000) {
      const feedbackDiv = document.getElementById('EtapasScript_feedbackModalContagem');
      if (feedbackDiv) {
        const innerDiv = document.createElement('div');
        innerDiv.className = `p-3 rounded-md text-sm ${isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
        innerDiv.textContent = mensagem;
        feedbackDiv.innerHTML = '';
        feedbackDiv.appendChild(innerDiv);
        if (duracao > 0) setTimeout(() => { if (feedbackDiv.contains(innerDiv)) feedbackDiv.innerHTML = ''; }, duracao);
      }
    }

    // --- ETAPA 2: RETIRAR PRODUTOS ---

    function EtapasScript_identificarProdutosParaRetirada() {
      const produtosParaRetirada = { crit1: [], crit2: [], crit3: [] };
      if (!CotacaoIndividualScript_dadosOriginaisCotacao) return produtosParaRetirada;

      CotacaoIndividualScript_dadosOriginaisCotacao.forEach(grupoProduto => {
        const nomeProdutoPrincipal = grupoProduto.Produto;
        const estoqueMin = grupoProduto.estoqueMinimoProdutoPrincipal;
        const dadosEstoque = CotacaoIndividualScript_parsearStringEstoqueComprar(grupoProduto['Estoque Atual']);

        if (dadosEstoque.estoqueAtual !== null && estoqueMin !== null && dadosEstoque.estoqueAtual >= estoqueMin) {
          produtosParaRetirada.crit1.push({ nomeProdutoPrincipal, motivo: `Est. Atual (${dadosEstoque.estoqueAtual}) >= Mín. (${estoqueMin})` });
        } else if (dadosEstoque.estoqueAtual === null && dadosEstoque.comprar === null) {
          produtosParaRetirada.crit2.push({ nomeProdutoPrincipal, motivo: "Não foi marcado para comprar." });
        } else if (estoqueMin === null) {
          produtosParaRetirada.crit3.push({ nomeProdutoPrincipal, motivo: "Produto sem estoque mínimo definido." });
        }
      });
      return produtosParaRetirada;
    }

    async function EtapasScript_manipularExclusaoProdutosRetirar() {
      const produtosParaExcluir = Array.from(document.querySelectorAll('#EtapasScript_modalRetirarProdutosOverlay .checkbox-retirar-item-principal:checked'))
        .map(cb => cb.dataset.produtoPrincipal);

      if (produtosParaExcluir.length === 0) {
        EtapasScript_exibirFeedbackModalRetirarProdutos("Nenhum produto selecionado.", true, 4000);
        return;
      }

      const btnConfirmar = document.getElementById('EtapasScript_btnConfirmarRemocaoModal');
      btnConfirmar.disabled = true;
      btnConfirmar.textContent = 'Excluindo...';
      EtapasScript_exibirFeedbackModalRetirarProdutos("Excluindo produtos...", false, 0);

      const response = await cotacaoindividual_callApi('cotacaoindividual/retirar-produtos', 'POST', {
        idCotacao: CotacaoIndividualScript_cotacaoIdAtual,
        nomesProdutosPrincipaisParaExcluir: produtosParaExcluir
      });

      btnConfirmar.disabled = false;
      btnConfirmar.textContent = 'Confirmar Remoção';
      if (response.success) {
        EtapasScript_fecharModalRetirarProdutos();
        cotacaoindividual_exibirFeedback("Produtos retirados com sucesso!", false, 5000);
        cotacaoindividual_carregarDadosCotacao(CotacaoIndividualScript_cotacaoIdAtual);
      } else {
        EtapasScript_exibirFeedbackModalRetirarProdutos(response.message || "Falha ao retirar produtos.", true, 7000);
      }
    }

    function EtapasScript_ativarModoRetirarProdutos() {
      console.log("EtapasScript: Ativando modo Retirar Produtos (Modal).");
      CotacaoIndividualScript_modoEtapaAtual = 'retirar_produtos';
      if (CotacaoIndividualScript_dadosOriginaisCotacao.length === 0) {
        cotacaoindividual_exibirFeedback("Dados da cotação ainda não carregados.", true, 5000);
        CotacaoIndividualScript_modoEtapaAtual = null;
        return;
      }
      EtapasScript_renderizarConteudoModalRetirarProdutos();
      document.getElementById('EtapasScript_modalRetirarProdutosOverlay')?.classList.add('active');
      const btnConfirmar = document.getElementById('EtapasScript_btnConfirmarRemocaoModal');
      const btnCancelar = document.getElementById('EtapasScript_btnCancelarModalRetirarProdutos');
      const btnFechar = document.getElementById('EtapasScript_btnFecharModalRetirarProdutos');

      btnConfirmar.removeEventListener('click', EtapasScript_manipularExclusaoProdutosRetirar);
      btnCancelar.removeEventListener('click', EtapasScript_fecharModalRetirarProdutos);
      btnFechar.removeEventListener('click', EtapasScript_fecharModalRetirarProdutos);

      btnConfirmar.addEventListener('click', EtapasScript_manipularExclusaoProdutosRetirar);
      btnCancelar.addEventListener('click', EtapasScript_fecharModalRetirarProdutos);
      btnFechar.addEventListener('click', EtapasScript_fecharModalRetirarProdutos);
    }

    function EtapasScript_fecharModalRetirarProdutos() {
      document.getElementById('EtapasScript_modalRetirarProdutosOverlay')?.classList.remove('active');
      CotacaoIndividualScript_modoEtapaAtual = null;
      const feedbackDiv = document.getElementById('EtapasScript_feedbackModalRetirarProdutos');
      if (feedbackDiv) feedbackDiv.innerHTML = '';
    }

    // --- ETAPA 3: ENVIAR PARA FORNECEDORES ---
    async function EtapasScript_iniciarEnvioParaFornecedores() {
      console.log("EtapasScript: Iniciando envio para fornecedores.");
      if (!CotacaoIndividualScript_cotacaoIdAtual) {
        cotacaoindividual_exibirFeedback("ID da Cotação não definido.", true, 5000);
        return;
      }
      cotacaoindividual_mostrarLoadingOverlay(true, "Atualizando status da cotação...");
      const response = await cotacaoindividual_callApi('cotacaoindividual/atualizar-status', 'POST', {
        idCotacao: CotacaoIndividualScript_cotacaoIdAtual,
        novoStatus: "Aguardando Preços"
      });

      cotacaoindividual_mostrarLoadingOverlay(false);
      if (response.success) {
        cotacaoindividual_exibirFeedback("Status atualizado! A cotação está pronta para o envio aos fornecedores.", false, 7000);
        // A lógica de gerar e enviar links seria em outro local/módulo no Firebase.
      } else {
        cotacaoindividual_exibirFeedback(response.message || "Falha ao atualizar status.", true, 7000);
      }
    }

    // --- ETAPA 4: REALIZAR COTAÇÃO ---

    async function EtapasScript_ativarModoRealizarCotacao() {
      console.log("EtapasScript: Ativando modo Realizar Cotação.");
      CotacaoIndividualScript_modoEtapaAtual = 'realizar_cotacao';
      document.getElementById('EtapasScript_realizarCotacaoContainer').classList.remove('hidden');
      document.getElementById('CotacaoIndividualScript_tableContainer').classList.add('hidden');

      const subprodutosSemPreco = EtapasScript_identificarSubprodutosSemPreco();
      EtapasScript_renderizarListaSubprodutosSemPreco(subprodutosSemPreco);

      cotacaoindividual_mostrarLoadingOverlay(true, "Atualizando status...");
      const response = await cotacaoindividual_callApi('cotacaoindividual/atualizar-status', 'POST', {
        idCotacao: CotacaoIndividualScript_cotacaoIdAtual,
        novoStatus: "Realizando Cotação"
      });
      cotacaoindividual_mostrarLoadingOverlay(false);
      if (!response.success) {
        cotacaoindividual_exibirFeedback(response.message || "Falha ao atualizar status.", true, 5000);
      }
    }

    function EtapasScript_desativarModoRealizarCotacao() {
      console.log("EtapasScript: Desativando modo Realizar Cotação.");
      CotacaoIndividualScript_modoEtapaAtual = null;
      document.getElementById('EtapasScript_realizarCotacaoContainer').classList.add('hidden');
      document.getElementById('CotacaoIndividualScript_tableContainer').classList.remove('hidden');
      cotacaoindividual_exibirFeedback("Visualização padrão restaurada.", false, 3000);
    }

    function EtapasScript_identificarSubprodutosSemPreco() {
      if (!CotacaoIndividualScript_dadosOriginaisCotacao) return [];
      const semPreco = [];
      CotacaoIndividualScript_dadosOriginaisCotacao.forEach(grupo => {
        grupo.itens.forEach(item => {
          const preco = cotacaoindividual_parseNumeroPtBr(item['Preço']);
          if (isNaN(preco) || preco === 0) {
            semPreco.push(item);
          }
        });
      });
      return semPreco;
    }

    async function EtapasScript_manipularExclusaoSubprodutosSemPreco() {
      const subprodutosParaExcluir = Array.from(document.querySelectorAll('.checkbox-retirar-subproduto-sem-preco:checked'))
        .map(cb => ({
          Produto: cb.dataset.produto,
          SubProdutoChave: cb.dataset.subproduto,
          Fornecedor: cb.dataset.fornecedor
        }));

      if (subprodutosParaExcluir.length > 0) {
        cotacaoindividual_mostrarLoadingOverlay(true, "Excluindo subprodutos...");
        const response = await cotacaoindividual_callApi('cotacaoindividual/retirar-subprodutos', 'POST', {
          idCotacao: CotacaoIndividualScript_cotacaoIdAtual,
          subprodutosParaExcluir: subprodutosParaExcluir
        });
        cotacaoindividual_mostrarLoadingOverlay(false);

        if (response.success) {
          cotacaoindividual_exibirFeedback("Subprodutos sem preço removidos.", false, 4000);
          await cotacaoindividual_carregarDadosCotacao(CotacaoIndividualScript_cotacaoIdAtual);
        } else {
          cotacaoindividual_exibirFeedback(response.message || "Falha ao excluir.", true, 5000);
          return; // Não continua se a exclusão falhar
        }
      }
      EtapasScript_iniciarEdicao();
    }

    function EtapasScript_iniciarEdicao() {
      document.getElementById('EtapasScript_realizarCotacaoContainer').classList.add('hidden');
      document.getElementById(CotacaoIndividualScript_tableContainer).classList.remove('hidden');
      cotacaoindividual_exibirFeedback("Modo de edição ativado. Clique em uma célula para editar.", false, 6000);
    }

    // --- ETAPA 5: DEFINIR EMPRESA PARA FATURAMENTO ---
    let EtapasScript_empresasParaFaturamento = [];
    let EtapasScript_pedidosMinimosFornecedores = {};

    async function EtapasScript_ativarModoDefinirEmpresa() {
      console.log("EtapasScript: Ativando modo Definir Empresa (Modal).");
      CotacaoIndividualScript_modoEtapaAtual = 'definir_empresa';

      const modalOverlay = document.getElementById('EtapasScript_modalDefinirEmpresaOverlay');
      if (!modalOverlay) return;

      modalOverlay.classList.add('active');
      EtapasScript_exibirFeedbackModalDefinirEmpresa("Carregando dados...", false, 0);

      const response = await cotacaoindividual_callApi('cotacaoindividual/dados-faturamento', 'GET');

      if (response.success) {
        EtapasScript_empresasParaFaturamento = response.empresas || [];
        EtapasScript_pedidosMinimosFornecedores = response.pedidosMinimos || {};
        // Lógica de renderização do modal aqui...
        EtapasScript_exibirFeedbackModalDefinirEmpresa("Dados carregados.", false, 4000);
      } else {
        EtapasScript_exibirFeedbackModalDefinirEmpresa(response.message || "Falha ao carregar dados.", true, 5000);
        setTimeout(() => EtapasScript_fecharModalDefinirEmpresa(), 5000);
      }

      // ... resto da lógica de renderização e botões ...
    }

    function EtapasScript_fecharModalDefinirEmpresa() {
      document.getElementById('EtapasScript_modalDefinirEmpresaOverlay')?.classList.remove('active');
      CotacaoIndividualScript_modoEtapaAtual = null;
    }

    async function EtapasScript_salvarFaturamentoEmLote() {
      const alteracoes = EtapasScript_coletarAlteracoesFaturamento();
      if (alteracoes.length === 0) {
        EtapasScript_exibirFeedbackModalDefinirEmpresa("Nenhuma alteração para salvar.", false, 4000);
        return;
      }
      const btnSalvar = document.getElementById('EtapasScript_btnSalvarFaturamento');
      btnSalvar.disabled = true;
      btnSalvar.textContent = 'Salvando...';

      const response = await cotacaoindividual_callApi('cotacaoindividual/salvar-faturamento', 'POST', {
        idCotacao: CotacaoIndividualScript_cotacaoIdAtual,
        alteracoes: alteracoes
      });

      btnSalvar.disabled = false;
      btnSalvar.textContent = 'Salvar e Fechar';
      if (response.success) {
        EtapasScript_fecharModalDefinirEmpresa();
        cotacaoindividual_exibirFeedback("Faturamento salvo com sucesso! Atualizando...", false, 5000);
        cotacaoindividual_carregarDadosCotacao(CotacaoIndividualScript_cotacaoIdAtual);
      } else {
        EtapasScript_exibirFeedbackModalDefinirEmpresa(response.message || "Falha ao salvar.", true, 7000);
      }
    }

    // --- ETAPA 6: DEFINIR CONDIÇÕES DE PAGAMENTO ---
    async function EtapasScript_ativarModoDefinirCondicoesPagamento() {
      console.log("EtapasScript: Ativando modo Definir Condições de Pagamento (Modal).");
      CotacaoIndividualScript_modoEtapaAtual = 'definir_condicoes_pagamento';

      const modalOverlay = document.getElementById('EtapasScript_modalCondicoesPagamentoOverlay');
      modalOverlay.classList.add('active');
      EtapasScript_exibirFeedbackModalCondicoes("Carregando dados...", false, 0);

      const response = await cotacaoindividual_callApi('cotacaoindividual/dados-condicoes', 'GET');
      if (response.success) {
        // Lógica de renderização do modal de condições...
        EtapasScript_exibirFeedbackModalCondicoes("", false, 1);
      } else {
        EtapasScript_exibirFeedbackModalCondicoes(response.message || "Falha ao carregar dados.", true, 5000);
        setTimeout(EtapasScript_fecharModalCondicoesPagamento, 3000);
      }
    }

    function EtapasScript_fecharModalCondicoesPagamento() {
      document.getElementById('EtapasScript_modalCondicoesPagamentoOverlay')?.classList.remove('active');
      CotacaoIndividualScript_modoEtapaAtual = null;
    }

    async function EtapasScript_salvarDadosCondicoesPagamento() {
      // Lógica para coletar dados do formulário do modal
      const dadosParaSalvar = []; //... preencher com os dados
      if (dadosParaSalvar.length === 0) {
        EtapasScript_exibirFeedbackModalCondicoes("Não há dados para salvar.", false, 4000);
        return;
      }

      const btnSalvar = document.getElementById('EtapasScript_btnSalvarModalCondicoes');
      btnSalvar.disabled = true;
      btnSalvar.textContent = "Salvando...";

      const response = await cotacaoindividual_callApi('cotacaoindividual/salvar-condicoes', 'POST', {
        idCotacao: CotacaoIndividualScript_cotacaoIdAtual,
        dadosPagamento: dadosParaSalvar
      });

      btnSalvar.disabled = false;
      btnSalvar.textContent = "Salvar Condições";
      if (response.success) {
        EtapasScript_fecharModalCondicoesPagamento();
        cotacaoindividual_exibirFeedback(response.message, false, 6000);
        cotacaoindividual_carregarDadosCotacao(CotacaoIndividualScript_cotacaoIdAtual);
      } else {
        EtapasScript_exibirFeedbackModalCondicoes(response.message || "Falha ao salvar.", true, 8000);
      }
    }

    // --- ETAPA 7: IMPRIMIR PEDIDOS ---

    function EtapasScript_abrirPaginaImpressao() {
      console.log("EtapasScript: Abrindo página de impressão.");
      if (!CotacaoIndividualScript_cotacaoIdAtual) {
        cotacaoindividual_exibirFeedback("ID da Cotação não encontrado.", true, 5000);
        return;
      }
      // No Firebase, a geração de PDF é diferente.
      // O ideal é abrir uma nova aba com uma view que buscará os dados e gerará o PDF no cliente.
      const url = `/views/ImprimirPedidosView.html?idCotacao=${CotacaoIndividualScript_cotacaoIdAtual}`;
      window.open(url, '_blank');
    }

    //####################################################################################################
    // FIM DO MÓDULO DE ETAPAS (CLIENT-SIDE)
    //####################################################################################################


  </script>

</body>

</html>