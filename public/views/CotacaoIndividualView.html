<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detalhes da Cotação</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
      background-color: #f4f7f6;
      overflow-x: hidden;
    }

    .cotacao-individual-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
    }

    .top-menu-bar {
      background-color: #1D4ED8;
      color: white;
      padding: 0.75rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      flex-shrink: 0;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .title-container {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      margin-right: auto;
    }

    .top-menu-bar .title {
      font-size: 1.25rem;
      font-weight: 600;
    }

    .data-abertura-info {
      font-size: 0.8rem;
      color: #e0e0e0;
      margin-top: 0.15rem;
    }

    .top-menu-bar .actions {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .top-menu-search-container {
      display: flex;
      align-items: center;
      background-color: rgba(255, 255, 255, 0.15);
      padding: 0.25rem 0.5rem;
      border-radius: 0.375rem;
      min-width: 200px;
      flex-grow: 1;
      max-width: 350px;
      margin-right: 1rem;
    }

    .top-menu-search-container input[type="text"] {
      width: 100%;
      padding: 0.4rem 0.6rem;
      border: 1px solid transparent;
      border-radius: 0.25rem;
      font-size: 0.875rem;
      background-color: transparent;
      color: white;
      box-shadow: none;
    }

    .top-menu-search-container input[type="text"]::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }

    .top-menu-search-container input[type="text"]:focus {
      outline: none;
      background-color: rgba(255, 255, 255, 0.25);
      border-color: rgba(255, 255, 255, 0.5);
    }

    .btn-menu-superior {
      font-size: 0.875rem;
      font-weight: 500;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      transition: background-color 0.15s ease-in-out;
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      color: white;
      border: 1px solid transparent;
      cursor: pointer;
    }

    .btn-menu-superior:hover {
      opacity: 0.9;
    }

    .btn-menu-salvar {
      background-color: #16a34a;
    }

    .btn-menu-salvar:hover {
      background-color: #15803d;
    }

    .btn-menu-superior svg {
      width: 1rem;
      height: 1rem;
    }

    .dropdown-menu {
      position: relative;
      display: inline-block;
    }

    .dropdown-menu-button {
      background-color: #235fc2;
    }

    .dropdown-menu-button:hover {
      background-color: #1a3561;
    }

    .dropdown-menu-content {
      display: none;
      position: absolute;
      background-color: white;
      min-width: 250px;
      box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
      z-index: 1050;
      border-radius: 0.375rem;
      right: 0;
      border: 1px solid #e2e8f0;
      margin-top: 0.25rem;
    }

    .dropdown-menu-content.show {
      display: block;
    }

    .dropdown-menu-content a {
      color: #1f2937;
      padding: 0.75rem 1rem;
      text-decoration: none;
      display: block;
      font-size: 0.875rem;
      border-bottom: 1px solid #e2e8f0;
    }

    .dropdown-menu-content a:last-child {
      border-bottom: none;
    }

    .dropdown-menu-content a:hover {
      background-color: #f4f7f6;
      color: #1D4ED8;
    }

    .dropdown-arrow {
      width: 1em;
      height: 1em;
      margin-left: 0.5rem;
      transition: transform 0.2s ease-in-out;
    }

    .dropdown-menu-button.open .dropdown-arrow {
      transform: rotate(180deg);
    }

    .main-content-area {
      flex-grow: 1;
      padding: 0.75rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .table-container,
    .retirar-produtos-container,
    .gerenciar-cotacoes-portal-container {
      flex-grow: 1;
      overflow: auto;
      border: 1px solid #e2e8f0;
      border-radius: 0.5rem;
      background-color: white;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
      padding: 0.75rem;
      margin-bottom: 1rem;
    }

    .table-container.hidden,
    .retirar-produtos-container.hidden,
    .gerenciar-cotacoes-portal-container.hidden {
      display: none !important;
    }

    .sticky-header-table {
      width: 100%;
      border-collapse: collapse;
    }

    .sticky-header-table thead th {
      position: -webkit-sticky;
      position: sticky;
      top: 0;
      background-color: #1D4ED8 !important;
      color: white !important;
      padding: 0.5rem 1rem;
      text-align: left;
      font-size: 0.65rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 2px solid #1e3a8a;
      z-index: 10;
      border-left: 1px solid #425B9A;
    }

    .sticky-header-table thead th:first-child {
      border-left: none;
      border-top-left-radius: 0.375rem;
    }

    .sticky-header-table thead th:last-child {
      border-top-right-radius: 0.375rem;
    }

    .sticky-header-table tbody td {
      padding: 0.5rem 1rem;
      border-bottom: 1px solid #e2e8f0;
      font-size: 0.775rem;
      color: #334155;
      white-space: nowrap;
      border-left: 1px solid #e2e8f0;
      cursor: default;
    }

    .sticky-header-table tbody td.editable-price-cell {
      cursor: cell;
      position: relative;
    }

    .sticky-header-table tbody td.editable-price-cell:hover::after {
      content: '✎';
      position: absolute;
      right: 5px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.7em;
      color: #666;
    }

    .sticky-header-table tbody td:first-child {
      border-left: none;
    }

    .sticky-header-table thead th:first-child,
    .sticky-header-table tbody tr td:first-child {
      position: -webkit-sticky;
      position: sticky;
      left: 0;
      z-index: 3;
    }

    .sticky-header-table tbody tr td:first-child {
      background-color: inherit;
    }

    .sticky-header-table thead th:first-child {
      z-index: 11;
    }

    .categoria-accordion-header-row td:first-child {
      background-color: #e5e7eb;
    }

    .produto-group-separator-row td:first-child {
      background-color: #add8e6;
    }

    .sticky-header-table tbody tr:hover td:first-child {
      background-color: #dbeafe !important;
    }

    .sticky-header-table tbody tr:hover td {
      background-color: #dbeafe !important;
    }

    .categoria-accordion-header-row {
      background-color: #e5e7eb;
      cursor: pointer;
      font-weight: bold;
      color: #1f2937;
    }

    .categoria-accordion-header-row:hover {
      background-color: #d1d5db;
    }

    .categoria-accordion-header-row td {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #56badb;
    }

    .categoria-header-content {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .categoria-accordion-icon {
      transition: transform 0.2s ease-in-out;
      width: 1.25rem;
      height: 1.25rem;
      color: #4b5563;
    }

    .categoria-accordion-header-row.expanded .categoria-accordion-icon {
      transform: rotate(90deg);
    }

    .category-content-row.hidden,
    .sub-produto-row.hidden-by-etapa,
    .sub-produto-row.hidden-by-search {
      display: none !important;
    }

    .produto-group-separator-row.hidden-by-search,
    .categoria-accordion-header-row.hidden-by-search {
      display: none !important;
    }

    .produto-group-separator-row td {
      background-color: #dbeafe;
      padding: 0.6rem 1rem;
      font-weight: 600;
      color: #1e3a8a;
      border-bottom: 1px solid #93c5fd;
      white-space: normal;
    }

    .produto-group-separator-row td .contagem-container-principal {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }

    .produto-group-separator-row td .produto-principal-info {
      font-weight: 600;
      margin-right: 15px;
      white-space: nowrap;
    }

    .produto-group-separator-row td .contagem-fields-container {
      display: flex;
      align-items: center;
      flex-wrap: nowrap;
      gap: 15px;
    }

    .sub-produto-row {
      background-color: #F9FAFB;
    }

    .sub-produto-row td {
      padding-left: 1.75rem;
    }

    .sticky-header-table tbody td.bg-col-amarelo {
      background-color: #ffe599 !important;
    }

    .sticky-header-table tbody td.bg-col-laranja {
      background-color: #f9cb9c !important;
    }

    .sticky-header-table tbody td.bg-col-azul-cot {
      background-color: #9fc5e8 !important;
    }

    .sticky-header-table tbody td.bg-col-verde {
      background-color: #b6d7a8 !important;
    }

    .sticky-header-table tbody td.bg-col-vermelho-leve {
      background-color: #FECACA !important;
    }

    .sticky-header-table tbody td.bg-col-roxo-leve {
      background-color: #E9D5FF !important;
    }

    .feedback-message {
      padding: 0.75rem 1.25rem;
      margin-bottom: 1rem;
      border-radius: 0.375rem;
      font-size: 0.875rem;
    }

    .feedback-message.hidden {
      display: none;
    }

    .feedback-success {
      background-color: #D1FAE5;
      color: #065F46;
      border: 1px solid #6EE7B7;
    }

    .feedback-error {
      background-color: #FEE2E2;
      color: #991B1B;
      border: 1px solid #FCA5A5;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(230, 230, 230, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .loading-overlay.hidden {
      display: none;
    }

    .loading-overlay .global-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #D1D5DB;
      border-top-color: #1D4ED8;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .info-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: #1e3a8a;
      background-color: #eef2ff;
      border-radius: 0.375rem;
      border: 1px solid #dbeafe;
      gap: 0.375rem;
    }

    .info-badge.clickable {
      cursor: pointer;
      background-color: #2563eb;
      color: white;
      border-color: #1d4ed8;
    }

    .info-badge.clickable:hover {
      background-color: #1d4ed8;
    }

    /* Outros Estilos (Modais, etc...) */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background-color: white;
      padding: 1.5rem;
      border-radius: 0.5rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 1rem;
      margin-bottom: 1rem;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: #1f2937;
    }

    .modal-close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #6b7280;
    }

    .modal-body .form-group {
      margin-bottom: 1.25rem;
    }

    .modal-body .form-group label {
      display: block;
      font-weight: 500;
      color: #374151;
      margin-bottom: 0.5rem;
    }

    .modal-body select,
    .modal-body input[type="text"],
    .modal-body input[type="number"],
    .modal-body textarea {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      box-sizing: border-box;
    }

    .modal-body .checkbox-group {
      max-height: 150px;
      overflow-y: auto;
      border: 1px solid #d1d5db;
      padding: 0.75rem;
      border-radius: 0.375rem;
      background-color: #f9fafb;
    }

    .modal-footer {
      border-top: 1px solid #e5e7eb;
      padding-top: 1rem;
      margin-top: 1.5rem;
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
    }

    .btn-painel-acao {
      font-size: 0.875rem;
      font-weight: 600;
      padding: 0.5rem 0.75rem;
      border-radius: 0.375rem;
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.375rem;
      color: white;
      min-width: 100px;
      border: none;
    }

    .btn-modal-primary {
      background-color: #2563eb;
    }

    .btn-modal-primary:hover {
      background-color: #1d4ed8;
    }

    .btn-modal-secondary {
      background-color: #e5e7eb;
      color: #374151;
      border: 1px solid #d1d5db;
    }

    .btn-modal-secondary:hover {
      background-color: #d1d5db;
    }

    .CotacoesScript_secaoOpcoesCriacao {
      display: none;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px dashed #d1d5db;
    }

    .CotacoesScript_secaoOpcoesCriacao.active {
      display: block;
    }

    .sidebar-oportunidades {
      position: fixed;
      top: 0;
      right: 0;
      width: 400px;
      max-width: 90vw;
      height: 100%;
      background-color: #1D4ED8;
      color: white;
      box-shadow: -4px 0 15px rgba(0, 0, 0, 0.2);
      z-index: 1500;
      transform: translateX(100%);
      transition: transform 0.3s ease-in-out;
      display: flex;
      flex-direction: column;
    }

    .sidebar-oportunidades.active {
      transform: translateX(0);
    }

    .sidebar-oportunidades-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1.25rem;
      background-color: #1e40af;
      flex-shrink: 0;
    }

    .sidebar-oportunidades-title {
      font-size: 1.125rem;
      font-weight: 600;
      margin: 0;
    }

    .sidebar-oportunidades-close-btn {
      background: none;
      border: none;
      color: white;
      font-size: 1.75rem;
      cursor: pointer;
      opacity: 0.8;
      padding: 0;
      line-height: 1;
    }

    .sidebar-oportunidades-close-btn:hover {
      opacity: 1;
    }

    .sidebar-oportunidades-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.25rem;
      background-color: #2563eb;
      flex-shrink: 0;
    }

    .sidebar-oportunidades-controls label {
      font-size: 0.875rem;
      font-weight: 500;
    }

    .sidebar-oportunidades-sort-btn {
      padding: 0.375rem 0.75rem;
      border: 1px solid rgba(255, 255, 255, 0.5);
      background-color: transparent;
      color: white;
      border-radius: 0.375rem;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .sidebar-oportunidades-sort-btn:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .sidebar-oportunidades-sort-btn.active {
      background-color: white;
      color: #1D4ED8;
      font-weight: 600;
    }

    .sidebar-oportunidades-lista {
      flex-grow: 1;
      overflow-y: auto;
      padding: 0.75rem;
    }

    .sidebar-oportunidades-item {
      background-color: rgba(255, 255, 255, 0.08);
      border-radius: 0.375rem;
      padding: 0.75rem 1rem;
      margin-bottom: 0.5rem;
    }

    .sidebar-oportunidades-item-produto {
      font-weight: 600;
      color: #eff6ff;
      margin-bottom: 0.375rem;
      display: block;
    }

    .sidebar-oportunidades-item-metricas {
      display: flex;
      justify-content: space-between;
      font-size: 0.875rem;
      color: #dbeafe;
    }

    .sidebar-oportunidades-item-metricas strong {
      font-weight: 600;
      color: #ffffff;
    }

    .sidebar-oportunidades-empty-state {
      text-align: center;
      padding-top: 2rem;
      color: #dbeafe;
    }

    .custom-scrollbar::-webkit-scrollbar {
      width: 8px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: #1e40af;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background-color: #60a5fa;
      border-radius: 4px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background-color: #93c5fd;
    }

    body.sidebar-active .cotacao-individual-container {
      width: calc(100% - 400px);
      transition: width 0.3s ease-in-out;
    }

    .cotacao-individual-container {
      transition: width 0.3s ease-in-out;
    }

    .view-tabs-container {
      margin-bottom: 1rem;
      border-bottom: 1px solid #d1d5db;
      /* Linha cinza para o container de abas */
    }

    .view-tab-btn {
      padding: 0.75rem 0.5rem;
      border: none;
      background-color: transparent;
      color: #374151;
      font-weight: 500;
      cursor: pointer;
      margin-bottom: -1px;
      border-bottom: 3px solid transparent;
    }

    .view-tab-btn.active {
      color: #1D4ED8;
      font-weight: 600;
      border-bottom-color: #1D4ED8;
    }

    .hidden-by-category {
      display: none;
    }
  </style>
</head>

<body>
  <div class="cotacao-individual-container">
    <div class="top-menu-bar">
      <div class="title-container">
        <div class="title" id="CotacaoIndividualScript_tituloPagina">
          Cotação ID: <span id="CotacaoIndividualScript_idCotacaoExibido">Carregando...</span>
        </div>
        <div id="CotacaoIndividualScript_dataAberturaExibida" class="data-abertura-info"></div>
      </div>

      <div class="actions">
        <div class="top-menu-search-container" id="CotacaoIndividualScript_searchContainer_Top">
          <input type="text" id="CotacaoIndividualScript_searchInput_Top" placeholder="Buscar na cotação...">
        </div>

        <button id="CotacaoIndividualScript_btnRecalcularUI" class="btn-menu-superior"
          title="Forçar recálculo de totais na tela"
          style="background-color: transparent; border: 1px solid #93c5fd; margin-right: 0.5rem;">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
            style="width: 1.25rem; height: 1.25rem;">
            <path fill-rule="evenodd"
              d="M15.312 11.424a5.5 5.5 0 01-9.205 4.013l-.56-1.12a3.5 3.5 0 005.88-2.553H9.5V10h6V4h-1.5v5.576a5.525 5.525 0 01-1.688 1.848zM4.688 8.576a5.5 5.5 0 019.205-4.013l.56 1.12A3.5 3.5 0 008.57 8.233H10.5V10H4.5V4h1.5v3.576a5.525 5.525 0 011.688-1.848z"
              clip-rule="evenodd" />
          </svg>
        </button>

        <div class="dropdown-menu">
          <button id="CotacaoIndividualScript_menuEtapasBtn" class="btn-menu-superior dropdown-menu-button">Etapas <svg
              class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd"
                d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.29a.75.75 0 01.02-1.06z"
                clip-rule="evenodd" />
            </svg></button>
          <div id="CotacaoIndividualScript_menuEtapasDropdown" class="dropdown-menu-content">
            <a href="#" data-action="etapa_contagem_estoque">1. Contagem de Estoque</a>
            <a href="#" data-action="etapa_retirar_produtos">2. Retirar Produtos Desnecessários</a>
            <a href="#" data-action="etapa_enviar_fornecedores">3. Enviar para Fornecedores</a>
            <a href="#" data-action="etapa_realizar_cotacao">4. Realizar Cotação</a>
            <a href="#" data-action="etapa_definir_empresa">5. Definir Empresa para Faturamento</a>
            <a href="#" data-action="etapa_definir_condicoes_pagamento">6. Definir Condições de Pagamento</a>
            <a href="#" data-action="etapa_imprimir_pedidos">7. Imprimir Pedidos</a>
          </div>
        </div>
        <div class="dropdown-menu">
          <button id="CotacaoIndividualScript_menuRelatoriosBtn"
            class="btn-menu-superior dropdown-menu-button">Relatórios <svg class="dropdown-arrow"
              xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd"
                d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.29a.75.75 0 01.02-1.06z"
                clip-rule="evenodd" />
            </svg></button>
          <div id="CotacaoIndividualScript_menuRelatoriosDropdown" class="dropdown-menu-content">
            <a href="#" data-action="relatorio_analise_compra">Análise de Compra</a>
          </div>
        </div>
        <div class="dropdown-menu">
          <button id="CotacaoIndividualScript_menuFuncoesBtn" class="btn-menu-superior dropdown-menu-button">Funções
            <svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd"
                d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.29a.75.75 0 01.02-1.06z"
                clip-rule="evenodd" />
            </svg></button>
          <div id="CotacaoIndividualScript_menuFuncoesDropdown" class="dropdown-menu-content">
            <a href="#" data-action="funcao_acrescentar_itens">Acrescentar Itens</a>
            <a href="#" data-action="funcao_melhores_oportunidades">Melhores Oportunidades</a>
            <a href="#" data-action="funcao_preencher_precos">Preencher com Últimos Preços</a>
          </div>
        </div>
      </div>
    </div>

    <div class="main-content-area">
      <div class="view-tabs-container">
        <button id="CotacaoIndividualScript_btnAbaCategoria" class="view-tab-btn active">Visualizar por
          Categoria</button>
      </div>
      <div id="CotacaoIndividualScript_mensagemFeedback" class="feedback-message hidden"></div>
      <div class="table-container" id="CotacaoIndividualScript_tableContainer">
        <table class="sticky-header-table" id="CotacaoIndividualScript_tabelaProdutosCotacao">
          <thead>
            <tr>
              <th>Carregando Cabeçalhos...</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td id="CotacaoIndividualScript_tabelaLoadingMsg" colspan="1" class="text-center p-8 text-gray-500">
                <div class="flex justify-center items-center">
                  <svg class="custom-spinner" viewBox="0 0 50 50" style="width: 32px; height: 32px;">
                    <circle cx="25" cy="25" r="20" fill="none" stroke="#D1D5DB" stroke-width="5"></circle>
                    <circle cx="25" cy="25" r="20" fill="none" stroke="#1D4ED8" stroke-width="5" stroke-linecap="round"
                      stroke-dasharray="31.41592653589793, 125.66370614359172" stroke-dashoffset="0">
                      <animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s"
                        values="0 25 25;360 25 25" keyTimes="0;1"></animateTransform>
                    </circle>
                  </svg>
                  <span class="ml-3 text-gray-700">Carregando dados da cotação...</span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div id="CotacaoIndividualScript_pageLoadingOverlay" class="loading-overlay hidden">
      <div style="display: flex; flex-direction: column; align-items: center;">
        <div class="global-spinner"></div>
        <span class="mt-3 text-blue-700 font-semibold text-lg loading-message-text">Processando...</span>
      </div>
    </div>
  </div>

  <div id="CotacaoIndividualScript_modalAcrescentarItensOverlay" class="modal-overlay">
  </div>

  <div id="CotacaoIndividualScript_modalNegociacaoOverlay" class="modal-overlay">
    <div class="modal-content custom-scrollbar" role="dialog" aria-modal="true"
      aria-labelledby="CotacaoIndividualScript_modalNegociacao_titulo">
      <div class="modal-header">
        <h3 id="CotacaoIndividualScript_modalNegociacao_titulo" class="modal-title">Negociação</h3>
        <button id="CotacaoIndividualScript_btnFecharModalNegociacao" class="modal-close-btn"
          aria-label="Fechar">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="CotacaoIndividualScript_selectSubproduto">Subproduto base (normalmente o menor preço)</label>
          <select id="CotacaoIndividualScript_selectSubproduto"></select>
          <div id="CotacaoIndividualScript_infoSubproduto" style="margin-top:6px;color:#6b7280;font-size:0.85rem;">
          </div>
        </div>
        <div class="form-group" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div>
            <label for="CotacaoIndividualScript_inputPercentual">Desconto sobre o preço base (%)</label>
            <input id="CotacaoIndividualScript_inputPercentual" type="number" step="0.01" min="0" value="2">
          </div>
          <div>
            <label for="CotacaoIndividualScript_inputPrecoNovo">Novo preço (automático)</label>
            <input id="CotacaoIndividualScript_inputPrecoNovo" type="text" readonly>
          </div>
        </div>
        <div class="form-group">
          <label for="CotacaoIndividualScript_textareaMensagem">Mensagem para enviar aos fornecedores</label>
          <textarea id="CotacaoIndividualScript_textareaMensagem" rows="5"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button id="CotacaoIndividualScript_btnCancelarModalNegociacao"
          class="btn-painel-acao btn-modal-secondary">Cancelar</button>
        <button id="CotacaoIndividualScript_btnCopiarTextoNegociacao" class="btn-painel-acao btn-modal-primary">Copiar
          Texto</button>
      </div>
    </div>
  </div>

  <div id="FuncoesScript_sidebarOportunidades" class="sidebar-oportunidades">
  </div>

  <script>
    (function initCotacaoIndividualScript() {
      //####################################################################################################
      // MÓDULO: COTACAO INDIVIDUAL (CLIENT-SIDE)
      //####################################################################################################

      //----------------------------------------------------------------------------------------------------
      // DECLARAÇÕES GLOBAIS
      //----------------------------------------------------------------------------------------------------
      const CotacaoIndividualScript_ID_SEARCH_INPUT_TOP = 'CotacaoIndividualScript_searchInput_Top';
      const CotacaoIndividualScript_ID_COTACAO_EXIBIDO = 'CotacaoIndividualScript_idCotacaoExibido';
      const CotacaoIndividualScript_ID_DATA_ABERTURA_EXIBIDA = 'CotacaoIndividualScript_dataAberturaExibida';
      const CotacaoIndividualScript_ID_MENSAGEM_FEEDBACK = 'CotacaoIndividualScript_mensagemFeedback';
      const CotacaoIndividualScript_ID_TABELA_PRODUTOS_COTACAO = 'CotacaoIndividualScript_tabelaProdutosCotacao';
      const CotacaoIndividualScript_ID_PAGE_LOADING_OVERLAY = 'CotacaoIndividualScript_pageLoadingOverlay';

      let CotacaoIndividualScript_cotacaoIdAtual = null;
      let CotacaoIndividualScript_cabecalhosVisiveis = [];
      let CotacaoIndividualScript_dadosOriginaisCotacao = [];

      const CotacaoIndividualScript_COLUNAS_A_EXIBIR_PADRAO = [
        "SubProduto", "Fornecedor", "Tamanho", "UN", "Fator",
        "Preço", "Preço por Fator", "Comprar", "Valor Total"
      ];
      const CotacaoIndividualScript_MAPA_CORES_COLUNAS = {
        "SubProduto": "bg-col-amarelo", "Categoria": "bg-col-amarelo", "Fornecedor": "bg-col-amarelo",
        "Tamanho": "bg-col-laranja", "UN": "bg-col-laranja", "Fator": "bg-col-laranja",
        "Preço": "bg-col-azul-cot", "Preço por Fator": "bg-col-azul-cot",
        "Comprar": "bg-col-verde", "Valor Total": "bg-col-verde", "Economia em Cotação": "bg-col-verde",
        "Empresa Faturada": "bg-col-roxo-leve", "Condição de Pagamento": "bg-col-roxo-leve"
      };

      /**
       * Função central para fazer chamadas à API do Firebase Functions.
       */
      async function cotacaoindividual_callApi(endpoint, method = 'POST', body = null) {
        try {
          const options = {
            method,
            headers: { 'Content-Type': 'application/json' },
          };
          if (body) {
            options.body = JSON.stringify(body);
          }
          const response = await fetch(`/api/${endpoint}`, options);
          if (!response.ok) {
            const errorData = await response.json().catch(() => ({ message: response.statusText }));
            throw new Error(errorData.message || 'Erro de comunicação com o servidor.');
          }
          if (response.status === 204) {
            return { success: true };
          }
          return await response.json();
        } catch (error) {
          console.error(`Erro na API [${endpoint}]:`, error);
          return { success: false, message: error.message };
        }
      }

      //----------------------------------------------------------------------------------------------------
      // FUNÇÕES UTILITÁRIAS
      //----------------------------------------------------------------------------------------------------
      function cotacaoindividual_parseNumeroPtBr(valor) {
        if (valor === null || valor === undefined) return NaN;
        if (typeof valor === 'number') return Number(valor);
        const s = String(valor).trim();
        if (!s) return NaN;
        const normalizado = s.replace(/\s+/g, '').replace(/\.(?=\d{3}(?:,|\.|$))/g, '').replace(',', '.');
        const n = Number(normalizado);
        return Number.isFinite(n) ? n : NaN;
      }

      function cotacaoindividual_formatarPreco(n) {
        const v = Number(n || 0);
        return v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }

      function cotacaoindividual_mostrarLoadingOverlay(mostrar = true, mensagem = "Processando...") {
        const overlay = document.getElementById(CotacaoIndividualScript_ID_PAGE_LOADING_OVERLAY);
        if (overlay) {
          overlay.classList.toggle('hidden', !mostrar);
          const msgElement = overlay.querySelector('.loading-message-text');
          if (msgElement) msgElement.textContent = mensagem;
        }
      }

      function cotacaoindividual_exibirFeedback(mensagem, isError = false, duracao = 5000) {
        const feedbackDiv = document.getElementById(CotacaoIndividualScript_ID_MENSAGEM_FEEDBACK);
        if (feedbackDiv) {
          feedbackDiv.textContent = mensagem;
          feedbackDiv.className = `feedback-message ${isError ? 'feedback-error' : 'feedback-success'}`;
          feedbackDiv.classList.remove('hidden');
          if (duracao > 0) {
            setTimeout(() => {
              if (feedbackDiv.textContent === mensagem) {
                feedbackDiv.classList.add('hidden');
                feedbackDiv.textContent = '';
              }
            }, duracao);
          }
        }
      }

      //----------------------------------------------------------------------------------------------------
      // LÓGICA DE EDIÇÃO INLINE, CÁLCULOS E RENDERIZAÇÃO
      //----------------------------------------------------------------------------------------------------

      async function cotacaoindividual_salvarEdicaoInline(element) {
        const td = element.parentElement;
        let novoValorStr = element.value;
        const valorOriginalStr = td.dataset.valorOriginal || '';
        const coluna = td.dataset.coluna;
        const camposNumericos = ["Fator", "Preço", "Comprar"];

        if (camposNumericos.includes(coluna)) {
          novoValorStr = String(novoValorStr).replace(',', '.');
        }

        const valorOriginalComparacao = String(valorOriginalStr).replace(/\./g, '').replace(',', '.');
        if (novoValorStr === valorOriginalComparacao) {
          td.textContent = valorOriginalStr;
          return;
        }

        const tr = td.closest('tr');
        const identificadores = {
          Produto: tr.dataset.produto,
          SubProdutoChave: tr.dataset.subprodutoOriginalPersistido,
          Fornecedor: tr.dataset.fornecedor
        };

        td.textContent = 'Salvando...';

        const response = await cotacaoindividual_callApi('cotacaoindividual/salvar-celula', 'POST', {
          idCotacao: CotacaoIndividualScript_cotacaoIdAtual,
          identificadoresLinha: identificadores,
          colunaAlterada: coluna,
          novoValor: novoValorStr
        });

        if (response && response.success) {
          const itemOriginal = CotacaoIndividualScript_dadosOriginaisCotacao.find(item =>
            item.Produto === identificadores.Produto &&
            item._subProdutoOriginalPersistido === identificadores.SubProdutoChave &&
            item.Fornecedor === identificadores.Fornecedor
          );

          if (itemOriginal) {
            itemOriginal[coluna] = cotacaoindividual_parseNumeroPtBr(novoValorStr);
          }

          if (response.novoSubProdutoNomeSeAlterado) {
            tr.dataset.subprodutoOriginalPersistido = response.novoSubProdutoNomeSeAlterado;
            if (itemOriginal) itemOriginal._subProdutoOriginalPersistido = response.novoSubProdutoNomeSeAlterado;
          }

          let valorDisplay = novoValorStr;
          if (camposNumericos.includes(coluna)) {
            const num = cotacaoindividual_parseNumeroPtBr(novoValorStr);
            if (!isNaN(num)) {
              valorDisplay = num.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 4 });
            }
          }
          td.textContent = valorDisplay;
          td.dataset.valorOriginal = valorDisplay;

        } else {
          cotacaoindividual_exibirFeedback(response.message || 'Falha ao salvar.', true);
          td.textContent = valorOriginalStr;
        }
      }

      function cotacaoindividual_renderizarCabecalhoTabela() {
        const tabela = document.getElementById(CotacaoIndividualScript_ID_TABELA_PRODUTOS_COTACAO);
        if (!tabela) return;
        const thead = tabela.querySelector('thead');
        thead.innerHTML = '';

        const tr = thead.insertRow();
        CotacaoIndividualScript_cabecalhosVisiveis.forEach(textoCabecalho => {
          const th = document.createElement('th');
          th.textContent = textoCabecalho;
          tr.appendChild(th);
        });
      }

      function cotacaoindividual_agruparEClassificarProdutos(todosOsItens) {
        if (!todosOsItens || todosOsItens.length === 0) {
          return [];
        }

        const porCategoria = todosOsItens.reduce((acc, item) => {
          const categoria = item.Categoria || 'Sem Categoria';
          if (!acc[categoria]) {
            acc[categoria] = [];
          }
          acc[categoria].push(item);
          return acc;
        }, {});

        const resultadoFinal = Object.keys(porCategoria).sort().map(nomeCategoria => {
          const itensDaCategoria = porCategoria[nomeCategoria];
          const porProduto = itensDaCategoria.reduce((acc, item) => {
            const produto = item.Produto || 'Produto Desconhecido';
            if (!acc[produto]) {
              acc[produto] = {
                nome: produto,
                estoqueMinimo: item.EstoqueMinimoProdutoPrincipal,
                demandaMedia: item.DemandaMediaProdutoPrincipal,
                subProdutos: []
              };
            }
            acc[produto].subProdutos.push(item);
            return acc;
          }, {});

          return {
            nome: nomeCategoria,
            produtos: Object.values(porProduto).sort((a, b) => a.nome.localeCompare(b.nome))
          };
        });

        return resultadoFinal;
      }

      // --- FUNÇÃO CORRIGIDA ---
      function cotacaoindividual_renderizarGruposDeProdutos(gruposDeProdutos) {
        const tabela = document.getElementById(CotacaoIndividualScript_ID_TABELA_PRODUTOS_COTACAO);
        if (!tabela) return;
        const tbody = tabela.querySelector('tbody');
        tbody.innerHTML = '';

        if (!gruposDeProdutos || gruposDeProdutos.length === 0) {
          const tr = tbody.insertRow();
          const td = tr.insertCell();
          td.colSpan = CotacaoIndividualScript_cabecalhosVisiveis.length || 1;
          td.className = 'text-center p-8 text-gray-500';
          td.textContent = 'Nenhum produto para esta cotação.';
          return;
        }

        // Agrupa os dados por categoria
        const agrupadoPorCategoria = gruposDeProdutos.reduce((acc, produto) => {
          const categoria = (produto.itens && produto.itens[0]?.Categoria) ? produto.itens[0].Categoria : 'Sem Categoria';
          if (!acc[categoria]) {
            acc[categoria] = [];
          }
          acc[categoria].push(produto);
          return acc;
        }, {});

        const categoriasOrdenadas = Object.keys(agrupadoPorCategoria).sort();

        categoriasOrdenadas.forEach(nomeCategoria => {
          const categoriaRow = tbody.insertRow();
          categoriaRow.className = 'categoria-accordion-header-row expanded';
          const categoriaCell = categoriaRow.insertCell();
          categoriaCell.colSpan = CotacaoIndividualScript_cabecalhosVisiveis.length;
          categoriaCell.innerHTML = `
            <div class="categoria-header-content">
                <svg class="categoria-accordion-icon" style="transform: rotate(90deg);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                <span>${nomeCategoria}</span>
            </div>
        `;

          const contentRows = [];

          agrupadoPorCategoria[nomeCategoria].forEach(grupoProduto => {
            const produtoRow = tbody.insertRow();
            produtoRow.className = 'produto-group-separator-row';
            const produtoCell = produtoRow.insertCell();
            produtoCell.colSpan = CotacaoIndividualScript_cabecalhosVisiveis.length;
            produtoCell.innerHTML = `
                <div class="contagem-container-principal">
                    <span class="produto-principal-info">${grupoProduto.Produto}</span>
                </div>
            `;
            contentRows.push(produtoRow);

            if (grupoProduto.itens && Array.isArray(grupoProduto.itens)) {
              grupoProduto.itens.forEach(item => {
                const subProdutoRow = tbody.insertRow();
                subProdutoRow.className = 'sub-produto-row';
                subProdutoRow.dataset.produto = item.Produto;
                subProdutoRow.dataset.fornecedor = item.Fornecedor;
                subProdutoRow.dataset.subprodutoOriginalPersistido = item._subProdutoOriginalPersistido;

                CotacaoIndividualScript_cabecalhosVisiveis.forEach(cabecalho => {
                  const td = subProdutoRow.insertCell();
                  let valor = item[cabecalho];
                  if (valor === undefined || valor === null) valor = '';

                  // Formatação especial para colunas numéricas
                  if (['Preço', 'Preço por Fator', 'Valor Total'].includes(cabecalho)) {
                    td.textContent = cotacaoindividual_formatarPreco(valor);
                  } else if (['Fator', 'Comprar'].includes(cabecalho)) {
                    const num = cotacaoindividual_parseNumeroPtBr(valor);
                    td.textContent = !isNaN(num) ? num.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 4 }) : '';
                  } else {
                    td.textContent = valor;
                  }

                  // Aplica cores de fundo
                  if (CotacaoIndividualScript_MAPA_CORES_COLUNAS[cabecalho]) {
                    td.classList.add(CotacaoIndividualScript_MAPA_CORES_COLUNAS[cabecalho]);
                  }
                });
                contentRows.push(subProdutoRow);
              });
            }
          });

          // CORREÇÃO: Lógica do acordeão para recolher/expandir
          categoriaRow.addEventListener('click', () => {
            const isExpanded = categoriaRow.classList.toggle('expanded');
            const icon = categoriaRow.querySelector('.categoria-accordion-icon');
            if (icon) {
              icon.style.transform = isExpanded ? 'rotate(90deg)' : 'rotate(0deg)';
            }
            contentRows.forEach(row => {
              row.classList.toggle('hidden-by-category', !isExpanded);
            });
          });
        });
      }

      async function cotacaoindividual_carregarDadosCotacao(idCotacao) {
        cotacaoindividual_mostrarLoadingOverlay(true, 'Carregando dados da cotação...');

        const resposta = await cotacaoindividual_callApi('cotacaoindividual/detalhes', 'POST', { idCotacao });

        cotacaoindividual_mostrarLoadingOverlay(false);

        if (resposta && resposta.success) {
          // Os dados já vêm agrupados por produto.
          CotacaoIndividualScript_dadosOriginaisCotacao = resposta.dados || [];
          CotacaoIndividualScript_cabecalhosVisiveis = resposta.cabecalhos || CotacaoIndividualScript_COLUNAS_A_EXIBIR_PADRAO;

          cotacaoindividual_renderizarCabecalhoTabela();
          // A função de renderização agora recebe diretamente os dados da API.
          cotacaoindividual_renderizarGruposDeProdutos(CotacaoIndividualScript_dadosOriginaisCotacao);

          // Exibe a data de abertura recebida da API
          const dataAberturaContainer = document.getElementById(CotacaoIndividualScript_ID_DATA_ABERTURA_EXIBIDA);
          if (dataAberturaContainer && resposta.dataAbertura) {
            const dataObj = new Date(resposta.dataAbertura);
            dataAberturaContainer.textContent = `Data de Abertura: ${dataObj.toLocaleDateString('pt-BR')}`;
          }
        } else {
          const msgErro = resposta.message || "Falha ao carregar dados da cotação.";
          cotacaoindividual_exibirFeedback(msgErro, true);
          const tbody = document.getElementById(CotacaoIndividualScript_ID_TABELA_PRODUTOS_COTACAO)?.querySelector('tbody');
          if (tbody) tbody.innerHTML = `<tr><td colspan="${CotacaoIndividualScript_cabecalhosVisiveis.length || 1}" class="text-center p-8 text-red-500">${msgErro}</td></tr>`;
        }
      }

      //----------------------------------------------------------------------------------------------------
      // INICIALIZAÇÃO
      //----------------------------------------------------------------------------------------------------

      function cotacaoindividual_obterParametros() {
        const params = new URLSearchParams(window.location.search);
        const idCotacao = params.get('idCotacao');
        return { idCotacao };
      }

      async function inicializarPagina() {
        console.log("CotacaoIndividualScript: Iniciando para Firebase...");

        const params = cotacaoindividual_obterParametros();
        CotacaoIndividualScript_cotacaoIdAtual = params.idCotacao;

        const spanIdCotacao = document.getElementById(CotacaoIndividualScript_ID_COTACAO_EXIBIDO);

        if (CotacaoIndividualScript_cotacaoIdAtual) {
          if (spanIdCotacao) spanIdCotacao.textContent = CotacaoIndividualScript_cotacaoIdAtual;
          document.title = `Cotação: ${CotacaoIndividualScript_cotacaoIdAtual}`;
          await cotacaoindividual_carregarDadosCotacao(CotacaoIndividualScript_cotacaoIdAtual);
        } else {
          if (spanIdCotacao) spanIdCotacao.textContent = "Inválida";
          document.title = "Cotação Inválida - CotaçãoPRO";
          cotacaoindividual_exibirFeedback("ID da Cotação não fornecido.", true, 0);
          const tbody = document.getElementById(CotacaoIndividualScript_ID_TABELA_PRODUTOS_COTACAO)?.querySelector('tbody');
          if (tbody) tbody.innerHTML = `<tr><td colspan="1" class="text-center p-8 text-red-500">ID da Cotação não fornecido na URL.</td></tr>`;
        }
      }

      document.addEventListener('DOMContentLoaded', inicializarPagina);

    })();
  </script>

</body>

</html>