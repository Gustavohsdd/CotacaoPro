<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detalhes da Cotação</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
      background-color: #f4f7f6;
      overflow-x: hidden;
    }

    .cotacao-individual-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
    }

    .top-menu-bar {
      background-color: #1D4ED8;
      color: white;
      padding: 0.75rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      flex-shrink: 0;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .title-container {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      margin-right: auto;
    }

    .top-menu-bar .title {
      font-size: 1.25rem;
      font-weight: 600;
    }

    .data-abertura-info {
      font-size: 0.8rem;
      color: #e0e0e0;
      margin-top: 0.15rem;
    }

    .top-menu-bar .actions {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .top-menu-search-container {
      display: flex;
      align-items: center;
      background-color: rgba(255, 255, 255, 0.15);
      padding: 0.25rem 0.5rem;
      border-radius: 0.375rem;
      min-width: 200px;
      flex-grow: 1;
      max-width: 350px;
      margin-right: 1rem;
    }

    .top-menu-search-container input[type="text"] {
      width: 100%;
      padding: 0.4rem 0.6rem;
      border: 1px solid transparent;
      border-radius: 0.25rem;
      font-size: 0.875rem;
      background-color: transparent;
      color: white;
      box-shadow: none;
    }

    .top-menu-search-container input[type="text"]::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }

    .top-menu-search-container input[type="text"]:focus {
      outline: none;
      background-color: rgba(255, 255, 255, 0.25);
      border-color: rgba(255, 255, 255, 0.5);
    }

    .btn-menu-superior {
      font-size: 0.875rem;
      font-weight: 500;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      transition: background-color 0.15s ease-in-out;
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      color: white;
      border: 1px solid transparent;
      cursor: pointer;
    }

    .btn-menu-superior:hover {
      opacity: 0.9;
    }

    .btn-menu-salvar {
      background-color: #16a34a;
    }

    .btn-menu-salvar:hover {
      background-color: #15803d;
    }

    .btn-menu-superior svg {
      width: 1rem;
      height: 1rem;
    }

    .dropdown-menu {
      position: relative;
      display: inline-block;
    }

    .dropdown-menu-button {
      background-color: #235fc2;
    }

    .dropdown-menu-button:hover {
      background-color: #1a3561;
    }

    .dropdown-menu-content {
      display: none;
      position: absolute;
      background-color: white;
      min-width: 250px;
      box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
      z-index: 1050;
      border-radius: 0.375rem;
      right: 0;
      border: 1px solid #e2e8f0;
      margin-top: 0.25rem;
    }

    .dropdown-menu-content.show {
      display: block;
    }

    .dropdown-menu-content a {
      color: #1f2937;
      padding: 0.75rem 1rem;
      text-decoration: none;
      display: block;
      font-size: 0.875rem;
      border-bottom: 1px solid #e2e8f0;
    }

    .dropdown-menu-content a:last-child {
      border-bottom: none;
    }

    .dropdown-menu-content a:hover {
      background-color: #f4f7f6;
      color: #1D4ED8;
    }

    .dropdown-arrow {
      width: 1em;
      height: 1em;
      margin-left: 0.5rem;
      transition: transform 0.2s ease-in-out;
    }

    .dropdown-menu-button.open .dropdown-arrow {
      transform: rotate(180deg);
    }

    .main-content-area {
      flex-grow: 1;
      padding: 0.75rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .table-container,
    .retirar-produtos-container,
    .gerenciar-cotacoes-portal-container {
      flex-grow: 1;
      overflow: auto;
      border: 1px solid #e2e8f0;
      border-radius: 0.5rem;
      background-color: white;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
      padding: 0.75rem;
      margin-bottom: 1rem;
    }

    .table-container.hidden,
    .retirar-produtos-container.hidden,
    .gerenciar-cotacoes-portal-container.hidden {
      display: none !important;
    }

    .sticky-header-table {
      width: 100%;
      border-collapse: collapse;
    }

    .sticky-header-table thead th {
      position: -webkit-sticky;
      position: sticky;
      top: 0;
      background-color: #1D4ED8 !important;
      color: white !important;
      padding: 0.5rem 1rem;
      text-align: left;
      font-size: 0.65rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 2px solid #1e3a8a;
      z-index: 10;
      border-left: 1px solid #425B9A;
    }

    .sticky-header-table thead th:first-child {
      border-left: none;
      border-top-left-radius: 0.375rem;
    }

    .sticky-header-table thead th:last-child {
      border-top-right-radius: 0.375rem;
    }

    .sticky-header-table tbody td {
      padding: 0.5rem 1rem;
      border-bottom: 1px solid #e2e8f0;
      font-size: 0.775rem;
      color: #334155;
      white-space: nowrap;
      border-left: 1px solid #e2e8f0;
      cursor: default;
    }

    .sticky-header-table tbody td.editable-price-cell {
      cursor: cell;
      position: relative;
    }

    .sticky-header-table tbody td.editable-price-cell:hover::after {
      content: '✎';
      position: absolute;
      right: 5px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.7em;
      color: #666;
    }

    .sticky-header-table tbody td:first-child {
      border-left: none;
    }

    .sticky-header-table thead th:first-child,
    .sticky-header-table tbody tr td:first-child {
      position: -webkit-sticky;
      position: sticky;
      left: 0;
      z-index: 3;
    }

    .sticky-header-table tbody tr td:first-child {
      background-color: inherit;
    }

    .sticky-header-table thead th:first-child {
      z-index: 11;
    }

    .categoria-accordion-header-row td:first-child {
      background-color: #e5e7eb;
    }

    .produto-group-separator-row td:first-child {
      background-color: #add8e6;
    }

    .sticky-header-table tbody tr:hover td:first-child {
      background-color: #dbeafe !important;
    }

    .sticky-header-table tbody tr:hover td {
      background-color: #dbeafe !important;
    }

    .categoria-accordion-header-row {
      background-color: #e5e7eb;
      cursor: pointer;
      font-weight: bold;
      color: #1f2937;
    }

    .categoria-accordion-header-row:hover {
      background-color: #d1d5db;
    }

    .categoria-accordion-header-row td {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #56badb;
    }

    .categoria-header-content {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .categoria-accordion-icon {
      transition: transform 0.2s ease-in-out;
      width: 1.25rem;
      height: 1.25rem;
      color: #4b5563;
    }

    .categoria-accordion-header-row.expanded .categoria-accordion-icon {
      transform: rotate(90deg);
    }

    .category-content-row.hidden,
    .sub-produto-row.hidden-by-etapa,
    .sub-produto-row.hidden-by-search {
      display: none !important;
    }

    .produto-group-separator-row.hidden-by-search,
    .categoria-accordion-header-row.hidden-by-search {
      display: none !important;
    }

    .produto-group-separator-row td {
      background-color: #b3d0f3;
      padding: 0.6rem 1rem;
      font-weight: 600;
      color: #1e3a8a;
      border-bottom: 1px solid #6babf3;
      white-space: normal;
    }

    .produto-group-separator-row td .contagem-container-principal {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }

    .produto-group-separator-row td .produto-principal-info {
      font-weight: 600;
      margin-right: 15px;
      white-space: nowrap;
    }

    .produto-group-separator-row td .contagem-fields-container {
      display: flex;
      align-items: left;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: flex-end;
    }

    .sub-produto-row {
      background-color: #F9FAFB;
    }

    .sub-produto-row td {
      padding-left: 1.75rem;
    }

    .sticky-header-table tbody td.bg-col-amarelo {
      background-color: #ffe599 !important;
    }

    .sticky-header-table tbody td.bg-col-laranja {
      background-color: #f9cb9c !important;
    }

    .sticky-header-table tbody td.bg-col-azul-cot {
      background-color: #9fc5e8 !important;
    }

    .sticky-header-table tbody td.bg-col-verde {
      background-color: #b6d7a8 !important;
    }

    .sticky-header-table tbody td.bg-col-vermelho-leve {
      background-color: #FECACA !important;
    }

    .sticky-header-table tbody td.bg-col-roxo-leve {
      background-color: #E9D5FF !important;
    }

    .feedback-message {
      padding: 0.75rem 1.25rem;
      margin-bottom: 1rem;
      border-radius: 0.375rem;
      font-size: 0.875rem;
    }

    .feedback-message.hidden {
      display: none;
    }

    .feedback-success {
      background-color: #D1FAE5;
      color: #065F46;
      border: 1px solid #6EE7B7;
    }

    .feedback-error {
      background-color: #FEE2E2;
      color: #991B1B;
      border: 1px solid #FCA5A5;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(230, 230, 230, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .loading-overlay.hidden {
      display: none;
    }

    .loading-overlay .global-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #D1D5DB;
      border-top-color: #1D4ED8;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .info-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: #1e3a8a;
      background-color: #eef2ff;
      border-radius: 0.375rem;
      border: 1px solid #dbeafe;
      gap: 0.375rem;
    }

    .info-badge.clickable {
      cursor: pointer;
      background-color: #2563eb;
      color: white;
      border-color: #1d4ed8;
    }

    .info-badge.clickable:hover {
      background-color: #1d4ed8;
    }

    /* Outros Estilos (Modais, etc...) */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background-color: white;
      padding: 1.5rem;
      border-radius: 0.5rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 1rem;
      margin-bottom: 1rem;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: #1f2937;
    }

    .modal-close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #6b7280;
    }

    .modal-body .form-group {
      margin-bottom: 1.25rem;
    }

    .modal-body .form-group label {
      display: block;
      font-weight: 500;
      color: #374151;
      margin-bottom: 0.5rem;
    }

    .modal-body select,
    .modal-body input[type="text"],
    .modal-body input[type="number"],
    .modal-body textarea {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      box-sizing: border-box;
    }

    .modal-body .checkbox-group {
      max-height: 150px;
      overflow-y: auto;
      border: 1px solid #d1d5db;
      padding: 0.75rem;
      border-radius: 0.375rem;
      background-color: #f9fafb;
    }

    .modal-footer {
      border-top: 1px solid #e5e7eb;
      padding-top: 1rem;
      margin-top: 1.5rem;
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
    }

    .btn-painel-acao {
      font-size: 0.875rem;
      font-weight: 600;
      padding: 0.5rem 0.75rem;
      border-radius: 0.375rem;
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.375rem;
      color: white;
      min-width: 100px;
      border: none;
    }

    .btn-modal-primary {
      background-color: #2563eb;
    }

    .btn-modal-primary:hover {
      background-color: #1d4ed8;
    }

    .btn-modal-secondary {
      background-color: #e5e7eb;
      color: #374151;
      border: 1px solid #d1d5db;
    }

    .btn-modal-secondary:hover {
      background-color: #d1d5db;
    }

    .CotacoesScript_secaoOpcoesCriacao {
      display: none;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px dashed #d1d5db;
    }

    .CotacoesScript_secaoOpcoesCriacao.active {
      display: block;
    }

    .sidebar-oportunidades {
      position: fixed;
      top: 0;
      right: 0;
      width: 400px;
      max-width: 90vw;
      height: 100%;
      background-color: #1D4ED8;
      color: white;
      box-shadow: -4px 0 15px rgba(0, 0, 0, 0.2);
      z-index: 1500;
      transform: translateX(100%);
      transition: transform 0.3s ease-in-out;
      display: flex;
      flex-direction: column;
    }

    .sidebar-oportunidades.active {
      transform: translateX(0);
    }

    .sidebar-oportunidades-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1.25rem;
      background-color: #1e40af;
      flex-shrink: 0;
    }

    .sidebar-oportunidades-title {
      font-size: 1.125rem;
      font-weight: 600;
      margin: 0;
    }

    .sidebar-oportunidades-close-btn {
      background: none;
      border: none;
      color: white;
      font-size: 1.75rem;
      cursor: pointer;
      opacity: 0.8;
      padding: 0;
      line-height: 1;
    }

    .sidebar-oportunidades-close-btn:hover {
      opacity: 1;
    }

    .sidebar-oportunidades-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.25rem;
      background-color: #2563eb;
      flex-shrink: 0;
    }

    .sidebar-oportunidades-controls label {
      font-size: 0.875rem;
      font-weight: 500;
    }

    .sidebar-oportunidades-sort-btn {
      padding: 0.375rem 0.75rem;
      border: 1px solid rgba(255, 255, 255, 0.5);
      background-color: transparent;
      color: white;
      border-radius: 0.375rem;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .sidebar-oportunidades-sort-btn:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .sidebar-oportunidades-sort-btn.active {
      background-color: white;
      color: #1D4ED8;
      font-weight: 600;
    }

    .sidebar-oportunidades-lista {
      flex-grow: 1;
      overflow-y: auto;
      padding: 0.75rem;
    }

    .sidebar-oportunidades-item {
      background-color: rgba(255, 255, 255, 0.08);
      border-radius: 0.375rem;
      padding: 0.75rem 1rem;
      margin-bottom: 0.5rem;
    }

    .sidebar-oportunidades-item-produto {
      font-weight: 600;
      color: #eff6ff;
      margin-bottom: 0.375rem;
      display: block;
    }

    .sidebar-oportunidades-item-metricas {
      display: flex;
      justify-content: space-between;
      font-size: 0.875rem;
      color: #dbeafe;
    }

    .sidebar-oportunidades-item-metricas strong {
      font-weight: 600;
      color: #ffffff;
    }

    .sidebar-oportunidades-empty-state {
      text-align: center;
      padding-top: 2rem;
      color: #dbeafe;
    }

    .custom-scrollbar::-webkit-scrollbar {
      width: 8px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: #1e40af;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background-color: #60a5fa;
      border-radius: 4px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background-color: #93c5fd;
    }

    body.sidebar-active .cotacao-individual-container {
      width: calc(100% - 400px);
      transition: width 0.3s ease-in-out;
    }

    .cotacao-individual-container {
      transition: width 0.3s ease-in-out;
    }

    .view-tabs-container {
      margin-bottom: 1rem;
      border-bottom: 1px solid #d1d5db;
      /* Linha cinza para o container de abas */
    }

    .view-tab-btn {
      padding: 0.75rem 0.5rem;
      border: none;
      background-color: transparent;
      color: #374151;
      font-weight: 500;
      cursor: pointer;
      margin-bottom: -1px;
      border-bottom: 3px solid transparent;
    }

    .view-tab-btn.active {
      color: #1D4ED8;
      font-weight: 600;
      border-bottom-color: #1D4ED8;
    }

    .hidden-by-category {
      display: none;
    }

    .produto-group-separator-row td .contagem-fields-container {
      display: flex;
      align-items: center;
      flex-wrap: nowrap;
      gap: 15px;
    }

    .produto-group-separator-row td .contagem-field-block {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .produto-group-separator-row td .campo-contagem-label {
      font-weight: normal;
      color: #1f2937;
      font-size: 0.8rem;
      white-space: nowrap;
    }

    .produto-group-separator-row td .campo-contagem-valor {
      font-weight: 600;
      color: #1D4ED8;
      /* Azul */
      font-size: 0.9rem;
      background-color: #eef2ff;
      padding: 0.2rem 0.5rem;
      border-radius: 0.25rem;
    }

    .produto-group-separator-row td .campo-contagem-valor.negativo {
      color: #991B1B;
      /* Vermelho */
      background-color: #FEE2E2;
    }
  </style>
</head>

<body>
  <div class="cotacao-individual-container">
    <div class="top-menu-bar">
      <div class="title-container">
        <div class="title" id="CotacaoIndividualScript_tituloPagina">
          Cotação ID: <span id="CotacaoIndividualScript_idCotacaoExibido">Carregando...</span>
        </div>
        <div id="CotacaoIndividualScript_dataAberturaExibida" class="data-abertura-info"></div>
      </div>

      <div class="actions">
        <div class="top-menu-search-container" id="CotacaoIndividualScript_searchContainer_Top">
          <input type="text" id="CotacaoIndividualScript_searchInput_Top" placeholder="Buscar na cotação...">
        </div>

        <button id="CotacaoIndividualScript_btnRecalcularUI" class="btn-menu-superior"
          title="Forçar recálculo de totais na tela"
          style="background-color: transparent; border: 1px solid #93c5fd; margin-right: 0.5rem;">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
            style="width: 1.25rem; height: 1.25rem;">
            <path fill-rule="evenodd"
              d="M15.312 11.424a5.5 5.5 0 01-9.205 4.013l-.56-1.12a3.5 3.5 0 005.88-2.553H9.5V10h6V4h-1.5v5.576a5.525 5.525 0 01-1.688 1.848zM4.688 8.576a5.5 5.5 0 019.205-4.013l.56 1.12A3.5 3.5 0 008.57 8.233H10.5V10H4.5V4h1.5v3.576a5.525 5.525 0 011.688-1.848z"
              clip-rule="evenodd" />
          </svg>
        </button>

        <div class="dropdown-menu">
          <button id="CotacaoIndividualScript_menuEtapasBtn" class="btn-menu-superior dropdown-menu-button">Etapas <svg
              class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd"
                d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.29a.75.75 0 01.02-1.06z"
                clip-rule="evenodd" />
            </svg></button>
          <div id="CotacaoIndividualScript_menuEtapasDropdown" class="dropdown-menu-content">
            <a href="#" data-action="etapa_contagem_estoque">1. Contagem de Estoque</a>
            <a href="#" data-action="etapa_retirar_produtos">2. Retirar Produtos Desnecessários</a>
            <a href="#" data-action="etapa_enviar_fornecedores">3. Enviar para Fornecedores</a>
            <a href="#" data-action="etapa_realizar_cotacao">4. Realizar Cotação</a>
            <a href="#" data-action="etapa_definir_empresa">5. Definir Empresa para Faturamento</a>
            <a href="#" data-action="etapa_definir_condicoes_pagamento">6. Definir Condições de Pagamento</a>
            <a href="#" data-action="etapa_imprimir_pedidos">7. Imprimir Pedidos</a>
          </div>
        </div>
        <div class="dropdown-menu">
          <button id="CotacaoIndividualScript_menuRelatoriosBtn"
            class="btn-menu-superior dropdown-menu-button">Relatórios <svg class="dropdown-arrow"
              xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd"
                d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.29a.75.75 0 01.02-1.06z"
                clip-rule="evenodd" />
            </svg></button>
          <div id="CotacaoIndividualScript_menuRelatoriosDropdown" class="dropdown-menu-content">
            <a href="#" data-action="relatorio_analise_compra">Análise de Compra</a>
          </div>
        </div>
        <div class="dropdown-menu">
          <button id="CotacaoIndividualScript_menuFuncoesBtn" class="btn-menu-superior dropdown-menu-button">Funções
            <svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd"
                d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.29a.75.75 0 01.02-1.06z"
                clip-rule="evenodd" />
            </svg></button>
          <div id="CotacaoIndividualScript_menuFuncoesDropdown" class="dropdown-menu-content">
            <a href="#" data-action="funcao_acrescentar_itens">Acrescentar Itens</a>
            <a href="#" data-action="funcao_melhores_oportunidades">Melhores Oportunidades</a>
            <a href="#" data-action="funcao_preencher_precos">Preencher com Últimos Preços</a>
          </div>
        </div>
      </div>
    </div>

    <div class="main-content-area">
      <div class="view-tabs-container">
        <button id="CotacaoIndividualScript_btnAbaCategoria" class="view-tab-btn active">Visualizar por
          Categoria</button>
      </div>
      <div id="CotacaoIndividualScript_mensagemFeedback" class="feedback-message hidden"></div>
      <div class="table-container" id="CotacaoIndividualScript_tableContainer">
        <table class="sticky-header-table" id="CotacaoIndividualScript_tabelaProdutosCotacao">
          <thead>
            <tr>
              <th>Carregando Cabeçalhos...</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td id="CotacaoIndividualScript_tabelaLoadingMsg" colspan="1" class="text-center p-8 text-gray-500">
                <div class="flex justify-center items-center">
                  <svg class="custom-spinner" viewBox="0 0 50 50" style="width: 32px; height: 32px;">
                    <circle cx="25" cy="25" r="20" fill="none" stroke="#D1D5DB" stroke-width="5"></circle>
                    <circle cx="25" cy="25" r="20" fill="none" stroke="#1D4ED8" stroke-width="5" stroke-linecap="round"
                      stroke-dasharray="31.41592653589793, 125.66370614359172" stroke-dashoffset="0">
                      <animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s"
                        values="0 25 25;360 25 25" keyTimes="0;1"></animateTransform>
                    </circle>
                  </svg>
                  <span class="ml-3 text-gray-700">Carregando dados da cotação...</span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div id="CotacaoIndividualScript_pageLoadingOverlay" class="loading-overlay hidden">
      <div style="display: flex; flex-direction: column; align-items: center;">
        <div class="global-spinner"></div>
        <span class="mt-3 text-blue-700 font-semibold text-lg loading-message-text">Processando...</span>
      </div>
    </div>
  </div>

  <div id="CotacaoIndividualScript_modalAcrescentarItensOverlay" class="modal-overlay">
  </div>

  <div id="CotacaoIndividualScript_modalNegociacaoOverlay" class="modal-overlay">
    <div class="modal-content custom-scrollbar" role="dialog" aria-modal="true"
      aria-labelledby="CotacaoIndividualScript_modalNegociacao_titulo">
      <div class="modal-header">
        <h3 id="CotacaoIndividualScript_modalNegociacao_titulo" class="modal-title">Negociação</h3>
        <button id="CotacaoIndividualScript_btnFecharModalNegociacao" class="modal-close-btn"
          aria-label="Fechar">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="CotacaoIndividualScript_selectSubproduto">Subproduto base (normalmente o menor preço)</label>
          <select id="CotacaoIndividualScript_selectSubproduto"></select>
          <div id="CotacaoIndividualScript_infoSubproduto" style="margin-top:6px;color:#6b7280;font-size:0.85rem;">
          </div>
        </div>
        <div class="form-group" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div>
            <label for="CotacaoIndividualScript_inputPercentual">Desconto sobre o preço base (%)</label>
            <input id="CotacaoIndividualScript_inputPercentual" type="number" step="0.01" min="0" value="2">
          </div>
          <div>
            <label for="CotacaoIndividualScript_inputPrecoNovo">Novo preço (automático)</label>
            <input id="CotacaoIndividualScript_inputPrecoNovo" type="text" readonly>
          </div>
        </div>
        <div class="form-group">
          <label for="CotacaoIndividualScript_textareaMensagem">Mensagem para enviar aos fornecedores</label>
          <textarea id="CotacaoIndividualScript_textareaMensagem" rows="5"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button id="CotacaoIndividualScript_btnCancelarModalNegociacao"
          class="btn-painel-acao btn-modal-secondary">Cancelar</button>
        <button id="CotacaoIndividualScript_btnCopiarTextoNegociacao" class="btn-painel-acao btn-modal-primary">Copiar
          Texto</button>
      </div>
    </div>
  </div>

  <div id="FuncoesScript_sidebarOportunidades" class="sidebar-oportunidades">
  </div>

  <div id="EtapasScript_modalContagemEstoqueOverlay" class="modal-overlay">
    <div class="modal-content custom-scrollbar" style="max-width: 90vw; width: 1200px;">
      <div class="modal-header">
        <h3 class="modal-title">Etapa 1: Contagem de Estoque</h3>
        <button id="EtapasScript_btnFecharModalContagemEstoque" class="modal-close-btn"
          aria-label="Fechar">&times;</button>
      </div>
      <div id="EtapasScript_feedbackModalContagem" class="mb-4"></div>
      <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
        <table class="sticky-header-table" id="EtapasScript_tabelaContagemEstoque">
          <thead>
            <tr>
              <th>Produto Principal</th>
              <th>Estoque Mínimo</th>
              <th>Estoque Contado</th>
              <th>Comprar (Sugestão)</th>
            </tr>
          </thead>
          <tbody id="EtapasScript_tbodyModalContagemEstoque">
          </tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button id="EtapasScript_btnCancelarModalContagem" class="btn-painel-acao btn-modal-secondary">Cancelar</button>
        <button id="EtapasScript_btnSalvarModalContagem" class="btn-painel-acao btn-modal-primary">Salvar
          Contagem</button>
      </div>
    </div>
  </div>

  <div id="EtapasScript_modalRetirarProdutosOverlay" class="modal-overlay">
    <div class="modal-content custom-scrollbar" style="max-width: 800px;">
      <div class="modal-header">
        <h3 class="modal-title">Etapa 2: Retirar Produtos Desnecessários</h3>
        <button id="EtapasScript_btnFecharModalRetirarProdutos" class="modal-close-btn">&times;</button>
      </div>
      <div class="modal-body" id="EtapasScript_corpoModalRetirarProdutos">
      </div>
      <div id="EtapasScript_feedbackModalRetirarProdutos" class="m-4"></div>
      <div class="modal-footer">
        <button id="EtapasScript_btnCancelarModalRetirarProdutos"
          class="btn-painel-acao btn-modal-secondary">Cancelar</button>
        <button id="EtapasScript_btnConfirmarRemocaoModal" class="btn-painel-acao btn-modal-primary"
          style="background-color: #ef4444;">Confirmar Remoção</button>
      </div>
    </div>
  </div>

  <div id="EtapasScript_realizarCotacaoContainer" class="retirar-produtos-container hidden">
    <h3 class="text-xl font-semibold text-gray-800 mb-4">Etapa 4: Realizar Cotação</h3>
    <div id="EtapasScript_listaSubprodutosSemPreco" class="space-y-3">
    </div>
    <div class="mt-6 flex justify-end gap-3">
      <button id="EtapasScript_btnCancelarRetiradaSemPreco" class="btn-painel-acao btn-modal-secondary">Voltar para
        Edição</button>
      <button id="EtapasScript_btnConfirmarRetiradaSemPreco" class="btn-painel-acao btn-modal-primary">Retirar
        Selecionados e Iniciar Edição</button>
    </div>
  </div>

  <div id="EtapasScript_modalDefinirEmpresaOverlay" class="modal-overlay">
    <div class="modal-content custom-scrollbar" style="max-width: 95vw; width: 1400px;">
      <div class="modal-header">
        <h3 class="modal-title">Etapa 5: Definir Empresa para Faturamento</h3>
        <button id="EtapasScript_btnFecharModalDefinirEmpresa" class="modal-close-btn">&times;</button>
      </div>
      <div id="EtapasScript_feedbackModalDefinirEmpresa" class="m-4"></div>
      <div class="modal-body" id="EtapasScript_corpoModalDefinirEmpresa" style="max-height: 75vh; overflow-y: auto;">
      </div>
      <div class="modal-footer">
        <button id="EtapasScript_btnCancelarModalDefinirEmpresa"
          class="btn-painel-acao btn-modal-secondary">Cancelar</button>
        <button id="EtapasScript_btnSalvarFaturamento" class="btn-painel-acao btn-modal-primary">Salvar e
          Fechar</button>
      </div>
    </div>
  </div>

  <div id="EtapasScript_modalCondicoesPagamentoOverlay" class="modal-overlay">
    <div class="modal-content custom-scrollbar" style="max-width: 800px;">
      <div class="modal-header">
        <h3 class="modal-title">Etapa 6: Definir Condições de Pagamento</h3>
        <button id="EtapasScript_btnFecharModalCondicoes" class="modal-close-btn">&times;</button>
      </div>
      <div id="EtapasScript_feedbackModalCondicoes" class="m-4"></div>
      <div class="modal-body" id="EtapasScript_corpoModalCondicoes">
        <p>Carregando dados...</p>
      </div>
      <div class="modal-footer">
        <button id="EtapasScript_btnCancelarModalCondicoes"
          class="btn-painel-acao btn-modal-secondary">Cancelar</button>
        <button id="EtapasScript_btnSalvarModalCondicoes" class="btn-painel-acao btn-modal-primary">Salvar
          Condições</button>
      </div>
    </div>
  </div>

  <script>
    //####################################################################################################
    // MÓDULO: COTACAO INDIVIDUAL & ETAPAS (CLIENT-SIDE)
    // VERSÃO UNIFICADA E CORRIGIDA
    //####################################################################################################

    //----------------------------------------------------------------------------------------------------
    // DECLARAÇÕES GLOBAIS E CONSTANTES
    //----------------------------------------------------------------------------------------------------
    const CotacaoIndividualScript_ID_SEARCH_INPUT_TOP = 'CotacaoIndividualScript_searchInput_Top';
    const CotacaoIndividualScript_ID_COTACAO_EXIBIDO = 'CotacaoIndividualScript_idCotacaoExibido';
    const CotacaoIndividualScript_ID_DATA_ABERTURA_EXIBIDA = 'CotacaoIndividualScript_dataAberturaExibida';
    const CotacaoIndividualScript_ID_MENSAGEM_FEEDBACK = 'CotacaoIndividualScript_mensagemFeedback';
    const CotacaoIndividualScript_ID_TABELA_PRODUTOS_COTACAO = 'CotacaoIndividualScript_tabelaProdutosCotacao';
    const CotacaoIndividualScript_ID_PAGE_LOADING_OVERLAY = 'CotacaoIndividualScript_pageLoadingOverlay';

    let CotacaoIndividualScript_cotacaoIdAtual = null;
    let CotacaoIndividualScript_cabecalhosVisiveis = [];
    let CotacaoIndividualScript_dadosOriginaisCotacao = [];
    let CotacaoIndividualScript_modoEtapaAtual = null;

    const CotacaoIndividualScript_COLUNAS_A_EXIBIR_PADRAO = [
      "SubProduto", "Fornecedor", "Tamanho", "UN", "Fator",
      "Preço", "Preço por Fator", "Comprar", "Valor Total"
    ];

    const EtapasScript_COLUNAS_A_EXIBIR_FATURAMENTO = [
      "SubProduto", "Preço", "Comprar", "Valor Total", "Empresa Faturada"
    ];

    const CotacaoIndividualScript_MAPA_CORES_COLUNAS = {
      "SubProduto": "bg-col-amarelo", "Categoria": "bg-col-amarelo", "Fornecedor": "bg-col-amarelo",
      "Tamanho": "bg-col-laranja", "UN": "bg-col-laranja", "Fator": "bg-col-laranja",
      "Preço": "bg-col-azul-cot", "Preço por Fator": "bg-col-azul-cot",
      "Comprar": "bg-col-verde", "Valor Total": "bg-col-verde", "Economia em Cotação": "bg-col-verde",
      "Empresa Faturada": "bg-col-roxo-leve", "Condição de Pagamento": "bg-col-roxo-leve"
    };

    // Constantes legadas para compatibilidade com o script de Etapas
    const CotacaoIndividualScript_ID_TABELA_PRODUTOS_COTACAO_CONTAINER = 'CotacaoIndividualScript_tableContainer';
    const CotacaoIndividualScript_ID_RETIRAR_PRODUTOS_CONTAINER = 'EtapasScript_retirarProdutosContainer';
    const CotacaoIndividualScript_ID_GERENCIAR_COTACOES_PORTAL_CONTAINER = 'EtapasScript_gerenciarCotacoesPortalContainer';
    const CotacaoIndividualScript_ID_MODAL_CONTAGEM_OVERLAY = 'EtapasScript_modalContagemEstoqueOverlay';
    const CotacaoIndividualScript_ID_MODAL_DEFINIR_EMPRESA_OVERLAY = 'EtapasScript_modalDefinirEmpresaOverlay';

    //----------------------------------------------------------------------------------------------------
    // FUNÇÃO CENTRAL DE CHAMADA DA API
    //----------------------------------------------------------------------------------------------------

    async function CotacaoIndividualScript_callApi(endpoint, method = 'POST', body = null) {
      const apiBasePath = '/api/cotacaoindividual/';
      const fullUrl = apiBasePath + endpoint;
      try {
        const options = {
          method: method.toUpperCase(),
          headers: { 'Content-Type': 'application/json' },
        };
        if (body && method.toUpperCase() !== 'GET') {
          options.body = JSON.stringify(body);
        }
        const response = await fetch(fullUrl, options);
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ message: `Erro ${response.status}: ${response.statusText}` }));
          throw new Error(errorData.message || `Erro ${response.status}: A requisição falhou.`);
        }
        if (response.status === 204) {
          return { success: true };
        }
        return await response.json();
      } catch (error) {
        console.error(`Erro na chamada da API para [${fullUrl}]:`, error);
        return { success: false, message: error.message };
      }
    }

    //----------------------------------------------------------------------------------------------------
    // FUNÇÕES UTILITÁRIAS E DE UI
    //----------------------------------------------------------------------------------------------------

    function CotacaoIndividualScript_parseNumeroPtBr(valor) {
      if (valor === null || valor === undefined) return NaN;
      if (typeof valor === 'number') return Number(valor);
      const s = String(valor).trim();
      if (!s) return NaN;
      const normalizado = s.replace(/\s+/g, '').replace(/\.(?=\d{3}(?:,|$))/g, '').replace(',', '.');
      const n = Number(normalizado);
      return Number.isFinite(n) ? n : NaN;
    }

    function CotacaoIndividualScript_formatarPreco(n) {
      const v = Number(n || 0);
      return v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function CotacaoIndividualScript_mostrarLoadingOverlay(flag = true, msg = 'Processando...') {
      try {
        const overlay = document.getElementById(CotacaoIndividualScript_ID_PAGE_LOADING_OVERLAY);
        if (!overlay) return;
        overlay.classList.toggle('hidden', !flag);
        const txt = overlay.querySelector('.loading-message-text');
        if (txt && typeof msg === 'string') txt.textContent = msg;
      } catch (e) {
        console.error('CotacaoIndividualScript_mostrarLoadingOverlay erro:', e);
      }
    }
    window.CotacaoIndividualScript_mostrarLoadingOverlay = CotacaoIndividualScript_mostrarLoadingOverlay;

    function CotacaoIndividualScript_exibirFeedback(msg, isError = false, ms = 5000) {
      try {
        const div = document.getElementById(CotacaoIndividualScript_ID_MENSAGEM_FEEDBACK);
        if (!div) return;
        div.textContent = String(msg || '');
        div.className = `feedback-message ${isError ? 'feedback-error' : 'feedback-success'}`;
        div.classList.remove('hidden');
        if (ms > 0) {
          setTimeout(() => {
            if (div.textContent === String(msg || '')) {
              div.classList.add('hidden');
              div.textContent = '';
            }
          }, ms);
        }
      } catch (e) {
        console.error('CotacaoIndividualScript_exibirFeedback erro:', e);
      }
    }
    window.CotacaoIndividualScript_exibirFeedback = CotacaoIndividualScript_exibirFeedback;

    function CotacaoIndividualScript_parsearStringEstoqueComprar(txt) {
      const limparNumero = (s) => {
        if (s === null || s === undefined) return 0;
        const limpo = String(s).replace(/[^\d,.-]/g, '').replace(/\.(?=\d{3}(?:,|$))/g, '').replace(',', '.');
        const n = Number(limpo);
        return Number.isFinite(n) ? n : 0;
      };
      const str = String(txt || '');
      const reDuplo = /Estoque\s*Atual[^0-9\-]*([0-9\.,-]+).*?Comprar[^0-9\-]*([0-9\.,-]+)/i;
      const m = str.match(reDuplo);
      if (m) {
        return { estoqueAtual: limparNumero(m[1]), comprar: limparNumero(m[2]) };
      }
      const nums = (str.match(/[0-9\.,-]+/g) || []).map(limparNumero);
      return { estoqueAtual: nums[0] || 0, comprar: nums[1] || 0 };
    }
    window.CotacaoIndividualScript_parsearStringEstoqueComprar = CotacaoIndividualScript_parsearStringEstoqueComprar;

    function CotacaoIndividualScript_restaurarVisualizacaoPadrao(force = false) {
      try {
        const overlays = [
          CotacaoIndividualScript_ID_MODAL_CONTAGEM_OVERLAY,
          CotacaoIndividualScript_ID_MODAL_DEFINIR_EMPRESA_OVERLAY,
          'EtapasScript_modalRetirarProdutosOverlay'
        ];
        overlays.forEach(id => {
          const el = document.getElementById(id);
          if (el) el.classList.remove('active');
        });

        document.getElementById('CotacaoIndividualScript_tableContainer')?.classList.remove('hidden');
        document.getElementById(CotacaoIndividualScript_ID_RETIRAR_PRODUTOS_CONTAINER)?.classList.add('hidden');
        document.getElementById(CotacaoIndividualScript_ID_GERENCIAR_COTACOES_PORTAL_CONTAINER)?.classList.add('hidden');

        if (Array.isArray(window.CotacaoIndividualScript_dadosOriginaisCotacao)) {
          CotacaoIndividualScript_renderizarCabecalhoTabela();
          CotacaoIndividualScript_renderizarGruposDeProdutos(window.CotacaoIndividualScript_dadosOriginaisCotacao);
        }
        CotacaoIndividualScript_exibirFeedback('', false, 1);
      } catch (e) {
        console.error('CotacaoIndividualScript_restaurarVisualizacaoPadrao erro:', e);
      }
    }
    window.CotacaoIndividualScript_restaurarVisualizacaoPadrao = CotacaoIndividualScript_restaurarVisualizacaoPadrao;

    function CotacaoIndividualScript_vincularDropdowns() {
      document.querySelectorAll('.dropdown-menu-button').forEach(button => {
        button.addEventListener('click', function (event) {
          event.stopPropagation();
          const content = this.nextElementSibling;
          const isShown = content.classList.contains('show');
          document.querySelectorAll('.dropdown-menu-content.show').forEach(openContent => {
            if (openContent !== content) {
              openContent.classList.remove('show');
              openContent.previousElementSibling.classList.remove('open');
            }
          });
          content.classList.toggle('show', !isShown);
          this.classList.toggle('open', !isShown);
        });
      });
      window.addEventListener('click', function (event) {
        if (!event.target.matches('.dropdown-menu-button')) {
          document.querySelectorAll('.dropdown-menu-content.show').forEach(openContent => {
            openContent.classList.remove('show');
            openContent.previousElementSibling.classList.remove('open');
          });
        }
      });
    }

    function CotacaoIndividualScript_vincularListenerEtapas() {
      const menuEtapas = document.getElementById('CotacaoIndividualScript_menuEtapasDropdown');
      if (menuEtapas) {
        menuEtapas.addEventListener('click', function (event) {
          event.preventDefault();
          const target = event.target.closest('a');
          if (target && target.dataset.action) {
            const action = target.dataset.action;
            console.log(`Ação do menu Etapas acionada: ${action}`);

            // Esconde os dropdowns abertos
            document.querySelectorAll('.dropdown-menu-content.show').forEach(openContent => {
              openContent.classList.remove('show');
              openContent.previousElementSibling.classList.remove('open');
            });

            // Mapeia a ação para a função correspondente
            switch (action) {
              case 'etapa_contagem_estoque':
                // A função EtapasScript_abrirModalContagemEstoque() será criada a seguir
                EtapasScript_abrirModalContagemEstoque();
                break;
              case 'etapa_retirar_produtos':
                // A função EtapasScript_abrirModalRetirarProdutos() será criada a seguir
                EtapasScript_abrirModalRetirarProdutos();
                break;
              // Adicione outros cases para as demais etapas aqui no futuro...
              default:
                CotacaoIndividualScript_exibirFeedback(`Ação '${action}' não implementada.`, true);
                console.warn(`Ação do menu de etapas não reconhecida: ${action}`);
            }
          }
        });
      }
    }

    function EtapasScript_abrirModalContagemEstoque() {
      const modalOverlay = document.getElementById('EtapasScript_modalContagemEstoqueOverlay');
      const tbody = document.getElementById('EtapasScript_tbodyModalContagemEstoque');
      if (!modalOverlay || !tbody) {
        console.error('Elementos do modal de contagem de estoque não encontrados.');
        return;
      }

      tbody.innerHTML = ''; // Limpa a tabela
      const produtosUnicos = {};

      // Agrupa os dados por produto principal para a contagem
      (window.CotacaoIndividualScript_dadosOriginaisCotacao || []).forEach(grupo => {
        if (grupo.Produto && !produtosUnicos[grupo.Produto]) {
          produtosUnicos[grupo.Produto] = {
            nome: grupo.Produto,
            estoqueMinimo: CotacaoIndividualScript_parseNumeroPtBr(grupo.estoqueMinimoProdutoPrincipal) || 0,
            estoqueAtual: CotacaoIndividualScript_parseNumeroPtBr(grupo.estoqueAtualProdutoPrincipal) || 0,
            demandaMedia: CotacaoIndividualScript_parseNumeroPtBr(grupo.demandaMediaProdutoPrincipal) || 0,
          };
        }
      });


      Object.values(produtosUnicos).forEach(produto => {
        const sugestaoCompra = Math.max(0, produto.estoqueMinimo - produto.estoqueAtual);
        const tr = document.createElement('tr');
        tr.dataset.produtoNome = produto.nome;
        tr.innerHTML = `
                <td class="p-2 border-b">${produto.nome}</td>
                <td class="p-2 border-b"><input type="number" step="any" class="w-full p-1 border rounded" data-field="Estoque Minimo" value="${produto.estoqueMinimo}"></td>
                <td class="p-2 border-b"><input type="number" step="any" class="w-full p-1 border rounded" data-field="Estoque Atual" value="${produto.estoqueAtual}"></td>
                <td class="p-2 border-b"><input type="number" step="any" class="w-full p-1 border rounded" data-field="Comprar" value="${sugestaoCompra}"></td>
            `;
        tbody.appendChild(tr);
      });

      modalOverlay.classList.add('active');
    }

    function EtapasScript_fecharModal(modalId) {
      const modalOverlay = document.getElementById(modalId);
      if (modalOverlay) {
        modalOverlay.classList.remove('active');
      }
    }

    async function EtapasScript_salvarContagemEstoque() {
      const btnSalvar = document.getElementById('EtapasScript_btnSalvarModalContagem');
      CotacaoIndividualScript_mostrarLoadingOverlay(true, 'Salvando contagem...');

      const tbody = document.getElementById('EtapasScript_tbodyModalContagemEstoque');
      const dadosContagem = [];
      tbody.querySelectorAll('tr').forEach(tr => {
        const nomeProduto = tr.dataset.produtoNome;
        if (nomeProduto) {
          const estoqueMinimoInput = tr.querySelector('[data-field="Estoque Minimo"]');
          const estoqueAtualInput = tr.querySelector('[data-field="Estoque Atual"]');
          const comprarInput = tr.querySelector('[data-field="Comprar"]');

          dadosContagem.push({
            Produto: nomeProduto,
            'Estoque Mínimo': estoqueMinimoInput ? CotacaoIndividualScript_parseNumeroPtBr(estoqueMinimoInput.value) : 0,
            'Estoque Atual': estoqueAtualInput ? CotacaoIndividualScript_parseNumeroPtBr(estoqueAtualInput.value) : 0,
            'Comprar': comprarInput ? CotacaoIndividualScript_parseNumeroPtBr(comprarInput.value) : 0,
          });
        }
      });

      const response = await CotacaoIndividualScript_callApi('salvar-contagem', 'POST', {
        idCotacao: CotacaoIndividualScript_cotacaoIdAtual,
        dadosContagem: dadosContagem
      });

      CotacaoIndividualScript_mostrarLoadingOverlay(false);
      if (response.success) {
        EtapasScript_fecharModal('EtapasScript_modalContagemEstoqueOverlay');
        CotacaoIndividualScript_exibirFeedback('Contagem de estoque salva com sucesso! Recarregando dados...', false);
        await CotacaoIndividualScript_carregarDadosCotacao(CotacaoIndividualScript_cotacaoIdAtual); // Recarrega os dados
      } else {
        const feedbackModal = document.getElementById('EtapasScript_feedbackModalContagem');
        if (feedbackModal) {
          feedbackModal.innerHTML = `<div class="feedback-error">${response.message || 'Erro ao salvar.'}</div>`;
        }
      }
    }

    async function EtapasScript_confirmarRemocaoProdutos() {
      const modalOverlay = document.getElementById('EtapasScript_modalRetirarProdutosOverlay');
      const corpoModal = document.getElementById('EtapasScript_corpoModalRetirarProdutos');
      const produtosParaRemover = [];
      corpoModal.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
        produtosParaRemover.push(checkbox.value);
      });

      if (produtosParaRemover.length === 0) {
        const feedbackModal = document.getElementById('EtapasScript_feedbackModalRetirarProdutos');
        if (feedbackModal) {
          feedbackModal.innerHTML = `<div class="feedback-error">Nenhum produto selecionado para remoção.</div>`;
          setTimeout(() => { feedbackModal.innerHTML = '' }, 3000);
        }
        return;
      }

      CotacaoIndividualScript_mostrarLoadingOverlay(true, 'Removendo produtos...');

      const response = await CotacaoIndividualScript_callApi('retirar-produtos', 'POST', {
        idCotacao: CotacaoIndividualScript_cotacaoIdAtual,
        nomesProdutosPrincipaisParaExcluir: produtosParaRemover
      });

      CotacaoIndividualScript_mostrarLoadingOverlay(false);

      if (response.success) {
        EtapasScript_fecharModal('EtapasScript_modalRetirarProdutosOverlay');
        CotacaoIndividualScript_exibirFeedback('Produtos retirados com sucesso! Recarregando dados...', false);
        await CotacaoIndividualScript_carregarDadosCotacao(CotacaoIndividualScript_cotacaoIdAtual); // Recarrega os dados
      } else {
        const feedbackModal = document.getElementById('EtapasScript_feedbackModalRetirarProdutos');
        if (feedbackModal) {
          feedbackModal.innerHTML = `<div class="feedback-error">${response.message || 'Erro ao remover produtos.'}</div>`;
        }
      }
    }

    function CotacaoIndividualScript_vincularListenersDosModais() {
      // Modal de Negociação
      document.getElementById('CotacaoIndividualScript_btnFecharModalNegociacao')?.addEventListener('click', () => EtapasScript_fecharModal('CotacaoIndividualScript_modalNegociacaoOverlay'));
      document.getElementById('CotacaoIndividualScript_btnCancelarModalNegociacao')?.addEventListener('click', () => EtapasScript_fecharModal('CotacaoIndividualScript_modalNegociacaoOverlay'));
      document.getElementById('CotacaoIndividualScript_btnCopiarTextoNegociacao')?.addEventListener('click', () => {
        const textarea = document.getElementById('CotacaoIndividualScript_textareaMensagem');
        textarea.select();
        document.execCommand('copy');
        CotacaoIndividualScript_exibirFeedback('Texto copiado para a área de transferência!', false, 2000);
      });


      // Modal de Contagem de Estoque (Etapa 1)
      document.getElementById('EtapasScript_btnFecharModalContagemEstoque')?.addEventListener('click', () => EtapasScript_fecharModal('EtapasScript_modalContagemEstoqueOverlay'));
      document.getElementById('EtapasScript_btnCancelarModalContagem')?.addEventListener('click', () => EtapasScript_fecharModal('EtapasScript_modalContagemEstoqueOverlay'));
      document.getElementById('EtapasScript_btnSalvarModalContagem')?.addEventListener('click', EtapasScript_salvarContagemEstoque);

      // Modal de Retirar Produtos (Etapa 2)
      document.getElementById('EtapasScript_btnFecharModalRetirarProdutos')?.addEventListener('click', () => EtapasScript_fecharModal('EtapasScript_modalRetirarProdutosOverlay'));
      document.getElementById('EtapasScript_btnCancelarModalRetirarProdutos')?.addEventListener('click', () => EtapasScript_fecharModal('EtapasScript_modalRetirarProdutosOverlay'));
      document.getElementById('EtapasScript_btnConfirmarRemocaoModal')?.addEventListener('click', EtapasScript_confirmarRemocaoProdutos);

      // Adicione listeners para outros modais aqui...
    }

    function EtapasScript_abrirModalRetirarProdutos() {
      const modalOverlay = document.getElementById('EtapasScript_modalRetirarProdutosOverlay');
      const corpoModal = document.getElementById('EtapasScript_corpoModalRetirarProdutos');
      if (!modalOverlay || !corpoModal) {
        console.error('Elementos do modal de retirada de produtos não encontrados.');
        return;
      }

      corpoModal.innerHTML = '';
      const produtosParaRetirar = new Map();
      (window.CotacaoIndividualScript_dadosOriginaisCotacao || []).forEach(grupo => {
        const nomeProduto = grupo.Produto;
        const quantidadeComprar = (grupo.itens || []).reduce((total, item) => total + (CotacaoIndividualScript_parseNumeroPtBr(item.Comprar) || 0), 0);

        // Filtra apenas produtos com quantidade a comprar zero ou que não tenham itens com preço.
        if (quantidadeComprar === 0 || !(grupo.itens || []).some(item => CotacaoIndividualScript_parseNumeroPtBr(item.Preço) > 0)) {
          if (nomeProduto && !produtosParaRetirar.has(nomeProduto)) {
            produtosParaRetirar.set(nomeProduto, true);
          }
        }
      });

      if (produtosParaRetirar.size > 0) {
        const listaUl = document.createElement('ul');
        listaUl.className = 'space-y-2';
        produtosParaRetirar.forEach((_, nomeProduto) => {
          const li = document.createElement('li');
          li.className = 'flex items-center space-x-2';
          li.innerHTML = `
                    <input type="checkbox" id="retirar-${nomeProduto}" name="retirarProduto" value="${nomeProduto}" class="form-checkbox h-4 w-4 text-red-600">
                    <label for="retirar-${nomeProduto}" class="text-sm text-gray-700">${nomeProduto}</label>
                `;
          listaUl.appendChild(li);
        });
        corpoModal.appendChild(listaUl);
      } else {
        corpoModal.innerHTML = `<p class="text-sm text-gray-500">Nenhum produto sugerido para retirada (todos têm quantidade para comprar ou preço definido).</p>`;
      }

      modalOverlay.classList.add('active');
    }

    //----------------------------------------------------------------------------------------------------
    // LÓGICA DE DADOS E RENDERIZAÇÃO
    //----------------------------------------------------------------------------------------------------

    async function CotacaoIndividualScript_carregarDadosCotacao(idCotacao) {
      window.CotacaoIndividualScript_cotacaoIdAtual = idCotacao;
      const loadingCell = document.getElementById('CotacaoIndividualScript_tabelaLoadingMsg');
      if (loadingCell) loadingCell.parentElement.style.display = 'table-row';

      const resposta = await CotacaoIndividualScript_callApi('detalhes', 'POST', { idCotacao });

      if (loadingCell) loadingCell.parentElement.style.display = 'none';

      if (resposta && resposta.success) {
        window.CotacaoIndividualScript_dadosOriginaisCotacao = resposta.dados || [];
        window.CotacaoIndividualScript_cabecalhosVisiveis = resposta.cabecalhos || CotacaoIndividualScript_COLUNAS_A_EXIBIR_PADRAO;

        CotacaoIndividualScript_renderizarCabecalhoTabela();
        CotacaoIndividualScript_renderizarGruposDeProdutos(window.CotacaoIndividualScript_dadosOriginaisCotacao);

        const dataAberturaContainer = document.getElementById(CotacaoIndividualScript_ID_DATA_ABERTURA_EXIBIDA);
        if (dataAberturaContainer && resposta.dataAbertura) {
          const dataObj = new Date(resposta.dataAbertura);
          if (!isNaN(dataObj)) {
            dataAberturaContainer.textContent = `Data de Abertura: ${dataObj.toLocaleDateString('pt-BR')}`;
          }
        }
        CotacaoIndividualScript_exibirFeedback('', false, 1);
      } else {
        const msgErro = resposta.message || "Falha ao carregar dados da cotação.";
        CotacaoIndividualScript_exibirFeedback(msgErro, true, 0);
        const tbody = document.getElementById(CotacaoIndividualScript_ID_TABELA_PRODUTOS_COTACAO)?.querySelector('tbody');
        if (tbody) {
          const colspan = (window.CotacaoIndividualScript_cabecalhosVisiveis || []).length || 1;
          tbody.innerHTML = `<tr><td colspan="${colspan}" style="text-align: center; padding: 2rem; color: #991B1B;">${msgErro}</td></tr>`;
        }
      }
    }
    window.CotacaoIndividualScript_carregarDadosCotacao = CotacaoIndividualScript_carregarDadosCotacao;

    function CotacaoIndividualScript_renderizarCabecalhoTabela() {
      const tabela = document.getElementById(CotacaoIndividualScript_ID_TABELA_PRODUTOS_COTACAO);
      if (!tabela) return;
      const thead = tabela.querySelector('thead');
      thead.innerHTML = '';
      const tr = thead.insertRow();
      (window.CotacaoIndividualScript_cabecalhosVisiveis || []).forEach(textoCabecalho => {
        const th = document.createElement('th');
        th.textContent = textoCabecalho;
        tr.appendChild(th);
      });
    }

    function CotacaoIndividualScript_renderizarGruposDeProdutos(dadosAgrupados) {
      const tabela = document.getElementById(CotacaoIndividualScript_ID_TABELA_PRODUTOS_COTACAO);
      if (!tabela) return;
      const tbody = tabela.querySelector('tbody');
      tbody.innerHTML = '';

      if (!dadosAgrupados || dadosAgrupados.length === 0) {
        const tr = tbody.insertRow();
        const td = tr.insertCell();
        td.colSpan = window.CotacaoIndividualScript_cabecalhosVisiveis.length || 1;
        td.style.textAlign = 'center';
        td.style.padding = '2rem';
        td.textContent = 'Nenhum produto para esta cotação.';
        return;
      }

      const agrupadoPorCategoria = dadosAgrupados.reduce((acc, produto) => {
        const categoria = (produto.itens && produto.itens[0]?.Categoria) ? produto.itens[0].Categoria : 'Sem Categoria';
        if (!acc[categoria]) acc[categoria] = [];
        acc[categoria].push(produto);
        return acc;
      }, {});

      Object.keys(agrupadoPorCategoria).sort().forEach(nomeCategoria => {
        const categoriaRow = tbody.insertRow();
        categoriaRow.className = 'categoria-accordion-header-row expanded';
        const categoriaCell = categoriaRow.insertCell();
        categoriaCell.colSpan = window.CotacaoIndividualScript_cabecalhosVisiveis.length;
        categoriaCell.innerHTML = `<div class="categoria-header-content"><svg class="categoria-accordion-icon" style="transform: rotate(90deg);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg><span>${nomeCategoria}</span></div>`;

        const contentRows = [];
        agrupadoPorCategoria[nomeCategoria].forEach(grupoProduto => {
          const produtoRow = tbody.insertRow();
          contentRows.push(produtoRow);
          produtoRow.className = 'produto-group-separator-row';
          produtoRow.dataset.produtoNome = grupoProduto.Produto;
          const produtoCell = produtoRow.insertCell();
          produtoCell.colSpan = window.CotacaoIndividualScript_cabecalhosVisiveis.length;

          const wrap = document.createElement('div');
          wrap.className = 'contagem-container-principal';
          const info = document.createElement('div');
          info.className = 'produto-principal-info';
          info.textContent = grupoProduto.Produto;
          const actions = document.createElement('div');
          actions.className = 'contagem-fields-container';

          // =================================================================
          // CORREÇÃO APLICADA AQUI
          // Convertemos os valores para número ANTES de usar .toFixed()
          // =================================================================
          const estMinimoNum = CotacaoIndividualScript_parseNumeroPtBr(grupoProduto.estoqueMinimoProdutoPrincipal);
          const demandaMediaNum = CotacaoIndividualScript_parseNumeroPtBr(grupoProduto.demandaMediaProdutoPrincipal);

          const estMinimoDisplay = !isNaN(estMinimoNum) ? estMinimoNum.toFixed(2) : 'N/A';
          const demandaMediaDisplay = !isNaN(demandaMediaNum) ? demandaMediaNum.toFixed(2) : 'N/A';
          // =================================================================

          let totalComprar = (grupoProduto.itens || []).reduce((sum, item) => sum + (CotacaoIndividualScript_parseNumeroPtBr(item.Comprar) || 0), 0);
          const estoqueAtual = CotacaoIndividualScript_parseNumeroPtBr(grupoProduto.estoqueAtualProdutoPrincipal) || 0;
          const saldoEstoque = estoqueAtual - totalComprar;
          const metricas = CotacaoIndividualScript_calcularMetricasNegociacao(grupoProduto);

          actions.innerHTML = `
            <div class="contagem-field-block"><span class="campo-contagem-label">Est. Mínimo:</span><span class="campo-contagem-valor">${estMinimoDisplay}</span></div>
            <div class="contagem-field-block"><span class="campo-contagem-label">Demanda Média:</span><span class="campo-contagem-valor">${demandaMediaDisplay}</span></div>
            <div class="contagem-field-block"><span class="campo-contagem-label">Est. Atual / Comprar:</span><span class="campo-contagem-valor ${saldoEstoque < 0 ? 'negativo' : ''}" data-role="saldo-estoque">${estoqueAtual.toFixed(2)} / ${totalComprar.toFixed(2)}</span></div>
            <span class="info-badge indicador-oportunidade" data-role="metricas-negociacao">Oportunidade: ${CotacaoIndividualScript_formatarPreco(metricas.oportunidadeReais)} | Spread: ${metricas.spreadPercent.toFixed(2)}%</span>`;

          const btnNeg = document.createElement('button');
          btnNeg.className = 'info-badge clickable negociacao-btn';
          btnNeg.dataset.produtoNome = grupoProduto.Produto;
          btnNeg.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M12 3a9 9 0 100 18 9 9 0 000-18zm1 5h2v8h-2V8zm-4 0h2v8H9V8z"/></svg><span>Negociação</span>`;
          actions.appendChild(btnNeg);
          wrap.appendChild(info);
          wrap.appendChild(actions);
          produtoCell.appendChild(wrap);

          (grupoProduto.itens || []).forEach(item => {
            const subProdutoRow = tbody.insertRow();
            contentRows.push(subProdutoRow);
            subProdutoRow.className = 'sub-produto-row';
            subProdutoRow.dataset.produto = item.Produto;
            subProdutoRow.dataset.fornecedor = item.Fornecedor;
            subProdutoRow.dataset.subprodutoOriginalPersistido = item._subProdutoOriginalPersistido;

            window.CotacaoIndividualScript_cabecalhosVisiveis.forEach(cabecalho => {
              const td = subProdutoRow.insertCell();
              let valor = item[cabecalho];
              if (valor === undefined || valor === null) valor = '';

              if (['Preço', 'Preço por Fator', 'Valor Total'].includes(cabecalho)) {
                td.textContent = CotacaoIndividualScript_formatarPreco(valor);
              } else if (['Fator', 'Comprar'].includes(cabecalho)) {
                const num = CotacaoIndividualScript_parseNumeroPtBr(valor);
                td.textContent = !isNaN(num) ? num.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 4 }) : '';
              } else {
                td.textContent = valor;
              }

              td.dataset.coluna = cabecalho;
              td.dataset.valorOriginal = td.textContent;
              if (["SubProduto", "Tamanho", "UN", "Fator", "Preço", "Comprar"].includes(cabecalho)) {
                td.classList.add('editable-price-cell');
                td.addEventListener('click', CotacaoIndividualScript_transformarCelulaEmInput);
              }
              if (CotacaoIndividualScript_MAPA_CORES_COLUNAS[cabecalho]) {
                td.classList.add(CotacaoIndividualScript_MAPA_CORES_COLUNAS[cabecalho]);
              }
            });
          });
        });

        categoriaRow.addEventListener('click', () => {
          const isExpanded = categoriaRow.classList.toggle('expanded');
          const icon = categoriaRow.querySelector('.categoria-accordion-icon');
          if (icon) icon.style.transform = isExpanded ? 'rotate(90deg)' : 'rotate(0deg)';
          contentRows.forEach(row => row.classList.toggle('hidden-by-category', !isExpanded));
        });
      });

      document.querySelectorAll('.negociacao-btn').forEach(button => {
        button.addEventListener('click', (event) => {
          event.stopPropagation();
          CotacaoIndividualScript_abrirModalNegociacao(event.currentTarget.dataset.produtoNome);
        });
      });
    }

    function CotacaoIndividualScript_calcularMetricasNegociacao(grupo) {
      const resultado = { oportunidadeReais: 0, spreadPercent: 0 };
      if (!grupo || !grupo.itens || grupo.itens.length < 2) return resultado;

      const precosPorFatorValidos = grupo.itens
        .map(item => {
          const preco = CotacaoIndividualScript_parseNumeroPtBr(item["Preço"]);
          const fator = CotacaoIndividualScript_parseNumeroPtBr(item["Fator"]);
          return (fator > 0) ? (preco / fator) : null;
        })
        .filter(p => p !== null && p > 0).sort((a, b) => a - b);

      if (precosPorFatorValidos.length < 2) return resultado;

      const p1 = precosPorFatorValidos[0];
      const p2 = precosPorFatorValidos[1];
      const mid = Math.floor(precosPorFatorValidos.length / 2);
      const pMediana = precosPorFatorValidos.length % 2 === 0 ? (precosPorFatorValidos[mid - 1] + precosPorFatorValidos[mid]) / 2 : precosPorFatorValidos[mid];
      const quantidadeBase = CotacaoIndividualScript_parseNumeroPtBr(grupo.demandaMediaProdutoPrincipal);

      if (!isNaN(quantidadeBase) && quantidadeBase > 0 && pMediana > p1) {
        resultado.oportunidadeReais = (pMediana - p1) * quantidadeBase;
      }
      if (p1 > 0 && p2) {
        resultado.spreadPercent = ((p2 - p1) / p1) * 100;
      }
      return resultado;
    }

    //----------------------------------------------------------------------------------------------------
    // LÓGICA DE EDIÇÃO INLINE E MODAIS
    //----------------------------------------------------------------------------------------------------

    async function CotacaoIndividualScript_salvarEdicaoInline(element) {
      const td = element.parentElement;
      let novoValorStr = element.value;
      const valorOriginalStr = td.dataset.valorOriginal || '';
      const coluna = td.dataset.coluna;
      const camposNumericos = ["Fator", "Preço", "Comprar"];

      if (camposNumericos.includes(coluna)) novoValorStr = String(novoValorStr).replace(',', '.');

      // Re-formata o valor original para comparação precisa
      const valorOriginalComparacao = camposNumericos.includes(coluna) ? CotacaoIndividualScript_parseNumeroPtBr(valorOriginalStr) : valorOriginalStr;
      const novoValorComparacao = camposNumericos.includes(coluna) ? CotacaoIndividualScript_parseNumeroPtBr(novoValorStr) : novoValorStr;

      if (String(novoValorComparacao) === String(valorOriginalComparacao)) {
        td.textContent = valorOriginalStr;
        return;
      }

      let valorDisplay = novoValorStr;
      const num = CotacaoIndividualScript_parseNumeroPtBr(novoValorStr);
      if (camposNumericos.includes(coluna) && !isNaN(num)) {
        const fractionDigits = { 'Preço': 2, 'Comprar': 2, 'Fator': 4 };
        valorDisplay = num.toLocaleString('pt-BR', { minimumFractionDigits: fractionDigits[coluna] || 2, maximumFractionDigits: fractionDigits[coluna] || 4 });
      }

      td.textContent = valorDisplay;

      // O objeto `identificadoresLinha` precisa ser bem específico para o backend encontrar o item.
      const tr = td.closest('tr');
      const identificadoresLinha = {
        Produto: tr.dataset.produto,
        SubProdutoChave: tr.dataset.subprodutoOriginalPersistido, // Usa a chave de identificação original do subproduto
        Fornecedor: tr.dataset.fornecedor
      };

      const response = await CotacaoIndividualScript_callApi('salvar-celula', 'POST', {
        idCotacao: CotacaoIndividualScript_cotacaoIdAtual,
        identificadoresLinha: identificadoresLinha,
        colunaAlterada: coluna,
        novoValor: novoValorStr // Envia o valor raw/original
      });

      if (response && response.success) {
        td.dataset.valorOriginal = valorDisplay;
        if (response.novoSubProdutoNomeSeAlterado) {
          tr.dataset.subprodutoOriginalPersistido = response.novoSubProdutoNomeSeAlterado;
        }
        // Chama a função para atualizar os totais do grupo de produtos
        CotacaoIndividualScript_atualizarGrupoDeCalculosCliente(tr);
      } else {
        CotacaoIndividualScript_exibirFeedback(response.message || 'Falha ao salvar.', true);
        td.textContent = valorOriginalStr;
        // Reverte os cálculos se o salvamento falhou
        CotacaoIndividualScript_atualizarGrupoDeCalculosCliente(tr);
      }
    }

    function CotacaoIndividualScript_transformarCelulaEmInput(event) {
      const td = event.currentTarget;
      if (td.querySelector('input')) return;
      const valorOriginal = td.dataset.valorOriginal || '';
      const coluna = td.dataset.coluna;
      const tipoInput = ["Fator", "Preço", "Comprar"].includes(coluna) ? 'number' : 'text';

      // Corrige o valor no input para usar ponto como separador decimal, conforme o padrão HTML
      const valorInput = valorOriginal.replace(/\./g, '').replace(',', '.').replace('R$', '').trim();

      td.innerHTML = `<input type="${tipoInput}" step="any" class="inline-edit-input" value="${valorInput}" style="width: 95%; box-sizing: border-box; font-size: inherit; font-family: inherit; border: 1px solid #1D4ED8; border-radius: 3px;" />`;
      const input = td.querySelector('input');
      input.focus();
      input.select();

      const salvar = () => CotacaoIndividualScript_salvarEdicaoInline(input);
      input.addEventListener('blur', salvar);

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          input.removeEventListener('blur', salvar);
          input.parentElement.textContent = valorOriginal;
        } else if (e.key === 'Enter') {
          e.preventDefault();
          input.blur();
        }
      });
    }

    function CotacaoIndividualScript_atualizarGrupoDeCalculosCliente(trEditadaOuHeader) {
      const nomeProdutoPrincipal = trEditadaOuHeader.classList.contains('produto-group-separator-row') ? trEditadaOuHeader.dataset.produtoNome : trEditadaOuHeader.dataset.produto;
      if (!nomeProdutoPrincipal) return;

      const tbody = trEditadaOuHeader.closest('tbody');
      const todasLinhasDoGrupo = tbody.querySelectorAll(`tr.sub-produto-row[data-produto="${nomeProdutoPrincipal}"]`);
      const headerRow = tbody.querySelector(`tr.produto-group-separator-row[data-produto-nome="${nomeProdutoPrincipal}"]`);
      if (!headerRow) return;

      const lerValorDaLinha = (tr, coluna) => {
        const cell = tr.querySelector(`td[data-coluna="${coluna}"]`);
        // Se o elemento for um input (em edição), pega o valor do input, senão, pega o valor do texto da célula.
        const value = cell.querySelector('input')?.value || cell.textContent;
        return CotacaoIndividualScript_parseNumeroPtBr(value || '0');
      };

      const escreverValorNaLinha = (tr, coluna, valor, formatador) => {
        const cell = tr.querySelector(`td[data-coluna="${coluna}"]`);
        if (cell) {
          const valorFormatado = formatador(valor);
          cell.textContent = valorFormatado;
          cell.dataset.valorOriginal = valorFormatado;
        }
      };

      let totalComprar = 0;
      todasLinhasDoGrupo.forEach(tr => {
        const preco = lerValorDaLinha(tr, "Preço");
        const fator = lerValorDaLinha(tr, "Fator");
        const comprar = lerValorDaLinha(tr, "Comprar");
        totalComprar += comprar;
        escreverValorNaLinha(tr, "Preço por Fator", fator > 0 ? (preco / fator) : 0, v => v.toLocaleString('pt-BR', { minimumFractionDigits: 4, maximumFractionDigits: 4 }));
        escreverValorNaLinha(tr, "Valor Total", preco * comprar, CotacaoIndividualScript_formatarPreco);
      });

      const grupoOriginal = (window.CotacaoIndividualScript_dadosOriginaisCotacao || []).find(g => g.Produto === nomeProdutoPrincipal);
      if (grupoOriginal) {
        const estoqueAtual = CotacaoIndividualScript_parseNumeroPtBr(grupoOriginal.estoqueAtualProdutoPrincipal) || 0;
        const saldoEstoque = estoqueAtual - totalComprar;
        const saldoSpan = headerRow.querySelector('[data-role="saldo-estoque"]');
        if (saldoSpan) {
          saldoSpan.textContent = `${estoqueAtual.toFixed(2)} / ${totalComprar.toFixed(2)}`;
          saldoSpan.classList.toggle('negativo', saldoEstoque < 0);
        }
        const metricas = CotacaoIndividualScript_calcularMetricasNegociacao(grupoOriginal);
        const metricasSpan = headerRow.querySelector('[data-role="metricas-negociacao"]');
        if (metricasSpan) {
          metricasSpan.innerHTML = `Oportunidade: ${CotacaoIndividualScript_formatarPreco(metricas.oportunidadeReais)} | Spread: ${metricas.spreadPercent.toFixed(2)}%`;
        }
      }
    }

    function CotacaoIndividualScript_abrirModalNegociacao(produto) {
      const subprodutos = (window.CotacaoIndividualScript_dadosOriginaisCotacao || [])
        .find(g => g.Produto === produto)?.itens
        .map(item => ({
          fornecedor: item.Fornecedor,
          subproduto: item.SubProduto || item.Subproduto,
          preco: CotacaoIndividualScript_parseNumeroPtBr(item.Preço)
        }))
        .sort((a, b) => (a.preco || Infinity) - (b.preco || Infinity)) || [];

      const modal = document.getElementById('CotacaoIndividualScript_modalNegociacaoOverlay');
      const tituloModal = document.getElementById('CotacaoIndividualScript_modalNegociacao_titulo');
      const select = document.getElementById('CotacaoIndividualScript_selectSubproduto');
      const inpPerc = document.getElementById('CotacaoIndividualScript_inputPercentual');
      const inpNovo = document.getElementById('CotacaoIndividualScript_inputPrecoNovo');
      const txt = document.getElementById('CotacaoIndividualScript_textareaMensagem');

      tituloModal.textContent = `Negociação: ${produto}`;
      select.innerHTML = '';
      subprodutos.forEach((sp, idx) => {
        const opt = document.createElement('option');
        opt.value = String(idx);
        opt.textContent = `${sp.subproduto} — ${sp.fornecedor} — ${CotacaoIndividualScript_formatarPreco(sp.preco)}`;
        select.appendChild(opt);
      });

      const atualizar = () => {
        const sp = subprodutos[Number(select.value)];
        if (!sp) return;
        document.getElementById('CotacaoIndividualScript_infoSubproduto').textContent = `Base: ${sp.subproduto} — ${sp.fornecedor} — ${CotacaoIndividualScript_formatarPreco(sp.preco)}`;
        const novo = (Number(sp.preco) || 0) * (1 - (Number(inpPerc.value) || 0) / 100);
        inpNovo.value = CotacaoIndividualScript_formatarPreco(novo);
        txt.value = `Olá, tudo bem?\n\nEstou cotando o produto: ${produto}.\n\nConsegui um preço melhor de ${CotacaoIndividualScript_formatarPreco(novo)}. Você consegue cobrir essa oferta?\n\nFico no aguardo, obrigado!`;
      };

      select.onchange = atualizar;
      inpPerc.oninput = atualizar;
      atualizar();
      modal.classList.add('active');
    }

    //----------------------------------------------------------------------------------------------------
    // INICIALIZAÇÃO E EVENT LISTENERS
    //----------------------------------------------------------------------------------------------------

    async function CotacaoIndividualScript_inicializarPagina() {
      console.log("CotacaoIndividualScript: Inicializando...");
      CotacaoIndividualScript_vincularDropdowns();
      CotacaoIndividualScript_vincularListenerEtapas();
      CotacaoIndividualScript_vincularListenersDosModais(); // <<<--- ADICIONE ESTA NOVA LINHA

      const params = new URLSearchParams(window.location.search);
      const idCotacao = params.get('idCotacao');
      const spanIdCotacao = document.getElementById(CotacaoIndividualScript_ID_COTACAO_EXIBIDO);

      if (idCotacao) {
        if (spanIdCotacao) spanIdCotacao.textContent = idCotacao;
        document.title = `Cotação: ${idCotacao}`;
        await CotacaoIndividualScript_carregarDadosCotacao(idCotacao);
      } else {
        if (spanIdCotacao) spanIdCotacao.textContent = "Inválida";
        document.title = "Cotação Inválida";
        CotacaoIndividualScript_exibirFeedback("ID da Cotação não fornecido na URL.", true, 0);
        document.getElementById('CotacaoIndividualScript_tabelaLoadingMsg')?.closest('tbody').remove();
      }
    }

    // Inicialização da página
    document.addEventListener('DOMContentLoaded', CotacaoIndividualScript_inicializarPagina);

  </script>

</body>

</html>